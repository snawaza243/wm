CREATE OR REPLACE PROCEDURE WEALTHMAKER.PSM_AO_GET_CLIENTLIST(
    P_BRANCH_ID     IN VARCHAR2,
    P_MOBILE        IN VARCHAR2,
    P_CITY_ID       IN VARCHAR2,
    P_PHONE         IN VARCHAR2,
    P_CLIENT_CODE   IN VARCHAR2,
    P_BUSINESS_CD   IN VARCHAR2,
    P_CLIENT_NAME   IN VARCHAR2,
    P_CLIENT_LIST   OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN P_CLIENT_LIST FOR
    SELECT 
        CLIENT_TEST.CLIENT_CODE AS CLIENT_CODE,  -- Added CLIENT_TEST alias
        CLIENT_TEST.CLIENT_NAME AS CLIENT_NAME,  -- Added CLIENT_TEST alias
        COALESCE(EMPLOYEE_MASTER.RM_NAME, '') AS BUSINESS_CODE,
        CLIENT_TEST.ADD1 AS ADD1
    FROM 
        CLIENT_TEST
    LEFT JOIN EMPLOYEE_MASTER ON EMPLOYEE_MASTER.PAYROLL_ID = CLIENT_TEST.BUSINESS_CODE
    left join client_master cm on cm.client_code = CLIENT_TEST.source_code
    WHERE 
    
        (P_BRANCH_ID IS NULL OR UPPER(CLIENT_TEST.BRANCH_CODE) = UPPER(P_BRANCH_ID))  -- Added CLIENT_TEST alias
        AND (P_MOBILE IS NULL OR UPPER(CLIENT_TEST.MOBILE_NO) = UPPER(P_MOBILE))  -- Added CLIENT_TEST alias
        AND (P_CITY_ID IS NULL OR UPPER(CLIENT_TEST.CITY_ID) = UPPER(P_CITY_ID))  -- Added CLIENT_TEST alias
        AND (P_PHONE IS NULL OR UPPER(CLIENT_TEST.TEL2) = UPPER(P_PHONE))  -- Added CLIENT_TEST alias
        AND (P_CLIENT_CODE IS NULL OR UPPER(CLIENT_TEST.CLIENT_CODE) = UPPER(P_CLIENT_CODE))  -- Added CLIENT_TEST alias
        AND (P_BUSINESS_CD IS NULL OR UPPER(CLIENT_TEST.CLIENT_PAN) = UPPER(P_BUSINESS_CD))  -- Added CLIENT_TEST alias
        AND (P_CLIENT_NAME IS NULL OR UPPER(CLIENT_TEST.CLIENT_NAME) LIKE '' || UPPER(P_CLIENT_NAME) || '%')  -- Added CLIENT_TEST alias
        AND UPPER(CLIENT_TEST.CLIENT_CODE) = UPPER(CLIENT_TEST.MAIN_CODE)  -- Added CLIENT_TEST alias
        AND client_test.source_code IN cm.client_code
        AND ROWNUM < 200
    ORDER BY UPPER(CLIENT_TEST.CLIENT_NAME);  -- Added CLIENT_TEST alias
END;
/
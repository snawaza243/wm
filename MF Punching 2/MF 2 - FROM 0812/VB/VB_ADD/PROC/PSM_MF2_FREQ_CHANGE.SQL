CREATE OR REPLACE PROCEDURE PSM_MF2_FREQ_CHANGE(
    PX_LOG_ID           IN VARCHAR2,
    PX_ROLE_ID          IN VARCHAR2,
    PX_INDEX            IN VARCHAR2,
    PX_SIP_START_DT     IN VARCHAR2,
    PX_SIP_END_DT       IN VARCHAR2,
    PX_OPT99            IN CHAR,
    PX_FREQUENCY        IN VARCHAR2,
    PX_INSTALLMENTS     IN VARCHAR2,
    PX_CURSOR           OUT SYS_REFCURSOR
) AS 
    V_MAX_INS_NUM       NUMBER := 0;
    V_SIP_START_DT      VARCHAR2(10) := NULL;
    V_SIP_END_DT        VARCHAR2(10) := NULL;
BEGIN
    V_SIP_START_DT := PX_SIP_START_DT;

    -- Max Installments
    IF V_SIP_START_DT IS NOT NULL THEN
        SELECT ROUND(MONTHS_BETWEEN(TO_DATE('01/12/2099','DD/MM/RRRR'), TO_DATE(V_SIP_START_DT,'DD/MM/RRRR')))
        INTO V_MAX_INS_NUM
        FROM DUAL;
    END IF;

    -- If Opt99 is ON
    IF PX_OPT99 = '1' AND V_SIP_START_DT IS NOT NULL THEN
        V_SIP_END_DT := '01/12/2099';

    ELSIF PX_FREQUENCY IS NOT NULL AND PX_OPT99 = '0' THEN

        IF PX_FREQUENCY = '208' THEN
            IF (PX_INSTALLMENTS IS NOT NULL OR PX_OPT99 = '1') AND V_SIP_START_DT IS NOT NULL THEN
                SELECT TO_CHAR(ADD_MONTHS(TO_DATE(V_SIP_START_DT,'DD/MM/RRRR'), TO_NUMBER(PX_INSTALLMENTS)) - 1, 'DD/MM/RRRR')
                INTO V_SIP_END_DT FROM DUAL;
            END IF;

        ELSIF PX_FREQUENCY = '173' THEN
            IF (PX_INSTALLMENTS IS NOT NULL OR PX_OPT99 = '1') AND V_SIP_START_DT IS NOT NULL THEN
                SELECT TO_CHAR(WEALTHMAKER.ADD_WEEKS(TO_DATE(V_SIP_START_DT,'DD/MM/RRRR'), TO_NUMBER(PX_INSTALLMENTS)), 'DD/MM/RRRR')
                INTO V_SIP_END_DT FROM DUAL;
            END IF;

        ELSIF PX_FREQUENCY = '174' THEN
            IF (PX_INSTALLMENTS IS NOT NULL OR PX_OPT99 = '1') AND V_SIP_START_DT IS NOT NULL THEN
                SELECT TO_CHAR(ADD_MONTHS(TO_DATE(V_SIP_START_DT,'DD/MM/RRRR'), 6 * TO_NUMBER(PX_INSTALLMENTS)) - 1, 'DD/MM/RRRR')
                INTO V_SIP_END_DT FROM DUAL;
            END IF;

        ELSIF PX_FREQUENCY = '175' THEN
            IF (PX_INSTALLMENTS IS NOT NULL OR PX_OPT99 = '1') AND V_SIP_START_DT IS NOT NULL THEN
                IF TO_NUMBER(PX_INSTALLMENTS) < V_MAX_INS_NUM THEN
                    SELECT TO_CHAR(ADD_MONTHS(TO_DATE(V_SIP_START_DT,'DD/MM/RRRR'), TO_NUMBER(PX_INSTALLMENTS)) - 1, 'DD/MM/RRRR')
                    INTO V_SIP_END_DT FROM DUAL;
                ELSE
                    V_SIP_END_DT := '01/12/2099';
                END IF;
            END IF;

        ELSIF PX_FREQUENCY = '176' THEN
            IF (PX_INSTALLMENTS IS NOT NULL OR PX_OPT99 = '1') AND V_SIP_START_DT IS NOT NULL THEN
                SELECT TO_CHAR(ADD_MONTHS(TO_DATE(V_SIP_START_DT,'DD/MM/RRRR'), 3 * TO_NUMBER(PX_INSTALLMENTS)) - 1, 'DD/MM/RRRR')
                INTO V_SIP_END_DT FROM DUAL;
            END IF;

        ELSIF PX_FREQUENCY = '301' THEN
            IF (PX_INSTALLMENTS IS NOT NULL OR PX_OPT99 = '1') AND V_SIP_START_DT IS NOT NULL THEN
                SELECT TO_CHAR(ADD_MONTHS(TO_DATE(V_SIP_START_DT,'DD/MM/RRRR'), 12 * TO_NUMBER(PX_INSTALLMENTS)) - 1, 'DD/MM/RRRR')
                INTO V_SIP_END_DT FROM DUAL;
            END IF;
        END IF;
    END IF;


    OPEN PX_CURSOR FOR
        SELECT 
            'SUCCESS' AS MSG,
            V_SIP_END_DT AS SIP_END_DATE,
            V_MAX_INS_NUM AS MAX_INSTALLMENTS
        FROM DUAL;

END;
/

CREATE OR REPLACE PROCEDURE PSM_ASS_M_INSERT_AGENT_MASTER(
    P_LOGGEDINUSER IN VARCHAR2,
    P_EMPANELMENTTYPE IN VARCHAR2,
    P_AGENTNAME IN VARCHAR2,
    P_SOURCEID IN VARCHAR2,
    P_RMCODE IN VARCHAR2,
    P_ADDRESS1 IN VARCHAR2,
    P_ADDRESS2 IN VARCHAR2,
    P_CITYID IN VARCHAR2,
    P_LOCATIONID IN VARCHAR2,
    P_MOBILE IN NUMBER,
    P_PIN IN NUMBER,
    P_FAX IN VARCHAR2,
    P_CONTACTPER IN VARCHAR2,
    P_EMAIL IN VARCHAR2,
    P_TDS IN NUMBER,
    P_ASSOCIATETYPE IN VARCHAR2,
    P_ASSOCIATETYPECATEGORY IN VARCHAR2,
    P_CONTACTPERSONEMAILID IN VARCHAR2,
    P_EMPANELMENTDATE IN DATE,
    P_PHONE IN VARCHAR2,
    P_REMARKS IN VARCHAR2,
    P_SUPERANA IN VARCHAR2,
    P_ONLINESUBSCRIPTIONCHECK IN VARCHAR2,
    P_OFFLINEPLATFORMBLOCK IN VARCHAR2,
    P_ONLINEPLATFORMBLOCK IN VARCHAR2,
    P_ONLINEPLATFORMBLOCKREMARK IN VARCHAR2,
    P_OFFLINEPLATFORMBLOCKREMARK IN VARCHAR2,
    P_AUDITDATE IN DATE,
    P_AUDITCHECK IN VARCHAR2,
    P_PAYMENTMODEID IN NUMBER,
    P_ACCOUNTTYPEID IN VARCHAR2,
    P_ACCNO IN VARCHAR2,
    P_AFFECTEDFROM IN VARCHAR2,
    P_BANKID IN VARCHAR2,
    P_BANKCITYID IN VARCHAR2,
    P_BRANKBRANCHID IN VARCHAR2,
    P_SMSFLAG IN VARCHAR2,
    P_GSTINNO IN VARCHAR2,
    P_DOB IN DATE,
    P_AGENTTYPE IN VARCHAR2,
    P_PAN IN VARCHAR2,
    P_DIST IN VARCHAR2,
    P_AADHARCARDNO IN VARCHAR2,
    P_POSPMARKING IN VARCHAR2,
    P_POSPTYPE IN VARCHAR2,
    P_POSPNOLI IN VARCHAR2,
    P_POSPNOGI IN VARCHAR2,
    P_POSPCERTIFIEDONLI IN DATE,
    P_POSPVALIDTILLLI IN DATE,
    P_POSPCERTIFIEDONGI IN DATE,
    P_POSPVALIDTILLGI IN DATE,
    P_VERIFIEDSTATUS IN VARCHAR2,
    P_NEFTBANKNAME IN VARCHAR2,
    P_NEFTBRANCH IN VARCHAR2,
    P_NEFTIFSCCODE IN VARCHAR2,
    P_NEFTNAME IN VARCHAR2,
    P_CERTPASSED IN VARCHAR2,
    P_CERTEXAMS IN VARCHAR2,
    P_CERTREGNO IN VARCHAR2,
    P_RES_ADD_1 IN VARCHAR2,
    P_RES_ADD_2 IN VARCHAR2,
    P_RES_ADD_STATE IN VARCHAR2,
    P_RES_ADD_CITY IN VARCHAR2,
    P_RES_ADD_PINCODE IN VARCHAR2,
    P_DT_NUMBER IN VARCHAR2,
    P_RESULT OUT SYS_REFCURSOR
) AS
    AGENT_FLAG NUMBER := 0;
    PAN_FLAG NUMBER := 0;
    DT_FLAG NUMBER := 0;
    NEW_AGENT_CODE VARCHAR2(2000);
BEGIN
    -- Validate DT NUMBER FLAG VALUE
    SELECT check_dt_newinv(P_DT_NUMBER) INTO DT_FLAG FROM dual;

    -- Validate DT number is not null and valid
    IF TRIM(P_DT_NUMBER) IS NULL THEN
        OPEN P_RESULT FOR
            SELECT 'Please enter DT number for new account' AS message FROM DUAL;
        RETURN;
    END IF;

    IF DT_FLAG <= 0 THEN
        OPEN P_RESULT FOR
            SELECT 'Please Enter Valid DT Number' AS message FROM DUAL;
        RETURN;
    END IF;

    -- Check for existing agent in CLIENT_MASTER based on conditions
    SELECT NVL(COUNT(*), 0)
    INTO AGENT_FLAG
    FROM AGENT_MASTER
    WHERE AGENT_NAME = P_AGENTNAME
        AND PAN = P_PAN
        AND MOBILE = P_MOBILE
        AND EMAIL = P_EMAIL
        AND ROWNUM = 1;

    -- PAN validation check
    IF TRIM(P_PAN) IS NOT NULL THEN
        SELECT COUNT(*) INTO PAN_FLAG FROM AGENT_MASTER WHERE PAN = P_PAN;
        IF PAN_FLAG >= 1 THEN
            OPEN P_RESULT FOR
                SELECT 'Duplicate Pan No' AS message FROM DUAL;
            RETURN;
        END IF;
    ELSE
        OPEN P_RESULT FOR
            SELECT 'Please enter Pan No for new account' AS message FROM DUAL;
        RETURN;
    END IF;

    -- Insert the new agent into AGENT_MASTER
    INSERT INTO AGENT_MASTER (
        AGENT_CODE,
        EXIST_CODE,
        PAIDFLAG,
        AGENT_NAME,
        SOURCEID,
        RM_CODE,
        ADDRESS1,
        ADDRESS2,
        CITY_ID,
        LOCATION_ID,
        MOBILE,
        PINCODE,
        FAX,
        CONTACTPER,
        EMAIL,
        TDS,
        SUB_BROKER_TYPE,
        CATEGORY_ID,
        CPEMAILID,
        TIMEST,
        loggeduserid,
        PHONE,
        REMARK,
        MASTER_ANA,
        ONLINE_SUBSCIPTION,
        BLOCK_AGENT,
        ONLINE_BLOCK_AGENT,
        online_block_remark,
        offline_block_remark,
        ANA_AUDITDATE,
        ANA_AUDIT,
        PAYMENTMODEID,
        ACCTYPEID,
        ACCNO,
        AFFECTEDFROM,
        BANKID,
        CITY_NAME,
        BANK_BRANCHID,
        SMS_FLAG,
        GSTIN_NO,
        DOB,
        AGENT_TYPE,
        PAN,
        DIST,
        AADHAR_CARD_NO,
        POSP_MARKING,
        POSP_TYPE,
        POSP_NO_LI,
        POSP_NO_GI,
        POSP_CERTIFIED_ON_LI,
        POSP_VALID_TILL_LI,
        POSP_CERTIFIED_ON_GI,
        POSP_VALID_TILL_GI,
        VERIFIED_STATUS,
        NEFT_BANK_NAME,
        BANK_BRANCH_NAME,
        IFSC_CODE,
        NAME_IN_BANK,
        AMFICERT,
        AMFIEXTYPEID,
        AMFIID,
        R_ADDRESS1,
        R_ADDRESS2,
        R_STATE_NAME,
        R_CITY_NAME,
        R_PINCODE
    ) VALUES (
        NULL, -- Agent code should be auto-generated
        NULL, -- Exist code should be auto-generated
        P_EMPANELMENTTYPE,
        P_AGENTNAME,
        P_SOURCEID,
        P_RMCODE,
        P_ADDRESS1,
        P_ADDRESS2,
        P_CITYID,
        P_LOCATIONID,
        P_MOBILE,
        P_PIN,
        P_FAX,
        P_CONTACTPER,
        P_EMAIL,
        P_TDS,
        P_ASSOCIATETYPE,
        P_ASSOCIATETYPECATEGORY,
        P_CONTACTPERSONEMAILID,
        SYSDATE,
        P_LOGGEDINUSER,
        P_PHONE,
        P_REMARKS,
        P_SUPERANA,
        P_ONLINESUBSCRIPTIONCHECK,
        P_OFFLINEPLATFORMBLOCK,
        P_ONLINEPLATFORMBLOCK,
        P_ONLINEPLATFORMBLOCKREMARK,
        P_OFFLINEPLATFORMBLOCKREMARK,
        P_AUDITDATE,
        P_AUDITCHECK,
        P_PAYMENTMODEID,
        P_ACCOUNTTYPEID,
        P_ACCNO,
        P_AFFECTEDFROM,
        P_BANKID,
        P_BANKCITYID,
        P_BRANKBRANCHID,
        P_SMSFLAG,
        P_GSTINNO,
        P_DOB,
        P_AGENTTYPE,
        P_PAN,
        P_DIST,
        P_AADHARCARDNO,
        P_POSPMARKING,
        P_POSPTYPE,
        P_POSPNOLI,
        P_POSPNOGI,
        P_POSPCERTIFIEDONLI,
        P_POSPVALIDTILLLI,
        P_POSPCERTIFIEDONGI,
        P_POSPVALIDTILLGI,
        P_VERIFIEDSTATUS,
        P_NEFTBANKNAME,
        P_NEFTBRANCH,
        P_NEFTIFSCCODE,
        P_NEFTNAME,
        P_CERTPASSED,
        P_CERTEXAMS,
        P_CERTREGNO,
        P_RES_ADD_1,
        P_RES_ADD_2,
        P_RES_ADD_STATE,
        P_RES_ADD_CITY,
        P_RES_ADD_PINCODE
    );

    -- Retrieve the new agent code
    SELECT 'Agent successfully inserted with AGENT_CODE: ' || AGENT_CODE || ' and EXIST_CODE: ' || EXIST_CODE
    INTO NEW_AGENT_CODE
    FROM AGENT_MASTER
    WHERE AGENT_NAME = P_AGENTNAME
        AND PAN = P_PAN
        AND MOBILE = P_MOBILE
        AND EMAIL = P_EMAIL;

    -- Return success message
    OPEN P_RESULT FOR
        SELECT NEW_AGENT_CODE AS MESSAGE FROM DUAL;

    RETURN;
END PSM_ASS_M_INSERT_AGENT_MASTER;

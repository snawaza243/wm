CREATE OR REPLACE PROCEDURE WEALTHMAKER.PSM_MC_AUDIT_TR2 (
    P_AR_NO   IN  VARCHAR2,
    P_CURSOR  OUT SYS_REFCURSOR
)
AS
    V_ERROR_MSG VARCHAR2(4000);
BEGIN

    SAVEPOINT START_TRANSACTION;
    
    IF P_AR_NO IS NOT NULL THEN
        UPDATE TRANSACTION_MF_TEMP1
        SET AUDIT_FLAG = 'Y'
        WHERE TRAN_CODE = P_AR_NO;
    ELSE
        OPEN P_CURSOR FOR
        SELECT 'ERROR: AR number is not available' AS MESSAGE FROM DUAL;
        RETURN;
    END IF;

    COMMIT;

    OPEN P_CURSOR FOR
    SELECT 'SUCCESS: AR Audit Successfully Done' AS MESSAGE
    FROM DUAL;

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK TO START_TRANSACTION;
        V_ERROR_MSG := SQLERRM;
        OPEN P_CURSOR FOR
        SELECT 'ERROR: ' || V_ERROR_MSG AS MESSAGE FROM DUAL;
END;

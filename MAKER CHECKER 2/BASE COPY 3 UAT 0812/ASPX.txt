<%@ Page Title="" Language="C#" MasterPageFile="~/vmSite.Master" AutoEventWireup="true"
    CodeBehind="MakerChecker.aspx.cs" Inherits="WM.Masters.MakerChecker" MaintainScrollPositionOnPostback="true" %>

<asp:Content ID="Content1" ContentPlaceHolderID="ContentPlaceHolder1" runat="server">





    <style>
 

        .gridViewContainer,
        .gridViewContainerRTA {
            max-block-size: 250px;
            overflow: auto;
            border: 1px solid #ccc;
        }


        .grid-view tr {
            cursor: pointer;
        }

            .grid-view tr.selected-row {
                background-color: #0d6efd !important; /* Dark blue */
                color: white !important;
            }

        .hide-column {
            display: none;
        }


        .selected-row td {
            background-color: #d0ebff !important;
        }

        .selected-row-rta td {
            background-color: #d0ebff !important;
        }

        th {
            position: sticky;
            top: 0;
            background-color: black !important;
            color: white !important;
            z-index: 1;
            border: 2px solid black;
        }

        .highlight-row {
            background-color: #cce5ff !important; /* Light blue */
            cursor: pointer;
        }
    </style>

    <%-- FORMATE DATE --%>
    <script>
        function formatDateInput(inputField) {
            // oninput="formatDateInput(this)" placeholder="dd/mm/yyyy" MaxLength="10"
            inputField.addEventListener("input", function () {
                let input = this.value.replace(/\D/g, ''); // Remove non-numeric characters

                if (input.length > 2) input = input.substring(0, 2) + '/' + input.substring(2);
                if (input.length > 5) input = input.substring(0, 5) + '/' + input.substring(5, 10);

                this.value = input;
            });
        }
    </script>
    
    <script type="text/javascript">
        function addRowClickHandlers() {
            const rows = document.querySelectorAll('.grid-view tbody tr');
            rows.forEach(row => {
                row.addEventListener('click', function () {
                    // Remove selected class from all rows
                    rows.forEach(r => r.classList.remove('selected-row'));

                    // Add selected class to clicked row
                    this.classList.add('selected-row');

                    // Find the select button in this row and click it
                    const selectButton = this.querySelector('a[id*="lnkButton"]');
                    if (selectButton) {
                        selectButton.click();
                    }
                });
            });
        }

        // Call the function when page loads and after every async postback
        Sys.WebForms.PageRequestManager.getInstance().add_endRequest(function () {
            addRowClickHandlers();
        });

        document.addEventListener('DOMContentLoaded', addRowClickHandlers);
    </script>

    <script type="text/javascript">
        var lastClickedRowId = null;

        function handleRowClick(row) {
            // Remove highlight from all rows
            document.querySelectorAll('.grid-view tr').forEach(r => {
                r.classList.remove('selected-row');
            });

            // Highlight clicked row
            row.classList.add('selected-row');

            // Store the row ID for postback
            lastClickedRowId = row.id;

            // Store scroll position
            sessionStorage.setItem('gridScrollPosition', document.querySelector('.gridViewContainer').scrollTop);
        }

        function restoreScrollAndSelection() {
            if (lastClickedRowId) {
                const row = document.getElementById(lastClickedRowId);
                if (row) {
                    // Reapply highlight
                    row.classList.add('selected-row');

                    // Scroll to the row
                    const container = document.querySelector('.gridViewContainer');
                    const rowPosition = row.offsetTop - container.offsetTop;
                    container.scrollTop = rowPosition - (container.clientHeight / 2);
                }
            }

            // Restore scroll position if no specific row was clicked
            const savedScroll = sessionStorage.getItem('gridScrollPosition');
            if (savedScroll && !lastClickedRowId) {
                document.querySelector('.gridViewContainer').scrollTop = savedScroll;
            }
        }

        // Initialize row click handlers
        function initializeRowHandlers() {
            document.querySelectorAll('.grid-view tbody tr').forEach(row => {
                row.onclick = function () {
                    handleRowClick(this);

                    // Find and click the select button
                    const selectButton = this.querySelector('a[id*="lnkButton"]');
                    if (selectButton) {
                        selectButton.click();
                    }
                };

                // Set unique ID for each row
                const tranCode = row.getAttribute('data-trancode') || row.cells[0].innerText;
                row.id = 'row_' + tranCode;
            });
        }

        // Initialize when page loads and after every async postback
        Sys.WebForms.PageRequestManager.getInstance().add_endRequest(function () {
            initializeRowHandlers();
            restoreScrollAndSelection();
        });

        document.addEventListener('DOMContentLoaded', function () {
            initializeRowHandlers();
        });
    </script>

    <script type="text/javascript">
        function onRowClick(row) {

            const index = row.rowIndex;
            let table = row.closest("table");
            let rows = table.querySelectorAll("tr");

            const header = table.querySelector("thead");
            const dataRowIndex = header ? index - 1 : index;

            // 
            let hiddenField = document.getElementById("hfTRRowNumber");
            if (hiddenField) {
                hiddenField.value = dataRowIndex;
            }

            rows.forEach(r => {
                r.style.backgroundColor = "";
                r.classList.remove("selected-row");
            });

            row.style.backgroundColor = "#d9edf7";
            row.classList.add("selected-row");


            rows.forEach(r => {
                if (r !== row) {
                    let cb = r.querySelector("input[type='checkbox']");
                    if (cb) cb.checked = false;

                }
            });

            let checkbox = row.querySelector("input[type='checkbox']");

            // Check current row's checkbox and highlight row
            if (checkbox) {
                checkbox.checked = true;
                onRowSelect(checkbox);
            }
        }

        function onRowSelect(checkbox) {
            var row = checkbox.closest("tr");
            var grid = document.getElementById("<%= GridView1.ClientID %>");
            var rows = grid.getElementsByTagName("tr");

            // Uncheck all other checkboxes (optional now)
            for (var i = 1; i < rows.length; i++) {
                rows[i].classList.remove("selected-row");
            }

            // Highlight the selected row only
            row.classList.add("selected-row");

        }
    </script>

    <%-- LOADER ANIMATION --%>
    <div id="updateProgress" class="loading-overlay">
        <div class="spinner-container">
            <div class="spinner-border text-dark" role="status">
                <span class="rupee-sign"></span>
            </div>
        </div>
    </div>
    
    <style>
        /* Loader Overlay with Relaxing Yellow Background */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 223, 128, 0.2);
            /* Soft warm yellow */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            display: none;
            /* Initially hidden */
        }

        /* Centered Spinner Container */
        .spinner-container {
            position: relative;
            width: 40px;
            height: 40px;
        }

        /* Spinner with a Larger Size */
        .spinner-border {
            width: 40px;
            height: 40px;
            border-width: 6px;
            color: #FFC107;
            /* Bootstrap warning yellow */
            animation: spin 1s linear infinite;
        }

        /* Rupee Sign Positioned in the Center */
        .rupee-sign {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            font-weight: bold;
            color: #333;
            /* Dark color for contrast */
            font-family: Arial, sans-serif;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <%-- LOADER JS, GRID ROW FOCOUS JS --%>
    <script>
        // Get the PageRequestManager instance
        var prm = Sys.WebForms.PageRequestManager.getInstance();

        // Show loader when request starts
        prm.add_beginRequest(function () {
            document.getElementById("updateProgress").style.display = "flex";
        });

        // Hide loader when request completes
        prm.add_endRequest(function () {
            document.getElementById("updateProgress").style.display = "none";
            focusRtaRow()
        });


        function focusRtaRow() {
            var selectedRowIndex = parseInt(document.getElementById('<%= hfTRRowNumber.ClientID %>')?.value, 10);
            if (isNaN(selectedRowIndex) || selectedRowIndex < 0) return;

            var grid = document.getElementById('<%= GridView1.ClientID %>');
            if (!grid) return;

            var rows = grid.getElementsByTagName('tr');
            var dataRowIndex = selectedRowIndex + 1; // skip header row

            if (dataRowIndex >= rows.length) return;

            var targetRow = rows[dataRowIndex];

            Array.from(rows).forEach(row => row.style.backgroundColor = '');
            targetRow.style.backgroundColor = 'lightblue';

            var checkbox = targetRow.querySelector("input[type='checkbox']");
            if (checkbox) {
                checkbox.focus();
                checkbox.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    </script>

    <asp:HiddenField ID="hfTRRowNumber" runat="server" ClientIDMode="Static" Value="-1" />
    <asp:HiddenField ID="hfTrCode" runat="server" ClientIDMode="Static" Value="-1" />

    <div class="page-header">
        <h3 class="page-title">Maker Checker
        </h3>
    </div>





    <div class="row">
        <div class="grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">WealthMaker Transactions</h4>
                    <asp:UpdatePanel ID="UpdatePanelFilters" runat="server" UpdateMode="Conditional">
                        <ContentTemplate>
                            <div class="row g-3">
                                <div class="col-md-10">
                                    <div class="row g-3">

                                        <%-- REGION --%>
                                        <div class="col-md-3">
                                            <label for="region" class="form-label">Region</label>
                                            <asp:DropDownList AutoPostBack="true" ID="regionIDC"
                                                OnSelectedIndexChanged="regionIDC_SelectedIndexChanged"
                                                CssClass="form-select" runat="server">
                                            </asp:DropDownList>
                                        </div>

                                        <%-- ZONE --%>
                                        <div class="col-md-3">
                                            <label for="zone" class="form-label">Zone</label>
                                            <asp:DropDownList ID="zone" AutoPostBack="true"
                                                OnSelectedIndexChanged="zone_SelectedIndexChanged"
                                                runat="server" CssClass="form-select">
                                            </asp:DropDownList>
                                        </div>

                                        <%-- BRANCH --%>
                                        <div class="col-md-3">
                                            <label for="branch" class="form-label">Branch</label>
                                            <asp:DropDownList ID="branch" CssClass="form-select"
                                                AutoPostBack="true"
                                                OnSelectedIndexChanged="branch_SelectedIndexChanged"
                                                runat="server">
                                            </asp:DropDownList>
                                        </div>

                                        <%-- RM --%>
                                        <div class="col-md-3">
                                            <label for="rm" class="form-label">RM</label>
                                            <asp:DropDownList ID="rm" CssClass="form-select"
                                                runat="server">
                                            </asp:DropDownList>
                                        </div>

                                        <%-- DATE FROM --%>
                                        <div class="col-md-2">
                                            <label for="dateFrom" class="form-label">
                                                Date
                                                                            From <span
                                                                                class="text-danger">*</span></label>
                                            <div>
                                                <asp:TextBox ID="dtFrom"
                                                    class="form-control"
                                                    oninput="formatDateInput(this)"
                                                    placeholder="dd/mm/yyyy" MaxLength="10"
                                                    runat="server" />
                                            </div>
                                        </div>

                                        <%-- DATE TO --%>
                                        <div class="col-md-2">
                                            <label for="dateTo" class="form-label">
                                                Date
                                                                                To <span
                                                                                    class="text-danger">*</span></label>
                                            <div>
                                                <asp:TextBox ID="dtTo"
                                                    class="form-control"
                                                    oninput="formatDateInput(this)"
                                                    placeholder="dd/mm/yyyy"
                                                    MaxLength="10" runat="server" />
                                            </div>
                                        </div>

                                        <%-- AMC --%>
                                        <div class="col-md-2">
                                            <label for="amc"
                                                class="form-label">
                                                AMC</label>
                                            <asp:DropDownList ID="amc"
                                                runat="server"
                                                CssClass="form-select">
                                            </asp:DropDownList>
                                        </div>

                                        <%-- AR --%>
                                        <div class="col-md-3">
                                            <label for="ar"
                                                class="form-label">
                                                AR</label>
                                            <asp:TextBox ID="txtAR"
                                                runat="server"
                                                class="form-control" />
                                        </div>

                                        <%-- AUTO/MANUAL RECO. --%>
                                        <div class="col-md-3">
                                            <div
                                                class="d-flex align-items-center gap-3 mt-4">
                                                <div class="">
                                                    <label
                                                        class="form-check-label"
                                                        for="autoReconciled">
                                                        Auto Reco.
                                                                                                    <asp:RadioButton
                                                                                                        runat="server"
                                                                                                        class="form-check-input"
                                                                                                        ID="autoReconciled"
                                                                                                        Checked="true"
                                                                                                        AutoPostBack="true"
                                                                                                        OnCheckedChanged="autoReconciled_CheckedChanged"
                                                                                                        name="reconciliationType"
                                                                                                        value="auto" />
                                                    </label>
                                                </div>
                                                <div class="">
                                                    <label
                                                        class="form-check-label"
                                                        for="manualReconciled">
                                                        Manual Reco.
                                                                                                    <asp:RadioButton
                                                                                                        runat="server"
                                                                                                        class="form-check-input"
                                                                                                        ID="manualReconciled"
                                                                                                        AutoPostBack="true"
                                                                                                        OnCheckedChanged="manualReconciled_CheckedChanged"
                                                                                                        name="reconciliationType"
                                                                                                        value="manual" />
                                                    </label>
                                                </div>

                                               <asp:Label ID="trCount" runat="server" ForeColor="Red" Font-Bold="true" />

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="col-md-12">

                                        <label for="remarks" class="form-label">Remarks</label>
                                        <input class="form-control" id="remarks" />
                                    </div>

                                    <div class="col-md-12">
                                        <div class="d-flex align-items-center gap-3 mt-3">
                                            <asp:Button ID="go" runat="server" OnClick="go_Click"
                                                CssClass="btn btn-sm btn-primary" Text="Go" />
                                            <asp:Button runat="server" ID="reset" OnClick="reset_Click"
                                                Text="Reset" class="btn btn-sm btn-outline-primary"></asp:Button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ContentTemplate>
                    </asp:UpdatePanel>
                  
                    <asp:UpdatePanel ID="UpdatePanelGridView1" runat="server" UpdateMode="Conditional">
                        <ContentTemplate>
                            <div>
                                <br>
                                <h5 class="card-title">List</h5>

                                <div class="table-responsive gridViewContainer">
                                    <asp:GridView ID="GridView1"
                                        OnRowCommand="GridView1_RowCommand"
                                        OnPageIndexChanging="GridView1_PageIndexChanging"
                                        OnRowDataBound="GridView1_RowDataBound"
                                        CssClass="grid-view table"
                                        runat="server"
                                        DataKeyNames="TRAN_CODE"
                                        AutoGenerateColumns="TRUE"
                                        OnClientClick="onRowSelect(this);">
                                        <Columns>
                                            <asp:TemplateField>
                                                <ItemTemplate>
                                                    <asp:LinkButton ID="lnkButton" runat="server"
                                                        CommandName="SelectRow"
                                                        CommandArgument='<%# Eval("TRAN_CODE") %>'
                                                        Text="Select" />
                                                </ItemTemplate>
                                            </asp:TemplateField>
                                        </Columns>
                                    </asp:GridView>
                                </div>
                            </div>
                        </ContentTemplate>
                        <Triggers>
                            <asp:AsyncPostBackTrigger ControlID="go" EventName="Click" />
                            <asp:AsyncPostBackTrigger ControlID="reset" EventName="Click" />
                            <asp:AsyncPostBackTrigger ControlID="regionIDC" EventName="SelectedIndexChanged" />
                            <asp:AsyncPostBackTrigger ControlID="zone" EventName="SelectedIndexChanged" />
                            <asp:AsyncPostBackTrigger ControlID="branch" EventName="SelectedIndexChanged" />
                            <asp:AsyncPostBackTrigger ControlID="autoReconciled" EventName="CheckedChanged" />
                            <asp:AsyncPostBackTrigger ControlID="manualReconciled" EventName="CheckedChanged" />
                        </Triggers>
                    </asp:UpdatePanel>

                    <br />
                    <br />
                    <asp:UpdatePanel ID="UpdatePanelRTA" runat="server" UpdateMode="Conditional">
                        <ContentTemplate>
                            <div>
                                <h5 class="card-title">RTA Transactions</h5>
                                <div class="table-responsive gridViewContainerRTA">
                                    <asp:GridView ID="GridView2" runat="server"
                                        CssClass="table ">
                                    </asp:GridView>
                                </div>
                            </div>

                            <div
                                class="mt-5 d-flex align-items-center justify-content-center flex-md-row flex-column gap-3">
                                <asp:Button ID="AuditAR" runat="server" OnClick="AuditAR_Click"
                                    CssClass="btn btn-outline-primary" Text="Audit AR" />
                                <asp:Button ID="unreconcile" runat="server" OnClick="unreconcile_Click"
                                    CssClass="btn btn-outline-primary" Text="Unreconcile" />
                            </div>
                            <asp:Label ID="lblMessage" runat="server" />
                        </ContentTemplate>
                        <Triggers>
                            <asp:AsyncPostBackTrigger ControlID="GridView1" EventName="RowCommand" />
                            <asp:AsyncPostBackTrigger ControlID="AuditAR" EventName="Click" />
                            <%--<asp:AsyncPostBackTrigger ControlID="unreconcile" EventName="Click" />--%>
                        </Triggers>
                    </asp:UpdatePanel>
                </div>
            </div>
        </div>
    </div>









</asp:Content>

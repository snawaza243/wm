CREATE OR REPLACE PROCEDURE WEALTHMAKER.PSM_MF_RECO_MANUAL_RECO(
    P_TRAN_CODE      IN VARCHAR2,
    P_RTA_AMOUNT     IN NUMBER,
    P_RTA_TRAN_CODE  IN VARCHAR2,
    P_LOGIN_ID       IN VARCHAR2,
    P_ROLE_ID        IN VARCHAR2,
    P_CURSOR        OUT SYS_REFCURSOR    
)  
AS
    v_count1 NUMBER := 0;
    v_count2 NUMBER := 0;
    v_count3 NUMBER := 0;
    v_error_msg VARCHAR2(4000);
BEGIN
    -- Initialize output cursor with status message
    OPEN P_CURSOR FOR 
    SELECT 'Procedure started' AS message FROM dual;
    
    -- Begin transaction
    SAVEPOINT start_transaction;
    
    -- Validate input parameters
    IF P_TRAN_CODE IS NULL OR P_RTA_TRAN_CODE IS NULL OR P_LOGIN_ID IS NULL THEN
        RAISE_APPLICATION_ERROR(-20001, 'Mandatory parameters (TRAN_CODE, RTA_TRAN_CODE, LOGIN_ID) cannot be null');
    END IF;
    
    -- Update the first table (Transaction_mf_temp1 based on TRAN_CODE)
    UPDATE TRANSACTION_MF_TEMP1
    SET AMOUNT = P_RTA_AMOUNT,
        REC_FLAG = 'Y',
        RECO_DATE = SYSDATE,  -- Removed TO_DATE as SYSDATE is already a date
        REC_USER = P_LOGIN_ID,
        RTA_TRAN_CODE = P_RTA_TRAN_CODE
    WHERE TRAN_CODE = P_TRAN_CODE;
    
    v_count1 := SQL%ROWCOUNT;
    
    -- Update the second table (Transaction_mf_temp1 based on BASE_TRAN_CODE)
    UPDATE TRANSACTION_MF_TEMP1
    SET AMOUNT = P_RTA_AMOUNT,
        REC_FLAG = 'Y',
        RECO_DATE = SYSDATE,
        REC_USER = P_LOGIN_ID,
        RTA_TRAN_CODE = P_RTA_TRAN_CODE
    WHERE BASE_TRAN_CODE = P_TRAN_CODE;
    
    v_count2 := SQL%ROWCOUNT;
    
    -- Update the third table (Transaction_st@MF.BAJAJCAPITAL)
    UPDATE TRANSACTION_ST@MF.BAJAJCAPITAL
    SET REC_FLAG = 'Y',
        HO_TRAN_CODE = P_TRAN_CODE
    WHERE TRAN_CODE = P_RTA_TRAN_CODE;
    
    v_count3 := SQL%ROWCOUNT;
    
    -- Check if any updates were made
    IF v_count1 = 0 AND v_count2 = 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'No records found with TRAN_CODE or BASE_TRAN_CODE = ' || P_TRAN_CODE);
    END IF;
    
    IF v_count3 = 0 THEN
        RAISE_APPLICATION_ERROR(-20003, 'No records found in remote table with TRAN_CODE = ' || P_RTA_TRAN_CODE);
    END IF;
    
    -- Commit only if all updates succeeded
    COMMIT;
    
    -- Return success message with counts
    OPEN P_CURSOR FOR 
    SELECT 'SUCCESS: ' || 
           v_count1 || ' record(s) updated in TRANSACTION_MF_TEMP1 (by TRAN_CODE), ' ||
           v_count2 || ' record(s) updated in TRANSACTION_MF_TEMP1 (by BASE_TRAN_CODE), ' ||
           v_count3 || ' record(s) updated in TRANSACTION_ST@MF.BAJAJCAPITAL' AS message
    FROM dual;
    
EXCEPTION
    WHEN OTHERS THEN
        -- Rollback to savepoint in case of error
        ROLLBACK TO start_transaction;
        
        -- Get error message
        v_error_msg := SQLERRM;
        
        -- Return error details
        OPEN P_CURSOR FOR 
        SELECT 'ERROR: ' || v_error_msg AS message FROM dual;
        
        -- Optionally log the error to an error table
        -- INSERT INTO error_log(procedure_name, error_message, error_date, user_id)
        -- VALUES ('PSM_MF_RECO_MANUAL_RECO', v_error_msg, SYSDATE, P_LOGIN_ID);
        -- COMMIT;
END;
/
<%@ Page Language="C#" AutoEventWireup="true" CodeBehind="MfManualReconciliation.aspx.cs" Inherits="WM.Masters.MfManualReconciliation" MasterPageFile="~/vmSite.Master" %>

<asp:Content ID="Content1" ContentPlaceHolderID="ContentPlaceHolder1" runat="server">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css" />
    <link rel="stylesheet" href="assets/vendors/ti-icons/css/themify-icons.css" />
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css" />
    <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css" />
    <link rel="stylesheet" href="assets/css/style.css" />

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    <script src="/scripts/jquery.min.js"></script>
    <script src="/scripts/jquery.cookie.js"></script>
    <script src="/scripts/colResizable-1.5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>



    <div id="updateProgress" class="loading-overlay">
        <div class="spinner-container">
            <div class="spinner-border text-dark" role="status">
                <span class="rupee-sign"></span>
            </div>
        </div>
    </div>

    <style>
        /* Loader Overlay with Relaxing Yellow Background */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 223, 128, 0.1); /* Soft warm yellow */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            display: none; /* Initially hidden */
        }

        /* Centered Spinner Container */
        .spinner-container {
            position: relative;
            width: 40px;
            height: 40px;
        }

        /* Spinner with a Larger Size */
        .spinner-border {
            width: 40px;
            height: 40px;
            border-width: 6px;
            color: #FFC107; /* Bootstrap warning yellow */
            animation: spin 1s linear infinite;
        }

        /* Rupee Sign Positioned in the Center */
        .rupee-sign {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            font-weight: bold;
            color: #333; /* Dark color for contrast */
            font-family: Arial, sans-serif;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <script>
        // Get the PageRequestManager instance
        var prm = Sys.WebForms.PageRequestManager.getInstance();

        // Show loader when request starts
        prm.add_beginRequest(function () {
            document.getElementById("updateProgress").style.display = "flex";
        });

        // Hide loader when request completes
        prm.add_endRequest(function () {
            document.getElementById("updateProgress").style.display = "none";
            scrollToSelectedRow(); // Scroll to the selected row after update
        });

        function scrollToSelectedRow() {
            var selectedIndex = document.getElementById("hfSelectedRow").value;
            var grid = document.getElementById("<%= GridTransaction.ClientID %>");

            if (!grid || selectedIndex === "") return;

            var rowIndex = parseInt(selectedIndex, 10) + 1; // +1 to account for header row
            var rows = grid.getElementsByTagName("tr");

            if (rows.length > rowIndex) {
                var selectedRow = rows[rowIndex];

                // Scroll the row into view
                selectedRow.scrollIntoView({ behavior: "smooth", block: "center" });

                // Optionally highlight the row
                //selectedRow.style.backgroundColor = "#cce5ff"; // Light blue

                // Optionally re-check the checkbox
                //var checkbox = selectedRow.querySelector("input[type='checkbox'].select-row-checkbox");
                //if (checkbox) checkbox.checked = true;
            }
        }


    </script>

                            
    <div class="page-header">
        <h3 class="page-title">MF AR Reconciliation </h3>
    </div>
    
    <asp:UpdatePanel ID="upMain" runat="server" UpdateMode="Conditional">
        <ContentTemplate>
            

            <div class="row">
                <div class="grid-margin stretch-card draggable-container">
                    <div class="card">
                        <div class="card-body">
                            <%-- TR SEARCH INPUT --%>
                            <div>
                                <h4 class="card-title text-danger">WealthMaker Transactions</h4>
                                <div class="row g-3">
                                    <%-- AR SEARCH INPUT FIELDS --%>
                                    <div class="col-md-9">
                                        <div class="row g-3">
                                            <%-- CHANNEL --%>
                                            <div class="col-md-3">
                                                <asp:Label ID="LabelChannel" runat="server" Text="Channel" CssClass="form-label"></asp:Label>
                                                <asp:DropDownList ID="ddlChannel" runat="server" CssClass="form-select" AutoPostBack="true" OnSelectedIndexChanged="ddlBranchCategory_SelectedIndexChanged">
                                                    <asp:ListItem>Channel 1</asp:ListItem>
                                                    <asp:ListItem>Channel 2</asp:ListItem>
                                                    <asp:ListItem>Channel 3</asp:ListItem>
                                                </asp:DropDownList>
                                            </div>

                                            <%-- REGION --%>
                                            <div class="col-md-3">
                                                <asp:Label ID="LabelRegion" runat="server" Text="Region" CssClass="form-label"></asp:Label>
                                                <asp:DropDownList ID="ddlRegion" runat="server" CssClass="form-select" AutoPostBack="true" OnSelectedIndexChanged="ddlRegion_SelectedIndexChanged">
                                                    <asp:ListItem>Region 1</asp:ListItem>
                                                    <asp:ListItem>Region 2</asp:ListItem>
                                                    <asp:ListItem>Region 3</asp:ListItem>
                                                </asp:DropDownList>
                                            </div>

                                            <%-- ZONE --%>
                                            <div class="col-md-3">
                                                <asp:Label ID="LabelZone" runat="server" Text="Zone" CssClass="form-label"></asp:Label>
                                                <asp:DropDownList ID="ddlZone" runat="server" CssClass="form-select" AutoPostBack="true" OnSelectedIndexChanged="ddlzone_SelectedIndexChanged">
                                                    <asp:ListItem></asp:ListItem>
                                                    <asp:ListItem></asp:ListItem>
                                                    <asp:ListItem></asp:ListItem>
                                                </asp:DropDownList>
                                            </div>

                                            <%-- BRANCH --%>
                                            <div class="col-md-3">
                                                <asp:Label ID="LabelBranch" runat="server" Text="Branch" CssClass="form-label"></asp:Label>
                                                <asp:DropDownList ID="ddlBranch" runat="server" CssClass="form-select" AutoPostBack="true" OnSelectedIndexChanged="ddlRmFill_SelectedIndexChanged">
                                                    <asp:ListItem></asp:ListItem>
                                                    <asp:ListItem></asp:ListItem>
                                                    <asp:ListItem></asp:ListItem>
                                                </asp:DropDownList>
                                            </div>

                                            <%-- RM --%>
                                            <div class="col-md-3">
                                                <asp:Label ID="LabelRM" runat="server" Text="RM" CssClass="form-label"></asp:Label>
                                                <asp:DropDownList ID="ddlRM" runat="server" CssClass="form-select">
                                                    <asp:ListItem></asp:ListItem>
                                                    <asp:ListItem></asp:ListItem>
                                                    <asp:ListItem></asp:ListItem>
                                                </asp:DropDownList>
                                            </div>


                                            <%-- AMC --%>
                                            <div class="col-md-3">
                                                <asp:Label ID="LabelAMC" runat="server" Text="AMC" CssClass="form-label"></asp:Label>
                                                <asp:DropDownList ID="ddlAMC" runat="server" CssClass="form-select">
                                                    <asp:ListItem>AMC 1</asp:ListItem>
                                                    <asp:ListItem>AMC 2</asp:ListItem>
                                                    <asp:ListItem>AMC 3</asp:ListItem>
                                                </asp:DropDownList>
                                                <%-- AR: DISPLAY NONE --%>
                                                <div class="col-md-3" style="display: none;">
                                                    <asp:Label ID="LabelAR" runat="server" Text="AR" CssClass="form-label"></asp:Label>
                                                    <asp:TextBox ID="txtAR" runat="server" CssClass="form-control"></asp:TextBox>
                                                </div>

                                            </div>

                                            <%-- DATE FROM --%>
                                            <div class="col-md-3">
                                                <asp:Label ID="LabelDateFrom" runat="server" Text="Date From" CssClass="form-label"></asp:Label>
                                                <div class="date">
                                                    <asp:TextBox ID="txtDateFrom" runat="server"
                                                        CssClass="form-control" oninput="psmFrmJs_DateInput(this)" placeholder="dd/mm/yyyy" MaxLength="10"></asp:TextBox>

                                                </div>
                                            </div>

                                            <%-- DATE TO  --%>
                                            <div class="col-md-3">
                                                <asp:Label ID="LabelDateTo" runat="server" Text="Date To" CssClass="form-label"></asp:Label>
                                                <div class="date">
                                                    <asp:TextBox ID="txtDateTo" runat="server" CssClass="form-control " oninput="psmFrmJs_DateInput(this)" placeholder="dd/mm/yyyy" MaxLength="10"></asp:TextBox>

                                                </div>
                                            </div>

                                            <%-- TRAN TYPE --%>
                                            <div class="col-md-6">
                                                <label class="form-label">Tran Type</label>
                                                <div class="d-flex align-items-center flex-wrap">

                                                    <asp:RadioButtonList ID="rblTranType" runat="server"
                                                        RepeatDirection="Horizontal"
                                                        RepeatLayout="Flow"
                                                        CssClass="form-check rbl-options-common-margin">
                                                        <asp:ListItem Text="Regular" Value="regular" Selected="True" />
                                                        <asp:ListItem Text="PMS" Value="pms" />
                                                        <asp:ListItem Text="ATM" Value="atm" />
                                                        <asp:ListItem Text="Trail Actual" Value="trailActual" />
                                                        <asp:ListItem Text="NFO" Value="sip" />

                                                    </asp:RadioButtonList>
                                                </div>
                                            </div>
                                        


                                            <%-- REGISTRAR --%>
                                            <div class="col-md-4">
                                                <label class="form-label">Registrar</label>
                                                 <div class="d-flex align-items-center flex-wrap">
                                                    <asp:RadioButtonList
                                                        ID="rblRegistrar"
                                                        runat="server"
                                                        RepeatDirection="Horizontal"
                                                        RepeatLayout="Flow"
                                                        CssClass="form-check rbl-options-common-margin">

                                                        <asp:ListItem  Text="C" Value="c" />
                                                        <asp:ListItem Text="K" Value="k" />
                                                        <asp:ListItem Text="C COB" Value="ccob" />
                                                        <asp:ListItem Text="K COB" Value="kcob" />
                                                    </asp:RadioButtonList>
                                                </div>
                                            </div>


                                            <%-- RECO, UNREOC, AND COB --%>
                                            <div class="col-md-2">
                                                <div class="d-flex align-items-center flex-wrap gap-3">

                                                    <asp:RadioButtonList
                                                        ID="rblReconciliation"
                                                        runat="server"
                                                        RepeatDirection="Horizontal"
                                                        RepeatLayout="Flow"
                                                        CssClass="form-check rbl-options-common-margin">

                                                        <asp:ListItem Text="Reco" Value="Y" />
                                                        <asp:ListItem Text="Unreco" Value="N" Selected="True" />
                                                    </asp:RadioButtonList>
                                                   
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <%-- SEARCH BTN, COUNT P --%>
                                    <div class="col-md-3">
                                        <%-- AR NO --%>
                                        <div class="col-md-12">
                                            <asp:Label ID="LabelARNo" runat="server" Text="AR No." CssClass="form-label"></asp:Label>
                                            <asp:TextBox ID="txtARNo" runat="server" CssClass="form-control"></asp:TextBox>
                                        </div>

                                        <%-- BTN: GO, RESET, EXPORT --%>
                                        <div class="col-md-12 mt-2">
                                            <div class="d-flex align-items-center flex-wrap gap-3 mt-4">
                                                <%--   --%>

                                                <asp:UpdatePanel ID="upFind1" runat="server">
                                                    <ContentTemplate>
                                                        <asp:Button ID="btnGo" runat="server" Text="Go" CssClass="btn btn-sm btn-primary" OnClick="btnGo_Click" />
                                                    </ContentTemplate>
                                                </asp:UpdatePanel>

                                                <asp:Button ID="btnReset" runat="server" Text="Reset" CssClass="btn btn-sm btn-outline-primary" OnClick="btnReset_Click" />
                                                <button type="button" id="btnExportTr" class="btn btn-sm btn-outline-primary" onclick="btnExportTrData()">Export</button>


                                                <%--<asp:Button ID="btnExportTr" runat="server" Text="Export" CssClass="btn btn-sm btn-outline-primary" />--%>
                                            <asp:Button ID="btnExit" runat="server" CssClass="btn btn-sm btn-outline-primary" Text="Exit" OnClick="btnExit_Click" />

                                            </div>
                                        </div>

                                        <%-- COUNT --%>
                                        <div class="col-md-12">
                                            <div class="form-check">
                                                <asp:CheckBox ID="cbCOB" runat="server" Text="COB" />
                                            </div>

                                            <div>

                                            <p class="text-danger fw-bold mt-4">
                                                Count:
                                <asp:Label ID="lblRowCount" runat="server" Text="0"></asp:Label>
                                            </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                               
                            </div>
                            
                            <br />
                            <%-- TR SEARCHED GRID --%>
                            <div >
                                <asp:HiddenField ID="hftran1stcode" runat="server" />

                                <div class="table-responsive" id="gridContainer1" style="max-height: 250px; overflow-y: auto;">
                                    <asp:GridView ID="GridTransaction" CssClass="table table-bordered" 
                                           OnRowDataBound="GridTransaction_RowDataBound"
                                        runat="server" AutoGenerateColumns="false">
                                        <HeaderStyle CssClass="thead-dark" />
                                        <Columns>
                                            <asp:TemplateField HeaderText="Action" HeaderStyle-Width="50px">
                                                <ItemTemplate>
                                                    <asp:HiddenField ID="hfTranCode" runat="server" Value='<%# Eval("TRAN_CODE") %>' />
                                                    <asp:CheckBox ID="chkSelect" runat="server" CssClass="select-row-checkbox" AutoPostBack="false" OnClientClick="return onRowSelect(this);" />
                                                </ItemTemplate>
                                            </asp:TemplateField>
                                            
                                            <asp:TemplateField HeaderText="Tran Code" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblTranTyp" runat="server" Text='<%# Eval("TRAN_CODE") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="TranDate" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblTrnDate" runat="server" Text='<%# Eval("TR_DATE"  ,  "{0:dd/MM/yyyy}") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="Investor" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblInvestorNam" runat="server" Text='<%# Eval("INVESTOR_NAME") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <%-- MUT CODE --%>
                                            <asp:TemplateField HeaderText="AMC CODE" HeaderStyle-Width="150px" ItemStyle-CssClass="hide-column" HeaderStyle-CssClass="hide-column">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblAC" runat="server" Text='<%# Eval("MUT_CODE") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <%-- MUT NAME --%>
                                            <asp:TemplateField HeaderText="AMC NAME" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblAMCNAM" runat="server" Text='<%# Eval("MUT_NAME") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>


                                            <%-- SCH NAME --%>
                                            <asp:TemplateField HeaderText="Scheme Name" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblScemeName" runat="server" Text='<%# Eval("SCH_NAME") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <%-- AMOUNT --%>
                                            <asp:TemplateField HeaderText="Amount" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblmount" runat="server" Text='<%# Eval("AMOUNT") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>
                                            <%-- ADDRESS1 --%>
                                            <asp:TemplateField HeaderText="Address" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblAddress" runat="server" Text='<%# Eval("ADDRESS1") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <%-- CITY NAME --%>
                                            <asp:TemplateField HeaderText="City Name" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblCityName" runat="server" Text='<%# Eval("CITY_NAME") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <%-- FOLIO NO --%>
                                            <asp:TemplateField HeaderText="Folio No" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblFoloNo" runat="server" Text='<%# Eval("FOLIO_NO") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <%-- CHEQUE NO --%>
                                            <asp:TemplateField HeaderText="Chq No" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblCqNo" runat="server" Text='<%# Eval("CHEQUE_NO") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <%-- APP NO --%>
                                            <asp:TemplateField HeaderText="App No" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblAppoModify" runat="server" Text='<%# Eval("APP_NO") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="Pan No" HeaderStyle-Width="150px" ItemStyle-CssClass="hide-column" HeaderStyle-CssClass="hide-column">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblpanNo" runat="server" Text='<%# Eval("PANNO") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="RM" HeaderStyle-Width="150px" ItemStyle-CssClass="hide-column" HeaderStyle-CssClass="hide-column">
                                                <ItemTemplate>
                                                    <asp:Label ID="llRM" HeaderStyle-Width="150px" runat="server" Text='<%# Eval("RMCODE") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="rm_name" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblScemeCode" runat="server" Text='<%# Eval("rm_name") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="Branch Name" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblbranhname" runat="server" Text='<%# Eval("branch_name") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="TranType" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="llTrnType" runat="server" Text='<%# Eval("TRAN_TYPE") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="SIP Type" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblSipType" runat="server" Text='<%# Eval("SIP_TYPE") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="Flag" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblfag" runat="server" Text='<%# Eval("FLAG") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="Broker Code" HeaderStyle-Width="150px" ItemStyle-CssClass="hide-column" HeaderStyle-CssClass="hide-column">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblbrokerCode" runat="server" Text='<%# Eval("BROKER_ID") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="Sip Amount" HeaderStyle-Width="150px" ItemStyle-CssClass="hide-column" HeaderStyle-CssClass="hide-column">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblsipamont" runat="server" Text='<%# Eval("Sip_Amount") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="Branch Code" HeaderStyle-Width="150px" ItemStyle-CssClass="hide-column" HeaderStyle-CssClass="hide-column">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblbranhna" runat="server" Text='<%# Eval("branch_code") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="Remark" HeaderStyle-Width="150px">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblremarkreco" runat="server" Text='<%# Eval("remark_reco") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="registrar" HeaderStyle-Width="150px" ItemStyle-CssClass="hide-column" HeaderStyle-CssClass="hide-column">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblregis" runat="server" HeaderStyle-Width="150px" Text='<%# Eval("registrar") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>

                                            <asp:TemplateField HeaderText="COB FLAG" HeaderStyle-Width="150px" ItemStyle-CssClass="hide-column" HeaderStyle-CssClass="hide-column">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblCOBFL" runat="server" Text='<%# Eval("COB_FLAG") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>
                                        </Columns>
                                    </asp:GridView>
                                </div>
                            </div>

                            <br />
                            <hr />

                            <%-- RTA SEARCH INPUT --%>
                            <div>
                                <h5 class="card-title text-danger">RTA Transactions</h5>
                                <%-- RTA SEARCH GRID --%>
                                <div>
                                    <%--<h5 class="card-title">List</h5>--%>

                                    <asp:HiddenField ID="hfSelectedTranCode" runat="server" />
                                    <asp:HiddenField ID="hfSelectedAmount" runat="server" />

                                 
                                    <div class="table-responsive" id="gridContainer2" style="max-height: 250px; overflow-y: auto;">

                                 <%--       <asp:GridView ID="GridView1" runat="server" CssClass="table table-bordered"
                                            AutoGenerateColumns="false" OnRowDataBound="GridView1_RowDataBound">
                                            <Columns>
                                                <asp:TemplateField>
                                                    <ItemTemplate>
                                                        <input type="checkbox" class="rta-checkbox"
                                                            data-tran1='<%# Eval("TRAN_CODE") %>'
                                                            data-tran2='<%# Eval("amount") %>'

                                                            onclick="onRtaRowSelect(this)" />
                                                    </ItemTemplate>
                                                </asp:TemplateField>
                                            </Columns>
                                        </asp:GridView>--%>

                                         <asp:GridView 
                                             ID="GridView1" runat="server" CssClass="table table-bordered"
                                            AutoGenerateColumns="false" OnRowDataBound="GridView1_RowDataBound">
                                            
                                            <HeaderStyle CssClass="thead-dark" />
                                            <Columns>

                                                <%-- CHECK BOX WITH TRAN_CODE --%>
                                                <asp:TemplateField HeaderText="Action" HeaderStyle-Width="50px">
                                                    <ItemTemplate>

                                                        <asp:HiddenField ID="hfTranCoderta" runat="server" Value='<%# Eval("UNIQUE_TRAN") %>' />
                                                        <asp:CheckBox ID="chkSelect" runat="server" CssClass="chk-rta" AutoPostBack="false" />

                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- TRAN CODE --%>
                                                <asp:TemplateField HeaderText="Tran Code" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblTranCode" runat="server" Text='<%# Eval("UNIQUE_TRAN") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- TR DATE --%>
                                                <asp:TemplateField HeaderText="TranDate" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lbleTrnDate" runat="server" Text='<%# Eval("TR_DATE", "{0:dd/MM/yyyy}") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- INV NAME --%>
                                                <asp:TemplateField HeaderText="Investor" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblInvestorNeam" runat="server" Text='<%# Eval("INVESTOR_NAME") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>


                                                <%-- MUT CODE --%>
                                                <asp:TemplateField HeaderText="AMC CODE" Visible="false" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblmAC" runat="server" Text='<%# Eval("MUT_CODE") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- MUT NAME --%>
                                                <asp:TemplateField HeaderText="AMC NAME" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lbelAMCNAM" runat="server" Text='<%# Eval("MUT_NAME") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- SCH NAME --%>
                                                <asp:TemplateField HeaderText="Scheme Name" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblScemeNaeme" runat="server" Text='<%# Eval("SCH_NAME") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>
                                                <%-- AMOUNT --%>
                                                <asp:TemplateField HeaderText="Amount" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblemount" runat="server" Text='<%# Eval("AMOUNT", "{0:N2}") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- ADDRESS1 --%>
                                                <asp:TemplateField HeaderText="Address" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblAdderess" runat="server" Text='<%# Eval("ADDRESS") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- CITY NAME --%>
                                                <asp:TemplateField HeaderText="City Name" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblCityeName" runat="server" Text='<%# Eval("CITY_NAME") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- FOLIO NO --%>
                                                <asp:TemplateField HeaderText="Folio No" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblFeoloNo" runat="server" Text='<%# Eval("FOLIO_NO") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- CHEQUE NO --%>
                                                <asp:TemplateField HeaderText="Chq No" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lbleCqNo" runat="server" Text='<%# Eval("CHEQUE_NO") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- APP NO --%>
                                                <asp:TemplateField HeaderText="App No" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblApepoModify" runat="server" Text='<%# Eval("APP_NO") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- TRAN TYPE --%>
                                                <asp:TemplateField HeaderText="TranType" Visible="false" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="ellTrnType" runat="server" Text='<%# Eval("TRAN_TYPE") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- RM CODE --%>
                                                <asp:TemplateField HeaderText="RM" Visible="false" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="llReM" runat="server" Text='<%# Eval("BUSINESS_RMCODE") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                                <%-- RO NAME --%>
                                                <asp:TemplateField HeaderText="rm_name" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblScemeeCode" runat="server" Text='<%# Eval("rm_name") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                             

                                                <%-- BRNACH_NAME --%>
                                                <asp:TemplateField HeaderText="Branch Name" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblbranhnae" runat="server" Text='<%# Eval("branch_name") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>

                                             
                                                <%-- BSS RM CODE --%>
                                                <asp:TemplateField HeaderText="Broker Code" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblbrokeercode" runat="server" Text='<%# Eval("BROKER_CODE") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>                                                

                                                <%-- UNQ KEY --%>
                                                <asp:TemplateField HeaderText="Unique Key" HeaderStyle-Width="150px">
                                                    <ItemTemplate>
                                                        <asp:Label ID="lblekey" runat="server" Text='<%# Eval("UNQ_KEY") %>' />
                                                    </ItemTemplate>
                                                </asp:TemplateField>                                         

                                            </Columns>
                                        </asp:GridView>

                                    </div>
                                </div>
                            <br />

                                <%-- RTA SEARCH INPUT  --%>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="row g-3">
                                            <%-- FROM DATE --%>
                                            <div class="col-md-6">
                                                <label for="dateFrom-rta" class="form-label">Date From <span class="text-danger">*</span></label>
                                                <div class="date" >
                                                    <asp:TextBox ID="dateFromRta" runat="server" CssClass="form-control date-input" placeholder="dd/mm/yyyy"></asp:TextBox>
                                                   
                                                </div>
                                            </div>

                                            <%-- TO DATE --%>
                                            <div class="col-md-6">
                                                <label for="dateTo-rta" class="form-label">Date To <span class="text-danger">*</span></label>
                                                <div class="date" >
                                                    <asp:TextBox ID="dateToRta" runat="server" CssClass="form-control date-input" placeholder="dd/mm/yyyy"></asp:TextBox>
                                                    
                                                </div>
                                            </div>

                                            <%-- AMC --%>
                                            <div class="col-md-6">
                                                <label for="amc" class="form-label">AMC</label>
                                                <asp:DropDownList ID="DropDownList1" runat="server" CssClass="form-select">
                                                    <asp:ListItem Text="AMC 1" Value=""></asp:ListItem>
                                                    <asp:ListItem Text="AMC 2" Value="2"></asp:ListItem>
                                                    <asp:ListItem Text="AMC 3" Value="3"></asp:ListItem>
                                                </asp:DropDownList>
                                            </div>

                                            <%-- BRANCH --%>
                                            <div class="col-md-6">
                                                <label for="branch" class="form-label">Branch</label>
                                                <asp:DropDownList ID="DropDownList2" runat="server" CssClass="form-select">
                                                    <asp:ListItem Text="" Value=""></asp:ListItem>
                                                    <asp:ListItem Text="Branch 2" Value="2"></asp:ListItem>
                                                    <asp:ListItem Text="Branch 3" Value="3"></asp:ListItem>
                                                </asp:DropDownList>
                                            </div>

                                            <%-- STATUS: RECO & UNRECO --%>
                                            <div class="col-md-6">
                                                <label for="reconciliationType-rta" class="form-label">Status</label>
                                                <asp:RadioButtonList ID="rblReconciliationType" runat="server" RepeatDirection="Horizontal" CssClass="form-check">
                                                    <asp:ListItem Text="Reconciled" Value="Y"></asp:ListItem>
                                                    <asp:ListItem Text="Unreconciled" Value="N" Selected="True"></asp:ListItem>
                                                </asp:RadioButtonList>
                                            </div>

                                            <%-- TRAN TYPE --%>
                                            <div class="col-md-6">
                                                <label class="form-label">Tran Type</label>
                                                <asp:RadioButtonList ID="RadioButtonList1" runat="server" RepeatDirection="Horizontal" CssClass="form-check">
                                                    <asp:ListItem Text="Regular" Value="REGULAR" Selected="True"></asp:ListItem>
                                                    <asp:ListItem Text="Sip" Value="SIP"></asp:ListItem>
                                                </asp:RadioButtonList>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <%--<h4 class="mb-3">Search</h4>--%>
                                        <div class="row g-3">

                                            <%-- SEARCH DDL --%>
                                            <div class="col-md-6">
                                                <label for="chequeNo" class="form-label">Search</label>

                                                <asp:DropDownList ID="ddlChequeNo" runat="server" CssClass="form-select" onchange="ddlChequeChanged()">
                                                    <asp:ListItem Text="" Value=""></asp:ListItem>
                                                    <asp:ListItem Text="CHEQUE_NO" Value="001"></asp:ListItem>
                                                    <asp:ListItem Text="FOLIO_NO" Value="002"></asp:ListItem>
                                                    <asp:ListItem Text="APP_NO" Value="003"></asp:ListItem>
                                                    <asp:ListItem Text="PANNO" Value="004"></asp:ListItem>
                                                    <asp:ListItem Text="BROKER_ID" Value="005"></asp:ListItem>
                                                </asp:DropDownList>
                                            </div>

                                            <asp:HiddenField ID="hfSelectedRow" runat="server" ClientIDMode="Static" Value="-1" />
                                            <asp:HiddenField ID="hfrtaselectedrow" runat="server" ClientIDMode="Static" Value="-1" />

                                         
                                            <div class="col-md-6">
                                                <asp:TextBox ID="txtChequeSearch" runat="server" CssClass="form-control mt-4" placeholder="Input type text"></asp:TextBox>
                                            </div>
                                            <div>
                                                <label for="investorName" class="form-label">Investor Name</label>
                                                <asp:TextBox ID="txtInvestorName" runat="server" CssClass="form-control"></asp:TextBox>
                                            </div>
                                            <div>
                                                <label for="amount" class="form-label">Amount</label>
                                                <asp:TextBox ID="txtAmount" runat="server" CssClass="form-control"></asp:TextBox>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div>
                                            <label for="searching" class="form-label">Searching (Click Column You Want To Search)</label>
                                            <div class="input-group">
                                                <asp:TextBox ID="txtSearching" runat="server" CssClass="form-control"></asp:TextBox>
                                                <asp:Button ID="btnFind" runat="server" CssClass="btn btn-outline-primary" Text="Find" Enabled="false" />
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center flex-wrap gap-3 my-3">
                                            <asp:UpdatePanel ID="upFind2" runat="server">
                                                <ContentTemplate>

                                                    <asp:Button ID="btnSearch" runat="server" CssClass="btn btn-sm btn-primary" Text="Search" OnClick="btnSearch_Click" />
                                                </ContentTemplate>
                                            </asp:UpdatePanel>
                                            <asp:Button ID="Button1" runat="server" CssClass="btn btn-sm btn-outline-primary" Text="Reset" OnClick="Button1_Click" />
                                            <%--<asp:Button ID="btnExportRta" runat="server" CssClass="btn btn-sm btn-outline-primary" Text="Export"  />--%>
                                            <button type="button" id="btnExportRta" class="btn btn-sm btn-outline-primary" onclick="btnExportRtaData()">Export</button>

                                            
                                        </div>
                                        <div>
                                            <label for="remarks" class="form-label">Remarks</label>
                                            <div class="input-group">
                                                <asp:TextBox ID="txtRemarks" runat="server" CssClass="form-control"></asp:TextBox>
                                                <asp:UpdatePanel ID="UpdatePanel1" runat="server">
                                                    <ContentTemplate>
                                                        <asp:Button ID="btnSaveRemarks" runat="server" CssClass="btn btn-outline-primary" Text="Save" OnClick="CmdSaveRemark_Click" />

                                                    </ContentTemplate>
                                                </asp:UpdatePanel>

                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center flex-wrap gap-3 my-3">

                                            <asp:UpdatePanel ID="UpdatePanelButtons" runat="server">
                                                <ContentTemplate>

                                                    <asp:Button ID="btnConfirmPMS" runat="server"
                                                        CssClass="btn btn-sm btn-outline-primary"
                                                        Text="Confirm PMS"
                                                        OnClick="cmdConfirm_Click" />

                                                    <asp:Button ID="btnUnconfirmPMS" runat="server"
                                                        CssClass="btn btn-sm btn-outline-primary"
                                                        Text="Unconfirm PMS"
                                                        OnClick="cmdUnconfirm_Click" />

                                                    <asp:Button ID="btnReconcile" runat="server"
                                                        CssClass="btn btn-sm btn-primary"
                                                        Text="Reconcile"
                                                        OnClick="btnReconcile_Click" />

                                                </ContentTemplate>

    
                                            </asp:UpdatePanel>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <hr />
                            <br />
                            <%-- SERACH ONLY TRAN INPUT --%>
                            <div>
                                <h5 class="card-title text-danger">Tran Code</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <asp:TextBox ID="tarnCode" runat="server" CssClass="form-control"></asp:TextBox>
                                            <asp:UpdatePanel ID="upFind3" runat="server">
                                                <ContentTemplate>
                                                    <asp:Button ID="findButton" runat="server" Text="Find" CssClass="btn btn-outline-primary" OnClick="btnSearchtrn_Click" />
                                                </ContentTemplate>
                                            </asp:UpdatePanel>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <%-- SEACH ONLY TRAN GRID  --%>
                            <div>
                                <%--<h5 class="card-title">List</h5>--%>
                                <div class="table-responsive">
                                    <asp:GridView ID="tranCodeGrid" CssClass="table table-bordered" runat="server" AutoGenerateColumns="false">
                                        <HeaderStyle CssClass="thead-dark" />
                                        <Columns>
                                            <asp:TemplateField HeaderText="Tran Code">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblInvestorName" runat="server" Text='<%# Eval("HO_TRAN_CODE") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>
                                            <asp:TemplateField HeaderText="Branch Name">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblAddress" runat="server" Text='<%# Eval("BRANCH_NAME") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>
                                            <asp:TemplateField HeaderText="Amount">
                                                <ItemTemplate>
                                                    <asp:Label ID="lblAmount" runat="server" Text='<%# Eval("AMOUNT") %>' />
                                                </ItemTemplate>
                                            </asp:TemplateField>
                                        </Columns>
                                    </asp:GridView>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </ContentTemplate>
        <Triggers>
            <asp:AsyncPostBackTrigger ControlID="btnGo" EventName="Click" />
            <asp:AsyncPostBackTrigger ControlID="btnSearch" EventName="Click" />
            <asp:AsyncPostBackTrigger ControlID="findButton" EventName="Click" />
            <asp:AsyncPostBackTrigger ControlID="btnSaveRemarks" EventName="Click" />
            <asp:AsyncPostBackTrigger ControlID="btnConfirmPMS" EventName="Click" />
            <asp:AsyncPostBackTrigger ControlID="btnUnconfirmPMS" EventName="Click" />
            <asp:AsyncPostBackTrigger ControlID="btnReconcile" EventName="Click" />
        </Triggers>
    </asp:UpdatePanel>

    <!-- Scripts -->
    <script src="assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="assets/vendors/chart.js/chart.umd.js"></script>
    <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <script src="assets/js/off-canvas.js"></script>
    <script src="assets/js/misc.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/todolist.js"></script>
    <script src="assets/js/jquery.cookie.js"></script>
    <script src="assets/js/dashboard.js"></script>

    <%-- DATE INPUT VALIDATION --%>
    <script>

        //oninput = "psmFrmJs_DateInput(this)" placeholder = "dd/mm/yyyy" MaxLength = "10"
        function psmFrmJs_DateInput(inputField) {
            inputField.addEventListener("input", function () {
                let input = this.value.replace(/\D/g, ''); // Remove non-numeric characters
                if (input.length > 2) input = input.substring(0, 2) + '/' + input.substring(2);
                if (input.length > 5) input = input.substring(0, 5) + '/' + input.substring(5, 10);
                this.value = input;
            });
        }

        function formatDate(rawDate) {
            if (!rawDate) return '';
            try {
                var date = new Date(parseInt(rawDate.substr(6)));
                return date.toLocaleDateString('en-GB'); // dd/MM/yyyy
            } catch (e) {
                return rawDate; // fallback to original
            }
        }


        function formatDateInput(inputField, skipIfTrue = false) {
            // If skipIfTrue is false, set today's date
            if (!skipIfTrue) {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const year = today.getFullYear();

                inputField.value = `${day}/${month}/${year}`;
            }

            inputField.addEventListener("input", function () {
                let input = this.value.replace(/\D/g, ''); // Remove non-numeric characters

                if (input.length > 2) input = input.substring(0, 2) + '/' + input.substring(2);
                if (input.length > 5) input = input.substring(0, 5) + '/' + input.substring(5, 10);

                this.value = input;
            });
        }


        function validateDateFormat(dateStr) {
            // Regex: dd/mm/yyyy
            const regex = /^(0[1-9]|[12][0-9]|3[01])\/(0[1-9]|1[0-2])\/\d{4}$/;
            return regex.test(dateStr);
        }

        function bindDateEvents(inputField) {
            inputField.addEventListener("focus", function () {
                formatDateInput(this);
            });

            inputField.addEventListener("blur", function () {
                const value = this.value.trim();
                if (value !== "" && !validateDateFormat(value)) {
                    alert("Invalid date format. Please use dd/mm/yyyy.");
                    setTimeout(() => this.focus(), 0); // bring focus back after alert closes
                }
            });

        }
 
    </script>


    <%--  DDL CHEQUE CHANGE  --%>
    <script type="text/javascript">
        function ddlChequeChanged() {
            var selectedField = document.getElementById("<%= ddlChequeNo.ClientID %>").value;
            var selectedValue = document.getElementById("hfSelectedRow").value;
            var selectedIndex = isNaN(parseInt(selectedValue)) ? -1 : parseInt(selectedValue);
            var grid = document.getElementById("<%= GridTransaction.ClientID %>");

            if (!grid || selectedIndex < 0) {
                document.getElementById("<%= txtChequeSearch.ClientID %>").value = "Please select a row first.";
                return;
            }

            var rows = grid.getElementsByTagName("tr");
            if (selectedIndex + 1 >= rows.length) {
                document.getElementById("<%= txtChequeSearch.ClientID %>").value = "Invalid row selected.";
                return;
            }

            var row = rows[selectedIndex + 1];
            var value = "";

            switch (selectedField) {
                case "001": value = row.querySelector("[id*='lblCqNo']").innerText; break;
                case "002": value = row.querySelector("[id*='lblFoloNo']").innerText; break;
                case "003": value = row.querySelector("[id*='lblAppoModify']").innerText; break;
                case "004": value = row.querySelector("[id*='lblpanNo']").innerText; break;
                case "005": value = row.querySelector("[id*='lblbrokerCode']").innerText; break;
            }

            document.getElementById("<%= txtChequeSearch.ClientID %>").value = value;
        }

        // Rebind dropdown after partial update
        Sys.Application.add_load(function () {
            var ddl = document.getElementById("<%= ddlChequeNo.ClientID %>");
            if (ddl) {
                ddl.onchange = ddlChequeChanged;
            }
        });
    </script>

    <style>
        .hide-column {
            display: none;
        }

        .selected-row td {
            background-color: #d0ebff !important;
        }

        .selected-row-rta td {
            background-color: #d0ebff !important;
        }

        #ContentPlaceHolder1_GridTransaction tbody tr th, #ContentPlaceHolder1_GridView1 tbody tr th{
            position: sticky;
            top: 0;
            background-color: #B78939 !important;
            color: white !important;
            z-index: 1;
        }

        .highlight-row {
            background-color: #cce5ff !important;
            cursor: pointer;
        }

        .rbl-options-common-margin label {
            margin-right: 0.9rem;
        }

        .hide-column {
            display: none;
        }

        .selected-row td {
            background-color: #d0ebff !important;
        }

        .selected-row-rta td {
            background-color: #d0ebff !important;
        }

        .draggable-container {
            overflow-y: auto;
            background: #fff;
        }
    </style>

    <%-- TR ON ROW CLICK --%>
    <script type="text/javascript">
        function onRowClick(row) {

            const index = row.rowIndex;
            let table = row.closest("table");
            let rows = table.querySelectorAll("tr");

            const header = table.querySelector("thead");
            const dataRowIndex = header ? index - 1 : index;

            rows.forEach(r => {
                r.style.backgroundColor = "";
                r.classList.remove("selected-row");
            });

            row.style.backgroundColor = "#d9edf7";
            row.classList.add("selected-row");


            rows.forEach(r => {
                if (r !== row) {
                    let cb = r.querySelector("input[type='checkbox']");
                    if (cb) cb.checked = false;

                }
            });

            let checkbox = row.querySelector("input[type='checkbox']");

            // Check current row's checkbox and highlight row
            if (checkbox) {
                checkbox.checked = true;
                onRowSelect(checkbox);
            }
        }


        function onRowSelect(checkbox) {
            var row = checkbox.closest("tr");
            var grid = document.getElementById("<%= GridTransaction.ClientID %>");
            var rows = grid.getElementsByTagName("tr");

            for (var i = 1; i < rows.length; i++) {
                rows[i].classList.remove("selected-row");
            }

            row.classList.add("selected-row");

            document.getElementById("hfSelectedRow").value = row.rowIndex - 1;

            clearFieldsOfRta();  

            const getText = (id) => row.querySelector("[id*='" + id + "']")?.innerText.trim() || '';
            const getValue = (id) => row.querySelector("[id*='" + id + "']")?.value.trim() || '';

            const tranCode = getValue("hfTranCode");
            const tranDateStr = getText("lblTrnDate");
            const tranType = getText("llTrnType");
            const investorName = getText("lblInvestorNam");
            const amcCode = getText("lblAC");
            const branch = getText("lblbranhna");
            const amount = getText("lblmount");
            const sipType = getText("lblSipType");
            const chqno = getText("lblCqNo");
            const panno = getText("lblpanNo");


            
            const registrar = getText("lblregis");
            const cobfl = getText("lblCOBFL");
            const remark = getText("lblremarkreco");

            document.getElementById("<%= hftran1stcode.ClientID %>").value = tranCode;


            document.getElementById("<%= txtInvestorName.ClientID %>").value = investorName;
            document.getElementById("<%= txtAmount.ClientID %>").value = amount;
            document.getElementById("<%= ddlChequeNo.ClientID %>").value = "004";
            document.getElementById("<%= txtChequeSearch.ClientID %>").value = panno;
            document.getElementById("<%= txtRemarks.ClientID %>").value = remark;


            

            const registrarVal = (registrar === "C" && cobfl === "0") ? "c" :
                (registrar === "K" && cobfl === "0") ? "k" :
                    (registrar === "C" && cobfl === "1") ? "ccob" :
                        (registrar === "K" && cobfl === "1") ? "kcob" : "";

            const rblRegistrar = document.getElementById("<%= rblRegistrar.ClientID %>");
            if (rblRegistrar && registrarVal) {
                const rb = rblRegistrar.querySelector("input[value='" + registrarVal + "']");
                if (rb) rb.checked = true;
            }

            const recoVal = tranType.toLowerCase() === "reconciled" ? "reconciled-rta" : "unreconciled-rta";
            const rblReco = document.getElementById("<%= rblReconciliationType.ClientID %>");
            if (rblReco) {
                const rb = rblReco.querySelector("input[value='" + recoVal + "']");
                if (rb) rb.checked = true;
            }

            const sipVal = sipType.toLowerCase() === "regular" ? "regular" : "sip";
            const sipList = document.getElementById("<%= RadioButtonList1.ClientID %>");
            if (sipList) {
                const rb = sipList.querySelector("input[value='" + sipVal + "']");
                if (rb) rb.checked = true;
            }

            const ddlAmc = document.getElementById("<%= DropDownList1.ClientID %>");
            if (ddlAmc && ddlAmc.querySelector("option[value='" + amcCode + "']")) {
                ddlAmc.value = amcCode;
            } else if (ddlAmc) {
                ddlAmc.selectedIndex = 0;
            }


            const dateFrom = document.getElementById("<%= dateFromRta.ClientID %>");
            const dateTo = document.getElementById("<%= dateToRta.ClientID %>");

            if (/^\d{2}\/\d{2}\/\d{4}$/.test(tranDateStr)) {
                const [dd, mm, yyyy] = tranDateStr.split('/');
                const originalDate = new Date(`${yyyy}-${mm}-${dd}`);

                const before = new Date(originalDate);
                before.setMonth(before.getMonth() - 1);
                const after = new Date(originalDate);
                after.setMonth(after.getMonth() + 1);

                const format = (d) => ("0" + d.getDate()).slice(-2) + "/" + ("0" + (d.getMonth() + 1)).slice(-2) + "/" + d.getFullYear();

                dateFrom.value = format(before);
                dateTo.value = format(after);
            } else {
                dateFrom.value = "";
                dateTo.value = "";
            }

            return false; // prevent any postback
        }


        function clearFieldsOfRta() {
            document.getElementById("<%= txtInvestorName.ClientID %>").value = '';
            document.getElementById("<%= txtAmount.ClientID %>").value = '';
            document.getElementById("<%= ddlChequeNo.ClientID %>").selectedIndex = 0;
            document.getElementById("<%= txtChequeSearch.ClientID %>").value = '';
            document.getElementById("<%= dateFromRta.ClientID %>").value = '';
            document.getElementById("<%= dateToRta.ClientID %>").value = '';

            document.getElementById("<%= txtRemarks.ClientID %>").value = '';


        }

        // Rebind on every partial postback
        Sys.Application.add_load(function () {

            const checkboxes = document.querySelectorAll(".select-row-checkbox");
            checkboxes.forEach(cb => {
                cb.onclick = function () {
                    return onRowSelect(this);
                };
            });
            var selectedIndexch = document.getElementById("hfSelectedRow").value;
            if (selectedIndexch) {
                var gridch = document.getElementById("<%= GridTransaction.ClientID %>");
                var rowsch = gridch.getElementsByTagName("tr");

                // Highlight the previously selected row after the postback
                selectedIndexch = parseInt(selectedIndexch);

                // Ensure the selected row exists
                if (rowsch[selectedIndexch + 1]) { // Ensure row exists
                    rowsch[selectedIndexch + 1].classList.add("selected-row");
                }
            }
        });

    </script>

    <script type="text/javascript">
        function onGridRowClick(row) {
            var checkbox = row.querySelector('input[type="checkbox"]');

            debugger;

            if (checkbox) {
                checkbox.checked = !checkbox.checked; // Toggle checked status
            }

            var tran_code_value = checkbox.getAttribute("data-tran1");
            var tran_code_amount = checkbox.getAttribute("data-tran2");

            //alert("Row code: " + tran_code_value + ", amt: " + tran_code_amount);

            onRtaRowSelect(checkbox);

            //var cells = row.getElementsByTagName("td");
            //let rowData = [];
            //for (let i = 1; i < cells.length; i++) { // Skip checkbox (i=1)
            //    rowData.push(cells[i].innerText.trim());
            //}
            //alert("Row clicked: " + rowData.join(", "));
        }
    </script>

    <%-- 
        
          
            const getText = (id) => row.querySelector("[id*='" + id + "']")?.innerText.trim() || '';
            const getValue = (id) => row.querySelector("[id*='" + id + "']")?.value.trim() || '';


            //const tranCode = getValue("hfTranCode");
            //const tranDateStr = getText("lblTrnDate");

            const tran_code_value = getText("lblTranCode");
            const tran_code_amount = getText("lblemount");

--%>

    <%-- RTA ON ROW CLICK --%>
    <script type="text/javascript">
        let tranCoderta = "";
        let amrtaparsed = 0;

        function onRtaRowSelect(checkbox) {

            const row = checkbox.closest("tr");
            const grid = document.getElementById("<%= GridView1.ClientID %>");
            const rows = grid.getElementsByTagName("tr");

            for (let i = 1; i < rows.length; i++) {
                const chk = rows[i].querySelector("input[type='checkbox']");
                if (chk && chk !== checkbox) {
                    chk.checked = false;
                }
            }

            var tranCode1 = row.querySelector("[id*='lblTranCode']")?.innerText.trim() || '';;
            var amount1 = row.querySelector("[id*='lblemount']")?.innerText.trim() || '';

            for (var i = 1; i < rows.length; i++) {
                rows[i].classList.remove("selected-row-rta");
            }

            row.classList.add("selected-row-rta");

            // Step 2: Set values to hidden fields
            document.getElementById("<%= hfSelectedTranCode.ClientID %>").value = tranCode1;
            document.getElementById("<%= hfSelectedAmount.ClientID %>").value = amount1.replace(/,/g, '');



            // Step 3: Retrieve values from hidden fields
            var tranCode = document.getElementById("<%= hfSelectedTranCode.ClientID %>").value;
            var amount = document.getElementById("<%= hfSelectedAmount.ClientID %>").value;

            // Step 4: Show in alert
            //alert("Tran Code: " + tranCode + "\nAmount: " + amount);
   
        }
Sys.Application.add_load(function () {
            const checkboxes = document.querySelectorAll(".chk-rta");
            checkboxes.forEach(cb => {
                cb.onclick = function () {
                    return onRtaRowSelect(this);
                };
            });

            setTimeout(function () {
                var selectedIndexchrta = document.getElementById("hfrtaselectedrow").value;
                if (selectedIndexchrta) {
                    var gridchrta = document.getElementById("<%= GridView1.ClientID %>");
                    var rowschrta = gridchrta.getElementsByTagName("tr");

                    selectedIndexchrta = parseInt(selectedIndexchrta);

                    if (rowschrta[selectedIndexchrta + 1]) {
                        rowschrta[selectedIndexchrta + 1].classList.add("selected-row-rta");
                    }
                }
            }, 0);
        });

    </script>

      <%--  hfSelectedTranCode.Value
     document.getElementById("<%= hfSelectedTranCode.ClientID %>").value = tran_code_value;
     document.getElementById("<%= hfSelectedAmount.ClientID %>").value = tran_code_amount.replace(/,/g, '');--%>

   
    <%-- synchronize scrolling between the two grids --%>
    <script type="text/javascript">
        function syncScroll() {
            var grid1 = document.getElementById('gridContainer1');
            var grid2 = document.getElementById('gridContainer2');

            if (!grid1 || !grid2) return;

            grid1.addEventListener('scroll', function () {
                grid2.scrollLeft = grid1.scrollLeft;
            });

            grid2.addEventListener('scroll', function () {
                grid1.scrollLeft = grid2.scrollLeft;
            });


        }

        document.addEventListener('DOMContentLoaded', function () {
            syncScroll();

            if (typeof Sys !== "undefined" && Sys.WebForms && Sys.WebForms.PageRequestManager) {
                Sys.WebForms.PageRequestManager.getInstance().add_endRequest(function () {
                    syncScroll();
                });
            }
        });
    </script>

    
    <style>
        .invalid-date {
            border: 1px solid red !important;
        }

        .form-check-label {
            margin-left: 2px !important;
        }

        th{
            min-width:150px !important;
        }

        td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 150px !important;
        }

        #<%= GridTransaction.ClientID %> thead tr th {
            position: sticky !important;
            top: 0 !important;
            background-color: #B78939 !important;
            color: red !important;
            z-index: 1;
        }

        .ctm_hidden {
            display: none;
        }

        #<%= GridTransaction.ClientID %> th .resizer {
          position: absolute;
          width: 5px;
          top: 0;
          right: 0;
          cursor: col-resize;
          user-select: none;
          height: 100%;
        }

        #<%= GridTransaction.ClientID %> th {
          position: relative;
          overflow: hidden;
          min-width: 150px;
        }


    </style>


    <script src="/colResizable1.6.min.js"></script>




    <script>

        function btnExportTrData() {
            ExportTableToExcel_1('<%= GridTransaction.ClientID %>','TR');
        }

        function btnExportRtaData() {
            ExportTableToExcel_1('<%= GridView1.ClientID %>', 'RTA');
        }

        function ExportTableToExcel_1(tableId, datType) {
            alert("Excel Downloading started!");

            // Get the table element
            var table = document.getElementById(tableId);
            if (!table) {
                alert("Table not found!");
                return;
            }

            // Convert the table to a workbook
            var wb = XLSX.utils.table_to_book(table, { sheet: "Transactions" });

            // Generate and trigger download
            XLSX.writeFile(wb, datType+ "_Transaction_List.xlsx");

            alert("Excel Downloading completed!");
        }

        function makeTableColumnsResizable(tableId) {
            const t = document.getElementById(tableId);
            if (!t) {
                console.warn("makeTableColumnsResizable: table not found: " + tableId);
                return;
            }

         


            t.style.tableLayout = "fixed";
            Array.from(t.querySelectorAll("th")).forEach(th => {
                th.style.position = "relative";
                if (!th.dataset.hasResizer) {
                    const r = document.createElement("div");
                    r.className = "resizer";
                    r.style.cssText = "position:absolute;top:0;right:0;width:5px;cursor:col-resize;height:100%;z-index:1;";
                    th.appendChild(r);
                    let startX, startW;
                    r.addEventListener("mousedown", e => {
                        startX = e.pageX;
                        startW = th.offsetWidth;
                        const onMove = e2 => {
                            th.style.width = (startW + e2.pageX - startX) + "px";
                        };
                        const onUp = () => {
                            document.removeEventListener("mousemove", onMove);
                            document.removeEventListener("mouseup", onUp);
                        };
                        document.addEventListener("mousemove", onMove);
                        document.addEventListener("mouseup", onUp);
                        e.preventDefault();
                    });
                    th.dataset.hasResizer = "1";
                }
            });
        }


        function initializeRtaPage() {
            // Get the actual ClientIDs emitted by ASP.NET
            const channelTableId = '<%= GridTransaction.ClientID %>';  
            const rtaTableId = '<%= GridView1.ClientID %>';


            makeTableColumnsResizable(channelTableId);
            makeTableColumnsResizable(rtaTableId);

            // Add any more bindings here (e.g. row click, dropdown change etc.)
        }


        $(function () {

            initializeRtaPage();

            if (typeof Sys !== 'undefined' && Sys.WebForms
                && !Sys.WebForms.PageRequestManager.getInstance()._events['endRequest']) {
                Sys.WebForms.PageRequestManager.getInstance().add_endRequest(function () {
                    initializeRtaPage();
                });
            }
        });


    </script>

</asp:Content>

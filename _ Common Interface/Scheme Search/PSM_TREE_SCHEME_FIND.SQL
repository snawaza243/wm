CREATE OR REPLACE PROCEDURE WEALTHMAKER.PSM_TREE_SCHEME_FIND (
    P_LOGIN         IN VARCHAR2,
    P_ROLE          IN VARCHAR2,
    P_MODULE        IN VARCHAR2,
    P_SEARCH_TERM   IN VARCHAR2,
    P_RESULT_CURSOR OUT SYS_REFCURSOR
) AS
    V_FORMATTED_SEARCH VARCHAR2(4000);
    V_RESULT_COUNT NUMBER := 0;
BEGIN 
    V_FORMATTED_SEARCH := '%' || REPLACE(TRIM(UPPER(P_SEARCH_TERM)), ' ', '%') || '%';

    IF P_MODULE = 'MF_SCH1' THEN 
        OPEN P_RESULT_CURSOR FOR
            SELECT S.SCH_CODE, S.SCH_NAME, S.SHORT_NAME, 'MF' AS NAME, M.MUT_NAME
            FROM SCHEME_INFO S JOIN MUT_FUND M ON S.MUT_CODE = M.MUT_CODE
            WHERE (UPPER(MUT_NAME) || UPPER(SCH_NAME) || UPPER(MUT_NAME)) LIKE V_FORMATTED_SEARCH
            AND M.MUT_CODE NOT IN ('MF001', 'MF036', 'MF002', 'MF013', 'MF039', 'MF029', 'MF027', 'MF035', 'MF020')
            ORDER BY SCH_NAME, SHORT_NAME;
            
        SELECT COUNT(*) INTO V_RESULT_COUNT
        FROM SCHEME_INFO S
        JOIN MUT_FUND M ON S.MUT_CODE = M.MUT_CODE
        WHERE (UPPER(MUT_NAME) || UPPER(SCH_NAME) || UPPER(MUT_NAME)) LIKE V_FORMATTED_SEARCH
        AND M.MUT_CODE NOT IN ('MF001', 'MF036', 'MF002', 'MF013', 'MF039', 'MF029', 'MF027', 'MF035', 'MF020');

        IF V_RESULT_COUNT = 0 THEN 
            OPEN P_RESULT_CURSOR FOR
                SELECT O.OSCH_CODE AS SCH_CODE, O.OSCH_NAME AS SCH_NAME, O.LONGNAME AS SHORT_NAME, 'MF' AS NAME, ISS.ISS_NAME AS MUT_NAME
                FROM OTHER_PRODUCT O JOIN ISS_MASTER ISS ON ISS.ISS_CODE = O.ISS_CODE
                WHERE (UPPER(O.OSCH_NAME) || UPPER(O.LONGNAME)) LIKE V_FORMATTED_SEARCH AND O.PROD_CLASS_CODE IN ('DT046', 'DT020', 'DT027')
                ORDER BY O.OSCH_NAME;
        END IF;
    END IF;

END PSM_TREE_SCHEME_FIND;
/

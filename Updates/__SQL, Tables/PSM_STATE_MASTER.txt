CREATE OR REPLACE PROCEDURE PSM_STATE_MASTER(
    P_LOGIN     IN VARCHAR2,
    P_ROLE      IN VARCHAR2,
    P_COUNTRY   IN VARCHAR2 DEFAULT NULL,
    P_STATE     IN VARCHAR2 DEFAULT NULL,
    P_CURSOR    OUT SYS_REFCURSOR
)
AS
    V_HAS_ACCESS NUMBER := 0;
BEGIN

    /*  -- First verify user access rights
        SELECT COUNT(*) INTO V_HAS_ACCESS
        FROM USER_ACCESS_TABLE -- Replace with your actual access control table
        WHERE USER_ID = P_LOGIN
        AND ROLE_ID = P_ROLE
        AND MODULE_ID = 'STATE_MASTER'; -- Or appropriate module identifier
         
        IF V_HAS_ACCESS = 0 THEN
            RAISE_APPLICATION_ERROR(-20001, 'Access denied for user ' || P_LOGIN || ' with role ' || P_ROLE);
        END IF;
        */
       
 -- Open cursor with filtered state data
    OPEN P_CURSOR FOR
        SELECT 
            SM.STATE_ID,
            SM.STATE_NAME,
            CN.COUNTRY_ID,
            CN.COUNTRY_NAME
        FROM 
            STATE_MASTER SM
            JOIN COUNTRY_MASTER CN ON SM.COUNTRY_ID = CN.COUNTRY_ID
        WHERE
            (P_COUNTRY IS NULL OR CN.COUNTRY_ID = P_COUNTRY)
            AND (P_STATE IS NULL OR SM.STATE_ID = P_STATE)
        ORDER BY 
            CN.COUNTRY_NAME, 
            SM.STATE_NAME;
EXCEPTION
    WHEN OTHERS THEN
        -- Log error details (consider adding error logging table)
        RAISE_APPLICATION_ERROR(-20002, 'Error in PSM_STATE_MASTER: ' || SQLERRM);
END PSM_STATE_MASTER;
/
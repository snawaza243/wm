CREATE OR REPLACE PROCEDURE WEALTHMAKER.PSM_MF_RECO_MANUAL_TR1 (
    p_Channel               IN BRANCH_MASTER.BRANCH_TAR_CAT%TYPE,
    P_REGION                IN BRANCH_MASTER.REGION_ID%TYPE,
    P_ZONE                  IN BRANCH_MASTER.ZONE_ID%TYPE,
    P_BRANCH                IN BRANCH_MASTER.BRANCH_CODE%TYPE,
    P_RM                    IN TRANSACTION_MF_TEMP1.RMCODE%TYPE,
    P_FROMDATE              IN TRANSACTION_MF_TEMP1.TR_DATE%TYPE,
    P_TODATE                IN TRANSACTION_MF_TEMP1.TR_DATE%TYPE,
    P_AMC                   IN TRANSACTION_MF_TEMP1.MUT_CODE%TYPE,
    P_AR                    IN TRANSACTION_MF_TEMP1.TRAN_CODE%TYPE,
    P_RECONCILIATIONSTATUS  IN CHAR,
    P_COB                   IN CHAR,
    P_ARNO                  IN TRANSACTION_MF_TEMP1.TRAN_CODE%TYPE,
    P_TRANTYPE              IN TRANSACTION_MF_TEMP1.TRAN_TYPE%TYPE,
    P_REGISTRAR             IN VARCHAR2,
    P_LOG_ID                IN VARCHAR2,
    P_ROLE_ID               IN VARCHAR2,
    P_CURSOR                OUT SYS_REFCURSOR
) AS
    V_QUERY         VARCHAR2(4000);
    V_REG           VARCHAR2(30);
    V_BRANCH_CAT    VARCHAR2(30) :=NULL;
    V_SRM_CODE      VARCHAR2(30) :=NULL;
BEGIN
    -- Start building the query
    V_QUERY := 'SELECT INV.INVESTOR_NAME,INV.ADDRESS1||'',''||INV.ADDRESS2||'',''||INV.PHONE||'',''||INV.EMAIL ADDRESS1 ,CT.CITY_NAME, 
    E.RM_CODE RMCODE, MF.FLAG, MF.BROKER_ID, MF.SIP_AMOUNT, MF.REMARK REMARK_RECO, NULL REGISTRAR, MF.COB_FLAG COB_FLAG,
    MF.BANK_NAME,MF.CLIENT_CODE,MF.SCH_CODE SCH_CODE,MF.MUT_CODE,RM_NAME,BRANCH_NAME,PANNO,AMC.MUT_NAME MUT_NAME,SCH_NAME SCH_NAME,
    TR_DATE,TRAN_TYPE,APP_NO,FOLIO_NO,PAYMENT_MODE, CHEQUE_NO, CHEQUE_DATE,
    AMOUNT,SIP_TYPE,LEAD_NO,LEAD_NAME,TRAN_CODE,B.BRANCH_CODE,BUSINESS_RMCODE,MF.TRAN_TYPE TRAN_TYPE, MF.SIP_TYPE SIP_TYPE, 
    CASE WHEN  MF.LOGGEDUSERID=''MFONLINE'' THEN ''ONLINE'' WHEN  MF.LOGGEDUSERID=''VALUEFY'' THEN ''ONLINE'' ELSE ''OFFLINE'' END LOGGEDUSERID 
    FROM CITY_MASTER CT,EMPLOYEE_MASTER E,INVESTOR_MASTER INV,BRANCH_MASTER B,ALLCOMPANY AMC,ALLSCHEME SCH,TRANSACTION_MF_TEMP1 MF 
    WHERE  MF.MOVE_FLAG1 IS NULL AND MF.SIP_ID IS  NULL AND TRAN_TYPE NOT IN(''REVERTAL'') AND (MF.ASA<>''C'' OR MF.ASA IS NULL) AND INV.CITY_ID=CT.CITY_ID(+) 
    AND MF.CLIENT_CODE=INV.INV_CODE AND  TO_CHAR(MF.BUSINESS_RMCODE)=TO_CHAR(E.PAYROLL_ID) AND MF.BUSI_BRANCH_CODE=B.BRANCH_CODE';

    IF P_BRANCH IS NOT NULL THEN
        V_QUERY := V_QUERY || '  AND MF.MUT_CODE=AMC.MUT_CODE AND MF.SCH_CODE=SCH.SCH_CODE AND B.BRANCH_CODE IN (''' || P_BRANCH || ''') ';
    ELSE
        V_QUERY := V_QUERY || ' AND MF.MUT_CODE=AMC.MUT_CODE AND MF.SCH_CODE=SCH.SCH_CODE AND B.BRANCH_CODE IN (SELECT BRANCH_ID FROM USERDETAILS_JI WHERE LOGIN_ID='''||P_LOG_ID||''' AND ROLE_ID='''||P_ROLE_ID||''') ';
    END IF;

    IF p_Channel IS NOT NULL THEN
        V_QUERY := V_QUERY || ' AND B.BRANCH_TAR_CAT  = ''' || p_Channel || '''';
    END IF;

    IF P_REGION IS NOT NULL THEN
        V_QUERY := V_QUERY || ' AND B.REGION_ID = ''' || P_REGION || '''';
    END IF;

    IF P_ZONE IS NOT NULL THEN
        V_QUERY := V_QUERY || ' AND B.ZONE_ID = ''' || P_ZONE || '''';
    END IF;
    
    IF P_RM IS NOT NULL THEN
        V_QUERY := V_QUERY || ' AND  E.PAYROLL_ID = ''' || P_RM || '''';
    END IF;

    IF V_SRM_CODE IS NOT NULL THEN
        V_QUERY := V_QUERY || ' AND  E.RM_CODE = ''' || V_SRM_CODE || '''';
    END IF;

    IF P_AR IS NOT NULL THEN
        V_QUERY := V_QUERY || 'AND MF.TRAN_CODE= ''' || P_AR || '''';
    END IF;

    IF P_TRANTYPE IS NOT NULL THEN
        IF UPPER(P_TRANTYPE) = 'REGULAR' THEN
            V_QUERY := V_QUERY || ' AND (MF.SIP_TYPE=''REGULAR'' OR MF.SIP_TYPE IS NULL OR MF.SIP_TYPE =''STP'') ';
        ELSIF UPPER(P_TRANTYPE) = 'SIP' THEN
            V_QUERY := V_QUERY || ' AND (MF.DISPATCH=''N'') ';
        ELSIF UPPER(P_TRANTYPE) = 'PMS' THEN
            V_QUERY := V_QUERY || '  AND ((SCH.PRD=''DT027'')) ';
        ELSIF UPPER(P_TRANTYPE) = 'ATM' THEN
            V_QUERY := V_QUERY || ' AND NVL(ATM_FLAG,''0'')=''1''  ';
        ELSIF UPPER(P_TRANTYPE) = 'TRAIL' THEN
            V_QUERY := V_QUERY || ' AND GET_SCHEME_NATURE_TRAIL_NEW(MF.SCH_CODE,MF.TR_DATE)=''T'' AND PMS_IDENTIFY(TRAN_CODE)=''0''';
        END IF;
    END IF;

    IF P_AMC IS NOT NULL THEN
        V_QUERY := V_QUERY || ' AND MF.MUT_CODE = ''' || P_AMC || '''';
    END IF;

    IF P_RECONCILIATIONSTATUS IS NOT NULL THEN
        IF UPPER(P_RECONCILIATIONSTATUS) = 'Y' THEN
            V_QUERY := V_QUERY || ' AND MF.REC_FLAG=''Y''';

        ELSIF UPPER(P_RECONCILIATIONSTATUS) = 'N' THEN
            V_QUERY := V_QUERY || '  AND (MF.REC_FLAG =''N'' OR MF.REC_FLAG IS NULL)';
        
        ELSIF UPPER(P_RECONCILIATIONSTATUS) = 'P' THEN
            V_QUERY := V_QUERY || ' AND (MF.REC_FLAG =''N'' OR MF.REC_FLAG IS NULL) AND (PROCESSED IS NOT NULL OR REMARK_RECO=''REC0015'')';
        END IF;
    END IF;

    IF P_COB = '1' THEN
        V_QUERY := V_QUERY || ' AND MF.COB_FLAG = ''1''';
    END IF; 

    IF P_AR IS NULL THEN
        IF P_FROMDATE IS NOT NULL THEN
            V_QUERY := V_QUERY || ' AND TR_DATE>=TO_DATE(''' || TO_CHAR(P_FROMDATE, 'DD-MM-YYYY') || ''', ''DD-MM-YYYY'')';
        END IF;

        IF P_TODATE IS NOT NULL THEN
            V_QUERY := V_QUERY || ' AND TR_DATE<=TO_DATE(''' || TO_CHAR(P_TODATE, 'DD-MM-YYYY') || ''', ''DD-MM-YYYY'')';
        END IF;
    END IF;
    
    V_QUERY := V_QUERY || ' ORDER BY TR_DATE';
 
    OPEN P_CURSOR FOR V_QUERY;
    --OPEN P_CURSOR FOR SELECT V_QUERY FROM DUAL;
END PSM_MF_RECO_MANUAL_TR1;
/

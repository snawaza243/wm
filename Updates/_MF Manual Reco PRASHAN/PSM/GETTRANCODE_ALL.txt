CREATE OR REPLACE FUNCTION WEALTHMAKER.GETTRANCODE_ALL(PFOLIO_NO VARCHAR2,PSCH_CODE VARCHAR2,PTR_DATE DATE,PTRAN_TYPE VARCHAR,PTRAN_ID VARCHAR2,PUNQ_KEY VARCHAR2,PFLAG VARCHAR2) RETURN CLOB
IS
FINALTRANCODE   CLOB;
TRANCODE        TRANSACTION_ST.TRAN_CODE%TYPE;
MYRS    SYS_REFCURSOR;
BEGIN
    FINALTRANCODE:=NULL;
    
    IF PFLAG='CAMS' THEN
        BEGIN
            OPEN MYRS FOR  
                SELECT TRAN_CODE FROM TRANSACTION_ST@MF.BAJAJCAPITAL WHERE FOLIO_NO=PFOLIO_NO AND SCH_CODE=PSCH_CODE AND
                TR_DATE=TO_DATE(PTR_DATE) AND TRAN_TYPE=PTRAN_TYPE AND TRAN_TYPE IN ('PURCHASE', 'REINVESTMENT', 'SWITCH IN') 
                AND (DUP_FLAG2 = 0 OR (REG_TRAN_TYPE='TICOB' AND DUP_FLAG2 IN(0,9))) AND TRAN_ID=PTRAN_ID;
            FETCH MYRS INTO TRANCODE;    
            WHILE MYRS%FOUND 
            LOOP
               
                IF FINALTRANCODE IS NOT NULL THEN
                   FINALTRANCODE:=FINALTRANCODE||','||''''|| TRANCODE ||'''';
                ELSE
                    FINALTRANCODE:=''''|| TRANCODE||'''';    
                END IF;    
                DBMS_OUTPUT.PUT_LINE('FINALTRANCODE'||FINALTRANCODE);
                FETCH MYRS INTO TRANCODE;   
            END LOOP;
            CLOSE MYRS;
        EXCEPTION WHEN NO_DATA_FOUND THEN
           FINALTRANCODE:=NULL;
        END;         
    ELSIF PFLAG='KARVY' THEN
        BEGIN
            OPEN MYRS FOR  
                SELECT TRAN_CODE FROM TRANSACTION_ST@MF.BAJAJCAPITAL WHERE FOLIO_NO=PFOLIO_NO AND SCH_CODE=PSCH_CODE AND
                TR_DATE=TO_DATE(PTR_DATE) AND TRAN_TYPE=PTRAN_TYPE AND TRAN_TYPE IN ('PURCHASE', 'REINVESTMENT', 'SWITCH IN') 
                AND (DUP_FLAG2 = 0 OR (REG_TRAN_TYPE='TICOB' AND DUP_FLAG2 IN(0,9)));
            FETCH MYRS INTO TRANCODE;    
            WHILE MYRS%FOUND 
            LOOP
               
                IF FINALTRANCODE IS NOT NULL THEN
                   FINALTRANCODE:=FINALTRANCODE||','||''''|| TRANCODE ||'''';
                ELSE
                    FINALTRANCODE:=''''|| TRANCODE||'''';    
                END IF;    
                DBMS_OUTPUT.PUT_LINE('FINALTRANCODE'||FINALTRANCODE);
                FETCH MYRS INTO TRANCODE;   
            END LOOP;
            CLOSE MYRS;
        EXCEPTION WHEN NO_DATA_FOUND THEN
           FINALTRANCODE:=NULL;
        END; 
    ELSIF PFLAG='KARVY COB' THEN
        BEGIN
            OPEN MYRS FOR  
                SELECT TRAN_CODE FROM TRANSACTION_ST@MF.BAJAJCAPITAL WHERE FOLIO_NO=PFOLIO_NO AND SCH_CODE=PSCH_CODE  
                AND TRAN_TYPE=PTRAN_TYPE AND TRAN_TYPE IN ('PURCHASE', 'REINVESTMENT', 'SWITCH IN') 
                AND (DUP_FLAG2 = 0 OR (REG_TRAN_TYPE='TICOB' AND DUP_FLAG2 IN(0,9))) AND UNQ_KEY=PUNQ_KEY;
            FETCH MYRS INTO TRANCODE;    
            WHILE MYRS%FOUND 
            LOOP
               
                IF FINALTRANCODE IS NOT NULL THEN
                   FINALTRANCODE:=FINALTRANCODE||','||''''|| TRANCODE ||'''';
                ELSE
                    FINALTRANCODE:=''''|| TRANCODE||'''';    
                END IF;    
                DBMS_OUTPUT.PUT_LINE('FINALTRANCODE'||FINALTRANCODE);
                FETCH MYRS INTO TRANCODE;   
            END LOOP;
        EXCEPTION WHEN NO_DATA_FOUND THEN
           FINALTRANCODE:=NULL;
        END;             
    END IF;           
    RETURN FINALTRANCODE;
END;
/
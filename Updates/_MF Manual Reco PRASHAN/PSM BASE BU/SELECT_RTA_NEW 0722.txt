-- manual rta select query
-- KVARVY
SELECT TMF.TRAN_CODE, TMF.INV_NAME, TMF.UNQ_KEY, TMF.SCH_CODE, SI.SCH_NAME, TMF.MUT_CODE, AI.MUT_NAME, TMF.TRAN_TYPE, TMF.APP_NO, 
TMF.APP_DATE, TMF.CHEQUE_NO, TMF.CHEQUE_DATE, TMF.AMOUNT, TMF.BANK_NAME, TMF.FOLIO_NO, TMF.RMCODE, LI.RM_NAME, TMF.INVESTOR_TYPE, 
TMF.BRANCH_CODE, TI.BRANCH_NAME, TMF.TR_DATE, TMF.UNITS, TMF.NAV_DATE, TMF.REMARK, TMF.FLAG, TMF.BROKER_ID, TMF.REG_TRANTYPE, 
PI.EXIST_CODE, SUBSTR(I.ADDRESS1,1,10) AS ADDRESS1, TMF.BUSINESS_RMCODE, C.CITY_NAME, 
WEALTHMAKER.GETTRANCODE_ALL(TMF.FOLIO_NO,TMF.SCH_CODE,TMF.TR_DATE,TMF.TRAN_TYPE,MAX(TMF.TRAN_ID),MAX(TMF.UNQ_KEY),'KARVY') UNIQUE_TRAN, 
MAX(REG_TRANTYPE) REG_TRANTYPE,MAX(UNQ_KEY) UNQ_KEY  
FROM TRANSACTION_ST@MF.BAJAJCAPITAL TMF
LEFT JOIN SCHEME_INFO SI ON TMF.SCH_CODE = SI.SCH_CODE
LEFT JOIN MUT_FUND AI ON TMF.MUT_CODE = AI.MUT_CODE
LEFT JOIN BRANCH_MASTER TI ON TMF.BRANCH_CODE = TI.BRANCH_CODE
LEFT JOIN EMPLOYEE_MASTER LI ON TMF.RMCODE = LI.RM_CODE
LEFT JOIN AGENT_MASTER PI ON TMF.SOURCE_CODE = PI.AGENT_CODE
LEFT JOIN INVESTOR_MASTER I ON TMF.CLIENT_CODE = I.INV_CODE
LEFT JOIN CITY_MASTER C ON I.CITY_ID = C.CITY_ID 
WHERE 1 = 1 AND (DUP_FLAG2 = 0 OR (REG_TRAN_FLAG='TI' AND DUP_FLAG2 IN(0,9)))  AND 
TMF.BRANCH_CODE IN (SELECT BRANCH_ID FROM USERDETAILS_JI WHERE LOGIN_ID='112650' AND ROLE_ID='29')  
AND TO_CHAR(TMF.MUT_CODE) = 'MF025' AND (TMF.REC_FLAG ='N' OR TMF.REC_FLAG IS NULL) AND UPPER(TMF.REG_TRANTYPE) NOT LIKE '%SYS%' 
   AND UPPER(TMF.REG_TRANTYPE) NOT LIKE '%SIP%' 
   AND TRIM(UPPER(TMF.REG_TRANTYPE)) NOT LIKE '%S T P IN%' 
   AND TRIM(UPPER(TMF.REG_TRANTYPE)) NOT LIKE '%S T P IN REJ%' 
   AND TRIM(UPPER(TMF.REG_TRANTYPE)) NOT LIKE '%S T P IN REJ REVERSAL%' 
   AND TRIM(UPPER(TMF.REG_TRANTYPE)) NOT LIKE '%STP SWITCH IN%' 
   AND TRIM(UPPER(TMF.REG_TRANTYPE)) NOT LIKE '%OUT%'
   AND TRIM(UPPER(TMF.REG_TRANTYPE)) NOT LIKE '%REINVESTMENT%'
   AND TRIM(UPPER(TMF.REG_TRANTYPE)) NOT LIKE '%STPI%' 
   AND TRIM(UPPER(TMF.REG_TRANTYPE)) NOT LIKE '%STPIR%'
   AND TRIM(UPPER(TMF.REG_TRANTYPE)) NOT LIKE '%REDEMPTION%'
   AND TRIM(UPPER(TMF.REG_TRANTYPE)) NOT LIKE '%PRE-REJECTION%' 
   AND ( TMF.PAN1 = 'BHDPS1247N') AND LPAD(TMF.MUT_CODE, 2) = 'MF'  
   AND (TMF.ASA <> 'C' OR TMF.ASA IS NULL) 
   AND TMF.TRAN_TYPE IN ('PURCHASE', 'REINVESTMENT', 'SWITCH IN')  
   ORDER BY TMF.TR_DATE GROUP BY TMF.FOLIO_NO, TMF.SCH_CODE, TMF.TR_DATE, TMF.TRAN_TYPE
   


-- KCOB 

SELECT tmf.TRAN_CODE, tmf.INV_NAME, tmf.UNQ_KEY, tmf.SCH_CODE, si.SCH_NAME, tmf.MUT_CODE, ai.MUT_NAME, tmf.TRAN_TYPE, tmf.APP_NO,
tmf.APP_DATE, tmf.CHEQUE_NO, tmf.CHEQUE_DATE,  WEALTHMAKER.FN_GET_COB_CMV@MF.BAJAJCAPITAL(tmf.FOLIO_NO,tmf.SCH_CODE) amount, 
tmf.BANK_NAME, tmf.FOLIO_NO, tmf.RMCODE, li.RM_NAME, tmf.INVESTOR_TYPE, tmf.BRANCH_CODE, ti.BRANCH_NAME, tmf.TR_DATE, tmf.UNITS,
tmf.NAV_DATE, tmf.REMARK, tmf.FLAG, tmf.BROKER_ID, tmf.REG_TRANTYPE, pi.EXIST_CODE, substr(i.ADDRESS1,1,10) as ADDRESS1, 
tmf.BUSINESS_RMCODE, c.CITY_NAME,  WEALTHMAKER.GETTRANCODE_ALL(tmf.FOLIO_NO,tmf.SCH_CODE,MAX(tmf.TR_DATE),tmf.TRAN_TYPE,MAX(tmf.TRAN_ID),tmf.UNQ_KEY,'KARVY COB') UNIQUE_TRAN,  
MAX(REG_TRANTYPE) REG_TRANTYPE,max(unq_key) unq_key  
FROM transaction_st@MF.BAJAJCAPITAL tmf
LEFT JOIN scheme_info si ON tmf.SCH_CODE = si.SCH_CODE
LEFT JOIN MUT_FUND ai ON tmf.MUT_CODE = ai.MUT_CODE
LEFT JOIN BRANCH_MASTER ti ON tmf.BRANCH_CODE = ti.BRANCH_CODE
LEFT JOIN EMPLOYEE_MASTER li ON tmf.RMCODE = li.RM_CODE
LEFT JOIN AGENT_MASTER pi ON tmf.source_code = pi.agent_code
LEFT JOIN INVESTOR_MASTER i ON tmf.CLIENT_CODE = i.INV_CODE
LEFT JOIN CITY_MASTER c ON i.CITY_ID = c.CITY_ID 
WHERE 1 = 1 AND tmf.BRANCH_CODE IN (SELECT BRANCH_ID FROM USERDETAILS_JI WHERE LOGIN_ID='112650' AND ROLE_ID='29')  AND TO_CHAR(tmf.MUT_CODE) = 'MF030' AND (tmf.rec_flag ='N' or tmf.rec_flag is null) AND UPPER(tmf.REG_TRANTYPE) NOT LIKE '%SYS%' 
   AND UPPER(tmf.REG_TRANTYPE) NOT LIKE '%SIP%' 
   AND TRIM(UPPER(tmf.REG_TRANTYPE)) NOT LIKE '%S T P IN%' 
   AND TRIM(UPPER(tmf.REG_TRANTYPE)) NOT LIKE '%S T P IN REJ%' 
   AND TRIM(UPPER(tmf.REG_TRANTYPE)) NOT LIKE '%S T P IN REJ REVERSAL%' 
   AND TRIM(UPPER(tmf.REG_TRANTYPE)) NOT LIKE '%STP SWITCH IN%' 
   AND TRIM(UPPER(tmf.REG_TRANTYPE)) NOT LIKE '%OUT%'
   AND TRIM(UPPER(tmf.REG_TRANTYPE)) NOT LIKE '%REINVESTMENT%'
   AND TRIM(UPPER(tmf.REG_TRANTYPE)) NOT LIKE '%STPI%' 
   AND TRIM(UPPER(tmf.REG_TRANTYPE)) NOT LIKE '%STPIR%'
   AND TRIM(UPPER(tmf.REG_TRANTYPE)) NOT LIKE '%REDEMPTION%'
   AND TRIM(UPPER(tmf.REG_TRANTYPE)) NOT LIKE '%PRE-REJECTION%' AND ( tmf.PAN1 = 'AAEPA3802G') AND UPPER(tmf.INV_NAME) LIKE '%AIKAKATH%VASU%PRADEEP%RAJ%' AND abs(round(tmf.amount)) = 1000000 AND LPAD(tmf.mut_code, 2) = 'MF'  AND (tmf.asa <> 'C' OR tmf.asa IS NULL) AND tmf.tran_type IN ('PURCHASE', 'REINVESTMENT', 'SWITCH IN')  ORDER BY tmf.TR_DATE GROUP BY TMF.FOLIO_NO, tmf.SCH_CODE, TMF.TRAN_TYPE, TMF.UNQ_KEY
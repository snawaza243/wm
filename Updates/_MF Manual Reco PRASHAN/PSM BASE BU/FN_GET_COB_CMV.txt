CREATE OR REPLACE FUNCTION WEALTHMAKER.FN_GET_COB_CMV(PFOLIO_NO VARCHAR2,PSCH_CODE VARCHAR2) RETURN NUMBER IS
VNAV_RS     WEALTHMAKER.NAV_REC.NAV_RS%TYPE;
VBAL_UNIT   NUMBER(20,3);
VCMV        NUMBER(20,2);    
BEGIN
    BEGIN
        SELECT NAV_RS INTO VNAV_RS fROM WEALTHMAKER.NAV_REC WHERE SCH_CODE=PSCH_CODE AND "Date"=WEALTHMAKER.FN_GET_COB_DATE(PFOLIO_NO,PSCH_CODE);
    EXCEPTION WHEN NO_DATA_FOUND THEN
        BEGIN
            SELECT NAV_RS INTO VNAV_RS fROM WEALTHMAKER.NAV_REC WHERE SCH_CODE=PSCH_CODE AND "Date"=WEALTHMAKER.FN_GET_COB_DATE(PFOLIO_NO,PSCH_CODE)+1;
        EXCEPTION WHEN NO_DATA_FOUND THEN
            SELECT NAV_RS INTO VNAV_RS fROM WEALTHMAKER.NAV_REC WHERE SCH_CODE=PSCH_CODE AND "Date"=WEALTHMAKER.FN_GET_COB_DATE(PFOLIO_NO,PSCH_CODE)+2;
        END;        
    END;
    
    BEGIN
        VBAL_UNIT:=WEALTHMAKER.FN_GET_COB_BALANCE_UNIT(PFOLIO_NO,PSCH_CODE);
        VCMV:=VNAV_RS*VBAL_UNIT;
    EXCEPTION WHEN OTHERS THEN
        VCMV:=0;
    END;            
    RETURN VCMV;
END;
/
<%@ Page Title="SIP Master Reconciliation 2" Language="C#" MasterPageFile="~/vmSite.Master" AutoEventWireup="true" CodeBehind="sip_master_reconciliation.aspx.cs" Inherits="WM.Masters.sip_master_reconciliation" MaintainScrollPositionOnPostback="false" %>


<asp:Content ID="Content1" ContentPlaceHolderID="ContentPlaceHolder1" runat="server">
    <link href="../assets/css/mf_ar_recon.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Add these to your head section -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

    <script>
        // Initialize Toastr with your preferred settings
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };

    </script>


    <style>
        .invalid-date {
            border: 1px solid red !important;
        }

        .form-check-label {
            margin-left: 2px !important;
        }

        td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 150px;
        }

        #transactionTable tbody tr.row-selected > td, 
        #rtaGrid tbody tr.row-selected > td,
        #sipGrid tbody tr.row-selected > td{
            background-color: lightblue !important;
        }

        #transactionTable thead tr th, #rtaGrid thead tr th {
            position: sticky !important;
            top: 0 !important;
            background-color: #B78939 !important;
            color: white !important;
            z-index: 1;
        }

        /* #transactionTable thead tr th, #transactionTable tbody tr td , #rtaGrid thead tr th, #rtaGrid tbody tr td{
            width:300px !important;
        }*/


        .ctm_hidden {
            display: none;
        }
    </style>

    <script>
        $(document).ready(function () {

            //#region ---------- HELPING FUNCTION: VALIDATION ONLOAD, AND LOADER ----------

            function checkUserSession() {
                const loginId = $('#' + '<%= hdnLoginId.ClientID %>').val();
                const roleId = $('#' + '<%= hdnRoleId.ClientID %>').val();

                if (!loginId || !roleId) {
                    alert("Session expired or invalid. Please Login");
                    window.location.href = 'https://www.wealthmaker.in/login_new.aspx';
                }
            }

            function showLoader() {
                if ($('#customLoader').length) {
                    $('#customLoader').show();
                    return;
                }

                const loaderHtml = `
    <div id="customLoader" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;">
        <div style="
            background-color: white;
            color: black;
            padding: 20px 30px;
            width: 250px;
            text-align: center;
            border-radius: 5px;
            font-weight: bold;
            font-size: 16px;">
            Please wait...
        </div>
    </div>
`;
                $('body').append(loaderHtml);
            }

            function hideLoader() {
                $('#customLoader').fadeOut(300, function () {
                    $(this).remove(); // Optional: remove from DOM
                });
            }

            function syncScroll() {
                var grid1 = document.getElementById('transactionContainer1');
                var grid2 = document.getElementById('transactionContainer2');

                if (!grid1 || !grid2) return;

                grid1.addEventListener('scroll', function () {
                    grid2.scrollLeft = grid1.scrollLeft;
                });

                grid2.addEventListener('scroll', function () {
                    grid1.scrollLeft = grid2.scrollLeft;
                });


            }

            function setCurrentDateToInput(inputId) {
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                const year = now.getFullYear();

                const formattedDate = `${day}/${month}/${year}`;
                $('#' + inputId).val(formattedDate);
            }


            function formatDateToDMY(dateStr) {
                if (!dateStr) return '';

                const date = new Date(dateStr);

                if (isNaN(date.getTime())) return '';

                const day = ('0' + date.getDate()).slice(-2);
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const year = date.getFullYear();

                return `${day}/${month}/${year}`;
            }

            function enableAutoDateFormat(inputId) {
                const $input = $("#" + inputId);


                // Auto-format on input
                $input.on("input", function () {
                    let val = $(this).val().replace(/\D/g, ""); // Only digits
                    if (val.length > 8) val = val.slice(0, 8);

                    let formatted = val;
                    if (val.length > 4) {
                        formatted = val.slice(0, 2) + '/' + val.slice(2, 4) + '/' + val.slice(4);
                    } else if (val.length > 2) {
                        formatted = val.slice(0, 2) + '/' + val.slice(2);
                    }

                    $(this).val(formatted);
                });

                // Validate on blur
                $input.on("blur", function () {
                    let val = $(this).val();

                    if (val === "") {
                        // Empty is allowed ‚Üí reset any invalid styling
                        $(this).removeClass('invalid-date');
                        return;
                    }

                    if (!isValidDate(val)) {
                        //$(this).val(''); // Clear invalid input
                        $(this).addClass('invalid-date'); // Add red border via CSS class
                    } else {
                        $(this).removeClass('invalid-date'); // Remove red border if valid
                    }
                });

                // Helper function: validate dd/mm/yyyy format and actual date
                function isValidDate(dateStr) {
                    const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
                    const match = dateStr.match(regex);
                    if (!match) return false;

                    const day = parseInt(match[1], 10);
                    const month = parseInt(match[2], 10) - 1; // JS months: 0‚Äì11
                    const year = parseInt(match[3], 10);

                    const date = new Date(year, month, day);
                    return (
                        date.getFullYear() === year &&
                        date.getMonth() === month &&
                        date.getDate() === day
                    );
                }
            }

            function clearDropdown(dropdownId) {
                $("#" + dropdownId).empty();
            }

            function makeTableColumnsResizable(tableId) {
                // Check if CSS for this tableId already exists
                if (!document.getElementById("resizableTableStyles_" + tableId)) {
                    const css = `
          #${tableId} {
              table-layout: fixed;
              width: 100%;
          }

          #${tableId} th {
              width: 150px;
              position: relative;
              overflow: hidden;
          }

          #${tableId} .resizer {
              position: absolute;
              right: 0;
              top: 0;
              width: 5px;
              height: 100%;
              cursor: col-resize;
              user-select: none;
              z-index: 1;
          }

          #${tableId} th:hover .resizer {
              background-color: rgba(0, 0, 0, 0.1);
          }
      `;

                    const style = document.createElement("style");
                    style.id = "resizableTableStyles_" + tableId;
                    style.innerHTML = css;
                    document.head.appendChild(style);
                }

                const table = document.getElementById(tableId);
                const ths = table.querySelectorAll("th");

                ths.forEach(th => {
                    if (!th.style.width) {
                        th.style.width = th.offsetWidth + "px";
                    }

                    const resizer = document.createElement("div");
                    resizer.classList.add("resizer");
                    th.appendChild(resizer);

                    let startX, startWidth;

                    resizer.addEventListener("mousedown", function (e) {
                        startX = e.pageX;
                        startWidth = th.offsetWidth;

                        function onMouseMove(e) {
                            const newWidth = startWidth + (e.pageX - startX);
                            th.style.width = newWidth + "px";
                        }

                        function onMouseUp() {
                            document.removeEventListener("mousemove", onMouseMove);
                            document.removeEventListener("mouseup", onMouseUp);
                        }

                        document.addEventListener("mousemove", onMouseMove);
                        document.addEventListener("mouseup", onMouseUp);

                        e.preventDefault();
                    });
                });
            }

            function RedirectToWelcomePage() {
                const loginId = $("#<%= hdnLoginId.ClientID %>").val();
                const roleId = $("#<%= hdnRoleId.ClientID %>").val();
                const encodedLoginId = encodeURIComponent(loginId);
                const encodedRoleId = encodeURIComponent(roleId);
                const url = `/welcome?loginid=${encodedLoginId}&roleid=${encodedRoleId}`;
                window.location.href = url; // Uncomment to redirect
            }

            function ExportTableToExcel_1(tableId, filePrefix) {
                try {
                    const $table = $(`#${tableId}`);
                    const rowCount = $table.find('tbody tr').length;

                    if (rowCount === 0 || $table.find('tbody tr:visible').length === 0) {
                        alert(`‚ö†Ô∏è No data available in the table to export.`);
                        return;
                    }
                    const tableElem = document.getElementById(tableId);
                    const wb = XLSX.utils.table_to_book(tableElem, { sheet: "Transactions" });
                    const fileName = `${filePrefix}_Transaction_List.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    alert(`‚úÖ Excel file "${fileName}" has been downloaded successfully.`);
                } catch (error) {
                    alert(`‚ùå Error during export: ${error.message}`);
                }
            }


            //#endregion ---------- HELPING: ONLOAD ----------

            //#region ---------- HELPING FUNCTION: DDL DATA LOAD AJAX ----------

            function loadChannelList() {
                //alert('channel list');

                $.ajax({
                    type: "POST",
                    url: "/masters/sip_master_reconciliation.aspx/GetChannelList",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    beforeSend: function () {
                        //showLoader();
                    },

                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let optionsHtml = data.map(r => `<option value="${r.value}">${r.text}</option>`);
                        $("#ddlChannel").html(optionsHtml.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("Failed to load channel list: " + error);
                    },
                    complete: function () {
                        //hideLoader();
                    }

                });
            }

            function loadRegionList() {
                //alert(' region list');

                $.ajax({
                    type: "POST",
                    url: "/masters/sip_master_reconciliation.aspx/GetRegionList",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify({}), // Required for WebMethod, even if no params
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let optionsHtml = data.map(r => `<option value="${r.value}">${r.text}</option>`);
                        $("#ddlRegion").html(optionsHtml.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading region list: " + xhr.responseText);
                    }
                });
            }

            function loadBranchList() {
                //alert(' branch list');

                $.ajax({
                    type: "POST",
                    url: "/masters/sip_master_reconciliation.aspx/GetBranchList", // Replace with actual ASPX page name
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let optionsHtml = data.map(r => `<option value="${r.value}">${r.text}</option>`);
                        $("#ddlBranch").html(optionsHtml.join(''));
                        $("#ddlRtaBranch").html(optionsHtml.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading branch list: " + xhr.responseText);
                    }
                });
            }

            function loadZoneList() {
                //alert(' zone list');

                $.ajax({
                    type: "POST",
                    url: "/masters/sip_master_reconciliation.aspx/GetZoneList", // Replace with actual ASPX page name
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let optionsHtml = data.map(r => `<option value="${r.value}">${r.text}</option>`);
                        $("#ddlZone").html(optionsHtml.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading zone list: " + xhr.responseText);
                    }
                });
            }

            function loadAMCList() {
                //alert(' amc list');

                $.ajax({
                    type: "POST",
                    url: "/masters/sip_master_reconciliation.aspx/GetAMCList", // Replace with actual ASPX page name
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let optionsHtml = data.map(r => `<option value="${r.value}">${r.text}</option>`);
                        $("#ddlAMC").html(optionsHtml.join(''));
                        $("#ddlRtaAMC").html(optionsHtml.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading AMC list: " + xhr.responseText);
                    }
                });
            }

            function loadRMList() {
                //alert(' rm list');

                $.ajax({
                    type: "POST",
                    url: "/masters/sip_master_reconciliation.aspx/GetRmList", // Replace with actual ASPX page name
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let optionsHtml = data.map(r => `<option value="${r.value}">${r.text}</option>`);
                        $("#ddlRM").html(optionsHtml.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading RM list: " + xhr.responseText);
                    }
                });
            }

            function loadBranchByChannel(channelCode) {
                //alert(' branch by channel');

                $.ajax({
                    url: "/masters/sip_master_reconciliation.aspx/GetBranchListByChannel",
                    method: "POST",
                    data: JSON.stringify({ channel: channelCode }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let options = data.map(x => `<option value="${x.value}">${x.text}</option>`);
                        $("#ddlBranch").html(options.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading branch by channel: " + xhr.responseText);
                    }
                });
            }

            function loadBranchByZone(zoneCode) {
                //alert(' branch by zone');

                $.ajax({
                    url: "/masters/sip_master_reconciliation.aspx/GetBranchListByZone",
                    method: "POST",
                    data: JSON.stringify({ zone: zoneCode }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let options = data.map(x => `<option value="${x.value}">${x.text}</option>`);
                        $("#ddlBranch").html(options.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading branch by zone: " + xhr.responseText);
                    }
                });
            }

            function loadRegionByChannel(channelCode) {
                //alert(' region by channel ');

                $.ajax({
                    url: "/masters/sip_master_reconciliation.aspx/GetRegionListByChannel",
                    method: "POST",
                    data: JSON.stringify({ channel: channelCode }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let options = data.map(x => `<option value="${x.value}">${x.text}</option>`);
                        $("#ddlRegion").html(options.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading region by channel: " + xhr.responseText);
                    }
                });
            }

            function loadZoneByChannel(channelCode) {
                //alert(' zone by channel ');

                $.ajax({
                    url: "/masters/sip_master_reconciliation.aspx/GetZoneListByChannel",
                    method: "POST",
                    data: JSON.stringify({ channel: channelCode }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let options = data.map(x => `<option value="${x.value}">${x.text}</option>`);
                        $("#ddlZone").html(options.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading zone by channel: " + xhr.responseText);
                    }
                });
            }

            function loadZoneByRegion(regionCode) {
                //alert(' zone by region ');

                $.ajax({
                    url: "/masters/sip_master_reconciliation.aspx/GetZoneListByRegion",
                    method: "POST",
                    data: JSON.stringify({ region: regionCode }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let options = data.map(x => `<option value="${x.value}">${x.text}</option>`);
                        $("#ddlZone").html(options.join(''));
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading zone by region: " + xhr.responseText);
                    }
                });
            }


            function loadRMListByBrnach(value) {
                //alert(' rm by branch ');

                $.ajax({
                    url: "/masters/sip_master_reconciliation.aspx/GetRmListByBranch",
                    method: "POST",
                    data: JSON.stringify({ branchCode: value }), // üî• CORRECT HERE
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        data.unshift({ text: "All", value: "" });
                        let options = data.map(x => `<option value="${x.value}">${x.text}</option>`);
                        $("#ddlRM").html(options.join(''));
                        //alert(data.length);
                    },
                    error: function (xhr, status, error) {
                        alert("‚ùå Error loading RM list: " + xhr.responseText);
                    }
                });

            }
            //#endregion ---------- HELPING FUNCTION: DDL DATA LOAD AJAX ----------

            //#region ---------- PAGE LOAD FUNCTIONS CALL ----------
            checkUserSession();
            const $menuIcon = $('.mdi-menu');       // The <span> you use as the button
            const $sidebar = $('#sidebar');         // The <nav> sidebar element
            const toggleClass = 'collapsed-sidebar'; // This is a custom class we‚Äôll toggle

            // 1. Restore sidebar state from localStorage
            if (localStorage.getItem('sidebarState') === 'collapsed') {
                $sidebar.addClass(toggleClass);
                $menuIcon.addClass('active'); // Optional styling
            }

            // 2. On click of the <span class="mdi mdi-menu">
            $menuIcon.on('click', function () {
                $sidebar.toggleClass(toggleClass);
                $menuIcon.toggleClass('active'); // Optional styling

                // 3. Save state to localStorage
                if ($sidebar.hasClass(toggleClass)) {
                    localStorage.setItem('sidebarState', 'collapsed');
                } else {
                    localStorage.setItem('sidebarState', 'expanded');
                }
            });


            $(document).ajaxStart(function () {
                checkUserSession();
                showLoader();
            });


            $(document).ajaxStop(function () {
                hideLoader();
            });

            setCurrentDateToInput('txtDateFrom');
            setCurrentDateToInput('txtDateTo');

            loadChannelList();
            loadRegionList();
            loadBranchList();
            loadZoneList();
            loadAMCList();
            loadRMList();
            //$('#tranRegular').prop('checked', true);
            enableAutoDateFormat("txtDateFrom");
            enableAutoDateFormat("txtDateTo");
            enableAutoDateFormat("txtRtaDateFrom");
            enableAutoDateFormat("txtRtaDateTo");
            enableAutoDateFormat("txtSIPDate");
            makeTableColumnsResizable("transactionTable");
            makeTableColumnsResizable("rtaGrid");
            makeTableColumnsResizable("tranCodeGrid");
            makeTableColumnsResizable("sipGrid");
            syncScroll();
            //#endregion ---------- PAGE LOAD FUNCTIONS CALL ----------

            //#region ---------- SECTION 0.0: ONCHANGE TR ACTION BUTTON ----------

            $("#ddlChannel").change(function () {
                let channelCode = $(this).val();
                if (!channelCode || channelCode == null) {
                    loadRegionList();
                    loadZoneList();
                    loadBranchList();
                } else {
                    loadRegionByChannel(channelCode);
                    loadZoneByChannel(channelCode);
                    loadBranchByChannel(channelCode);
                }
                loadRMList();
            });

            $("#ddlRegion").change(function () {
                let value = $(this).val();

                if (!value || value === null) {
                    loadZoneList();
                    loadBranchList();
                } else {
                    loadZoneByRegion(value);
                }
                loadRMList();
            });

            $("#ddlZone").change(function () {
                let value = $(this).val();
                if (!value || value === null) {
                    loadBranchList();
                } else {
                    loadBranchByZone(value);
                }
                loadRMList();
            });

            $("#ddlBranch").change(function () {
                let value = $(this).val();

                if (!value || value === null) {
                    loadRMList();
                } else {
                    loadRMListByBrnach(value);
                }
            });

            //#endregion ---------- SECTON 0.0: ONCHANGE TR ACTION BUTTON ----------

            //#region ---------- SECTION 1.1: TR FIND HELPER FUNCTIONS ----------

            function loadTRListX(x) {
                //alert('new tr find start for ' + x);
                let rta_dateFrom = $('#txtRtaDateFrom').val() || '';
                let rta_dateTo = $('#txtRtaDateTo').val() || '';
                let rta_amc = $('#ddlRtaAMC').val() || '';
                let rta_branch = $('#ddlRtaBranch').val() || '';
                let rta_statusType = $('input[name="rtaRecoStatus"]:checked').val() || '';
                let rta_chequeType = $('#ddlRtaCheque').val() || '';
                let rta_chequeSearch = ($('#txtRtaChequeNo').val() || '').trim();
                let rta_investorName = ($('#txtRtaInvestorName').val() || '').trim();
                let rta_amount = ($('#txtRtaAmount').val() || '').trim();
                let rta_tranType = $('input[name="rtaTranType"]:checked').val() || '';

                let tr_branchCat = $('#ddlChannel').val() || '';
                let tr_region = $('#ddlRegion').val() || '';
                let tr_zone = $('#ddlZone').val() || '';
                let tr_branch = $('#ddlBranch').val() || '';
                let tr_rm = $('#ddlRM').val() || '';
                let tr_amc = $('#ddlAMC').val() || '';
                let tr_tranType = $('input[name="tranType"]:checked').val() || '';
                let tr_registrar = $('input[name="registrar"]:checked').val() || '';
                let tr_statusType = $('input[name="reco"]:checked').val() || '';
                let tr_pms = $('#chkPMS').is(':checked') ? 'Y' : 'N';
                let tr_cob = $('#chkTrCOB').is(':checked') ? 'Y' : 'N';
                let tr_dateFrom = $('#txtDateFrom').val() || '';
                let tr_dateTo = $('#txtDateTo').val() || '';
                let tr_arNum = ($('#txtARNo').val() || '').trim();
                let sip_FolioNo = ($('#txtSIPFolioNo').val() || '').trim();
                let sip_Amount = ($('#txtSIPAmount').val() || '').trim();
                let sip_Pan = ($('#txtSIPPan').val() || '').trim();
                let sip_ClientCode = ($('#txtSIPClientCode').val() || '').trim();
                let sip_Date = $('#txtSIPDate').val() || '';

                const branchCat = tr_branchCat;
                const region = tr_region;
                const zone = tr_zone;
                const branch = (x == '1') ? rta_branch : tr_branch;
                const rm = tr_rm;
                const amc = (x == '1') ? rta_amc : tr_amc;
                const tranType = (x == '1') ? rta_tranType : tr_tranType;
                const registrar = tr_registrar.toUpperCase();
                const statusType = (x == '1') ? rta_statusType : tr_statusType;
                const pms = tr_pms;
                const cobFlag = tr_cob;
                const dateFrom = (x == '1') ? rta_dateFrom : (tr_arNum ? '' : tr_dateFrom);
                const dateTo = (x == '1') ? rta_dateTo : (tr_arNum ? '' : tr_dateTo);
                const arNo = tr_arNum;
                const chequeType = rta_chequeType;
                const chequeSearch = rta_chequeSearch;
                const investorName = rta_investorName;
                const amount = rta_amount;
                const sipFolioNo = sip_FolioNo;
                const sipAmount = sip_Amount;
                const sipPan = sip_Pan;
                const sipClientCode = sip_ClientCode;
                const sipDate = sip_Date;


                if (x == '2') {
                    if (!arNo && (!dateFrom || !dateTo)) {
                        alert("‚ö†Ô∏è Please enter AR No or both From Date and To Date.");
                        return;
                    }
                }

                if (x == '3') {
                    if (!sipFolioNo && !sipPan && !sipClientCode && !sipDate) {
                        alert("‚ö†Ô∏è Please enter at least one SIP search criteria (Folio, PAN, Client Code, or Date).");
                        return;
                    }
                }

                let valudmsg = (`Transaction Filter Values:\n\n` +
                    `X: ${x}\n` + `Branch Category: ${branchCat}\n` + `Region: ${region}\n` +
                    `Zone: ${zone}\n` + `Branch: ${branch}\n` + `RM: ${rm}\n` +
                    `AMC: ${amc}\n` + `Transaction Type: ${tranType}\n` + `Registrar: ${registrar}\n` +
                    `Status Type: ${statusType}\n` + `PMS: ${pms}\n` + `COB: ${cobFlag}\n` +
                    `Date From: ${dateFrom}\n` + `Date To: ${dateTo}\n` + `AR Number: ${arNo}\n` +
                    `Cheque Type: ${chequeType}\n` + `Cheque Search: ${chequeSearch}\n` +
                    `Investor Name: ${investorName}\n` + `Amount: ${amount}\n` +
                    `SIP Folio No: ${sipFolioNo}\n` + `SIP Amount: ${sipAmount}\n` +
                    `SIP PAN: ${sipPan}\n` + `SIP Client Code: ${sipClientCode}\n` +
                    `SIP Date: ${sipDate}\n`
                );



                $.ajax({
                    url: "/masters/sip_master_reconciliation.aspx/GetTRListX",
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify({
                        x: x,
                        branchCat: branchCat,
                        region: region,
                        zone: zone,
                        branch: branch,
                        rm: rm,
                        amc: amc,
                        tranType: tranType,
                        registrar: registrar,
                        reconciliationStatus: statusType,
                        cobFlag: cobFlag,
                        dateFrom: dateFrom,
                        dateTo: dateTo,
                        arNo: arNo,
                        chequeType: chequeType,
                        chequeSearch: chequeSearch,
                        investorName: investorName,
                        amount: amount,
                        sipFolioNo: sipFolioNo,
                        sipAmount: sipAmount,
                        sipPan: sipPan,
                        sipClientCode: sipClientCode,
                        sipDate: sipDate,
                        isPms: pms,
                        isOp: 'N'
                    }),
                    success: function (res) {
                        let { data } = JSON.parse(res.d);
                        if (x == '2') {
                            $("#lblTrCount").text(data.length);
                        }

                        //alert(data.length + ' -->  Record(s) found, for x = ' + x);
                        if (x == '1') {
                            populateRTATable(data)
                        }
                        else if (x == '2') {
                            populateTransactionTable(data)
                        }
                        else if (x == '3') {
                            populateSIPTable(data);
                        }
                        else {
                            alert("‚ùå Invalid value for x: " + x);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert("Error: " + xhr.responseText);
                    }
                });
            }

            function populateTransactionTable(data) {
                // Clear existing data
                $('#transactionTable tbody').empty();

                if (!data || data.length === 0) {
                    alert('Transaction Data Not Found! üôÅ');

                    //$('#transactionTable tbody').append(  '<tr><td colspan="35" class="text-center">No records found</td></tr>' );
                    return;
                }

                // Populate the table with data
                $.each(data, function (index, row) {
                    const tr = $('<tr>');

                    // Add all columns in the exact order they appear in your table
                    tr.append($('<td>').text(row.TRAN_CODE || ''));
                    tr.append($('<td>').text(formatDateToDMY(row.TR_DATE) || ''));
                    tr.append($('<td>').text(row.INVESTOR_NAME || ''));
                    tr.append($('<td>').text(row.ADDRESS || ''));
                    tr.append($('<td>').text(row.CITY_NAME || ''));
                    tr.append($('<td>').text(row.AMC_NAME || ''));
                    tr.append($('<td>').text(row.SCH_NAME || ''));
                    tr.append($('<td>').text((row.AMOUNT) || ''));
                    tr.append($('<td>').text(row.FOLIO_NO || ''));
                    tr.append($('<td>').text(row.CHEQUE_NO || ''));
                    tr.append($('<td>').text(row.APP_NO || ''));
                    tr.append($('<td>').text(row.RM_NAME || ''));
                    tr.append($('<td>').text(row.BRANCH_NAME || ''));
                    tr.append($('<td>').text((row.SIP_AMOUNT) || ''));
                    tr.append($('<td>').text(row.TOTAL_SIP || ''));
                    tr.append($('<td>').text(row.STATUS || ''));
                    tr.append($('<td>').text(row.FLAG || ''));
                    tr.append($('<td>').text(row.REMARK || ''));

                    // Hidden columns
                    tr.append($('<td style="display:none">').text(row.SIP_TYPE || ''));
                    tr.append($('<td style="display:none">').text(row.TRAN_TYPE || ''));
                    tr.append($('<td style="display:none">').text(row.BANK_NAME || ''));
                    tr.append($('<td style="display:none">').text(row.PANNO || ''));
                    tr.append($('<td style="display:none">').text(formatDateToDMY(row.CHEQUE_DATE) || ''));
                    tr.append($('<td style="display:none">').text(row.BROKER_ID || ''));
                    tr.append($('<td style="display:none">').text(row.REGISTRAR || ''));
                    tr.append($('<td style="display:none">').text(row.SOURCE_CODE || ''));
                    tr.append($('<td style="display:none">').text(row.DISPATCH || ''));
                    tr.append($('<td style="display:none">').text(row.COB_FLAG || ''));
                    tr.append($('<td style="display:none">').text(row.CLIENT_CODE || ''));
                    tr.append($('<td style="display:none">').text(row.SCH_CODE || ''));
                    tr.append($('<td style="display:none">').text(row.MUT_CODE || ''));
                    tr.append($('<td style="display:none">').text(row.PAYMENT_MODE || ''));
                    tr.append($('<td style="display:none">').text(row.LEAD_NO || ''));
                    tr.append($('<td style="display:none">').text(row.LEAD_NAME || ''));
                    tr.append($('<td style="display:none">').text(row.BRANCH_CODE || ''));
                    tr.append($('<td style="display:none">').text(row.BUSINESS_RMCODE || ''));
                    $('#transactionTable tbody').append(tr);
                });
            }

            function populateRTATable(data) {
                // Clear existing data
                $('#rtaGrid tbody').empty();

                if (!data || data.length === 0) {
                    alert('RTA Transaction Data Not Found! üôÅ');
                    //$('#rtaGrid tbody').append(  '<tr><td colspan="16" class="text-center">No records found</td></tr>' );
                    return;
                }

                // Populate the table with data
                $.each(data, function (index, row) {
                    const tr = $('<tr>');

                    // Add all columns in order
                    tr.append($('<td>').text(row.UNIQUE_TRAN || ''));
                    tr.append($('<td>').text(formatDateToDMY(row.TR_DATE) || ''));
                    tr.append($('<td>').text(row.INVESTOR_NAME || ''));
                    tr.append($('<td>').text(row.ADDRESS || ''));
                    tr.append($('<td>').text(row.CITY_NAME || ''));
                    tr.append($('<td>').text(row.MUT_NAME || ''));
                    tr.append($('<td>').text(row.SCH_NAME || ''));
                    tr.append($('<td>').text(row.AMOUNT || ''));
                    tr.append($('<td>').text(row.FOLIO_NO || ''));
                    tr.append($('<td>').text(row.CHEQUE_NO || ''));
                    tr.append($('<td>').text(row.APP_NO || ''));
                    tr.append($('<td>').text(row.RM_NAME || ''));
                    tr.append($('<td>').text(row.BRANCH_NAME || ''));
                    tr.append($('<td>').text(row.BROKER_CODE || ''));
                    tr.append($('<td>').text(row.REG_TRANTYPE || ''));
                    tr.append($('<td>').text(row.UNQ_KEY || ''));

                    $('#rtaGrid tbody').append(tr);
                    highlightMatchingRTAColumns();

                });
            }


            function populateSIPTable(data) {
                // Clear existing data
                $('#sipGrid tbody').empty();

                if (!data || data.length === 0) {
                    alert('SIP Transaction Data Not Found! üôÅ');
                    //$('#sipGrid tbody').append('<tr><td colspan="17" class="text-center">No records found</td></tr>');
                    return;
                }

                // Populate the table with data
                $.each(data, function (index, row) {
                    const tr = $('<tr>');

                    // Add all columns in order
                    tr.append($('<td>').text(row.SEQ_NO || ''));
                    tr.append($('<td>').text(row.MUT_NAME || ''));
                    tr.append($('<td style="width: 400px;" >').text(row.SCH_NAME || ''));
                    tr.append($('<td>').text(row.AMOUNT_SIP || ''));
                    tr.append($('<td>').text(row.FOLIO_NO || ''));
                    tr.append($('<td>').text(row.TRXN_NO || ''));
                    tr.append($('<td>').text(formatDateToDMY(row.SIP_START_DATE) || ''));
                    tr.append($('<td>').text(formatDateToDMY(row.SIP_END_DATE) || ''));
                    tr.append($('<td>').text(formatDateToDMY(row.SIP_REG_DATE) || ''));
                    tr.append($('<td>').text(row.SIP_OPTION || ''));
                    tr.append($('<td>').text(row.TOTAL_SIP || ''));
                    tr.append($('<td>').text(row.RM_NAME || ''));
                    tr.append($('<td>').text(row.BRANCH_NAME || ''));
                    tr.append($('<td style="display:none">').text(row.BRANCH_CODE || ''));
                    tr.append($('<td style="display:none">').text(row.PAYROLL_ID || ''));
                    tr.append($('<td style="display:none">').text(row.SCH_CODE || ''));
                    tr.append($('<td style="display:none">').text(row.MUT_CODE || ''));

                    $('#sipGrid tbody').append(tr);
                    //highlightMatchingSIPColumns(); // (if you need similar highlighting logic like RTA)
                });
            }


            function setRtaTranTypeByTrSipType(sipVal) {
                const normalizedSip = (sipVal || "").toLowerCase() === "regular" ? "REGULAR" : "SIP";

                //alert('TR VALUE ' + normalizedSip);
                const $radioButton = $(`input[name='rtaTranType'][value='${normalizedSip}']`);

                //alert('RTA VALUE ' + $radioButton.val());

                if ($radioButton.length) {
                    $radioButton.prop("checked", true);
                } else {
                }
            }

            function setRtaRecoStatus(tranType) {
                const recoVal = (tranType || "").toUpperCase() === "UNRECONCILE" ? "N" : "Y";

                const $radio = $(`input[name='rtaRecoStatus'][value='${recoVal}']`);

                if ($radio.length) {
                    $radio.prop("checked", true);
                } else {
                }
            }

            function setTrRegistrarByTr(registrar, cobfl) {
                let registrarVal = "";

                if (registrar === "C" && cobfl === "0") {
                    registrarVal = "c";
                } else if (registrar === "K" && cobfl === "0") {
                    registrarVal = "k";
                } else if (registrar === "C" && cobfl === "1") {
                    registrarVal = "ccob";
                } else if (registrar === "K" && cobfl === "1") {
                    registrarVal = "kcob";
                }

                if (registrarVal) {
                    $('input[name="registrar"][value="' + registrarVal + '"]').prop('checked', true);
                }
            }

            function setTranAmtCheqFolAppPanBrkByTr(trCode, trAmount, chequeNo, folioNo, appNo, panNo, brokerId, dispatch) {
                $('#hdnTrCode').text(trCode);
                $('#hdnTrAmount').text(trAmount);
                $('#hdnTrChe').text(chequeNo);
                $('#hdnTrFolio').text(folioNo);
                $('#hdnTrApp').text(appNo);
                $('#hdnTrPan').text(panNo);
                $('#hdnTrBroker').text(brokerId);
                $('#hdnTrDispatch').text(dispatch);

            }

            function setHiddenRtaValues(rtaCode, rtaAmount, rtaDate, rtaFolio) {
                $('#hdnRtaCode').text(rtaCode.trim());
                $('#hdnRtaAmount').text(rtaAmount.trim());
                $('#hdnRtaDate').text(rtaDate.trim());
                $('#hdnRtaFolio').text(rtaFolio.trim());
            }

            function setRtaFromToDatesByTrDate(tranDateStr) {
                if (/^\d{2}\/\d{2}\/\d{4}$/.test(tranDateStr)) {
                    const [dd, mm, yyyy] = tranDateStr.split('/');
                    const originalDate = new Date(`${yyyy}-${mm}-${dd}`);

                    if (!isNaN(originalDate)) {
                        const before = new Date(originalDate);
                        before.setMonth(before.getMonth() - 1);

                        const after = new Date(originalDate);
                        after.setMonth(after.getMonth() + 1);

                        const format = (d) => ("0" + d.getDate()).slice(-2) + "/" + ("0" + (d.getMonth() + 1)).slice(-2) + "/" + d.getFullYear();

                        $('#txtRtaDateFrom').val(format(before));
                        $('#txtRtaDateTo').val(format(after));
                    } else {
                        $('#txtRtaDateFrom').val('');
                        $('#txtRtaDateTo').val('');
                    }
                } else {
                    $('#txtRtaDateFrom').val('');
                    $('#txtRtaDateTo').val('');
                }
            }

            function setRtaAmcBrStsTranInvAmtRemByTr({
                amc,
                branch,
                status,
                tranType,
                investorName,
                amount,
                remarks
            }) {

                $('#ddlRtaAMC').val(amc || '');
                $('#ddlRtaBranch').val(branch || '');

                if (status) {
                    //$(`input[name="status"][value="${status}"]`).prop('checked', true);
                }

                if (tranType) {
                    //$(`input[name="tranType"][value="${tranType}"]`).prop('checked', true);
                }

                $('#txtRtaInvestorName').val(investorName || '');
                $('#txtRtaAmount').val((amount || '').replace(/[^0-9.]/g, ''));

                $('#txtRtaRemarks').val(remarks || '');
            }

            function setSIPFields(data) {
                $('#txtSIPFolioNo').val(data.folioNo || '');
                $('#txtSIPAmount').val(data.amount || '');
                $('#txtSIPPan').val(data.pan || '');
                $('#txtSIPClientCode').val(data.clientCode || '');
                $('#txtSIPDate').val(data.date || '');
            }

            function resetSIPFields() {
                $('#txtSIPFolioNo').val('');
                $('#txtSIPAmount').val('');
                $('#txtSIPPan').val('');
                $('#txtSIPClientCode').val('');
                $('#txtSIPDate').val('');

                $('#sipGrid tbody').empty();

            }



            function clearRtaFilterForm() {

                $('#rtaGrid tbody').empty();

                // Clear date inputs
                $('#txtRtaDateFrom').val('');
                $('#txtRtaDateTo').val('');
                $('#txtRtaInvestorName').val('');
                $('#txtRtaAmount').val('');
                $('#txtRtaRemarks').val('');


                // Reset dropdowns to no selection (index -1)
                $('#ddlRtaAMC').prop('selectedIndex', -1);
                $('#ddlRtaBranch').prop('selectedIndex', -1);
                $('#ddlRtaCheque').prop('selectedIndex', -1);
                // Reset and set default radio selections
                $('input[name="rtaRecoStatus"]').prop('checked', false);
                $('input[name="rtaRecoStatus"][value="N"]').prop('checked', true); // Set "Unreconciled" checked

                $('input[name="rtaTranType"]').prop('checked', false);
                $('input[name="rtaTranType"][value="REGULAR"]').prop('checked', true); // Set "Regular" checked

                // Clear hidden span values
                $('#hdnTrCode, #hdnTrAmount, #hdnTrChe, #hdnTrFolio, #hdnTrApp, #hdnTrPan, #hdnTrBroker, #hdnRtaCode, #hdnRtaAmount, #hdnRtaFolio, #hdnRtaDate, #hdnTrDispatch ').text('');
                $('#txtRtaChequeNo').val('');
            }

            //#endregion ---------- SECTION 1.1: TR FIND HELPER FUNCTIONS ----------

            //#region ---------- SECTION 1.2: TR FIND ACTION BUTTONS ----------

            $("#btnTrFind").click(function () {
                clearRtaFilterForm();
                resetSIPFields();
                loadTRListX('2');
            });

            $('#transactionTable tbody').on('dblclick', 'tr', function () {
                $('#transactionTable tbody tr').removeClass('row-selected');
                $(this).addClass('row-selected');

                const headers = [];
                $('#transactionTable thead th').each(function () {
                    headers.push($(this).text().trim());
                });

                let rowObj = {};
                $(this).find('td').each(function (index) {
                    const key = headers[index];
                    const value = $(this).text().trim();
                    rowObj[key] = value;

                    const spanId = `rowData_${key.replace(/\s+/g, '_')}`;
                    const $existing = $(`#${spanId}`);
                    if ($existing.length) {
                        $existing.text(value);
                    } else {
                        $('<span>', {
                            id: spanId,
                            class: 'hidden-row-data',
                            text: value,
                            style: 'display:none;'
                        }).appendTo('body'); // Or any container you prefer
                    }
                });

                const TRAN_CODE = rowObj["TRAN_CODE"];
                const TR_DATE = rowObj["TR_DATE"];
                const INVESTOR_NAME = rowObj["INVESTOR_NAME"];
                const ADDRESS1 = rowObj["ADDRESS"];
                const CITY_NAME = rowObj["CITY_NAME"];
                const MUT_NAME = rowObj["AMC_NAME"];
                const SCH_NAME = rowObj["SCH_NAME"];
                const AMOUNT = rowObj["AMOUNT"];
                const BANK_NAME = rowObj["BANK_NAME"];
                const RM_NAME = rowObj["RM_NAME"];
                const BRANCH_NAME = rowObj["BRANCH_NAME"];
                const RM_CODE = rowObj["RM_CODE"];
                const PANNO = rowObj["PANNO"];
                const CHEQUE_NO = rowObj["CHEQUE_NO"];
                const CHEQUE_DATE = rowObj["CHEQUE_DATE"];
                const FOLIO_NO = rowObj["FOLIO_NO"];
                const BROKER_ID = rowObj["BROKER_ID"];
                const SIP_AMOUNT = rowObj["SIP_AMOUNT"];
                const REGISTRAR = rowObj["REGISTRAR"];
                const SOURCE_CODE = rowObj["SOURCE_CODE"];
                const DISPATCH = rowObj["DISPATCH"];
                const COB_FLAG = rowObj["COB_FLAG"];
                const CLIENT_CODE = rowObj["CLIENT_CODE"];
                const SCH_CODE = rowObj["SCH_CODE"];
                const MUT_CODE = rowObj["MUT_CODE"];
                const TRAN_TYPE = rowObj["TRAN_TYPE"];
                const APP_NO = rowObj["APP_NO"];
                const PAYMENT_MODE = rowObj["PAYMENT_MODE"];
                const SIP_TYPE = rowObj["SIP_TYPE"];
                const LEAD_NO = rowObj["LEAD_NO"];
                const LEAD_NAME = rowObj["LEAD_NAME"];
                const BRANCH_CODE = rowObj["BRANCH_CODE"];
                const BUSINESS_RMCODE = rowObj["BUSINESS_RMCODE"];
                const REMARK = rowObj["REMARK"];
                const LOGGEDUSER = rowObj["LOGGEDUSER"];
                const STATUS = rowObj["STATUS"];

                clearRtaFilterForm();

                setTrRegistrarByTr(REGISTRAR, COB_FLAG);

                setTranAmtCheqFolAppPanBrkByTr(
                    rowObj.TRAN_CODE,
                    rowObj.AMOUNT,
                    rowObj.CHEQUE_NO,
                    rowObj.FOLIO_NO,
                    rowObj.APP_NO,
                    rowObj.PANNO,
                    rowObj.BROKER_ID,
                    rowObj.DISPATCH
                );

                setRtaFromToDatesByTrDate(rowObj.TR_DATE);

                setRtaAmcBrStsTranInvAmtRemByTr({
                    amc: rowObj.MUT_CODE,
                    branch: rowObj.BRANCH_CODE,
                    status: 'N',
                    tranType: 'REGULAR',
                    investorName: rowObj.INVESTOR_NAME,
                    amount: rowObj.AMOUNT,
                    remarks: rowObj.REMARK
                });

                setRtaTranTypeByTrSipType(rowObj.SIP_TYPE);

                setRtaRecoStatus(rowObj.STATUS);

                $('#ddlRtaCheque').prop('selectedIndex', 4);
                $('#txtRtaChequeNo').val(PANNO);


                const sipData = {
                    folioNo: FOLIO_NO,
                    amount: AMOUNT,
                    pan: PANNO,
                    clientCode: CLIENT_CODE,
                    date: TR_DATE
                };

                // Set the values to the input fields
                setSIPFields(sipData);


                let rowDetails = Object.entries(rowObj)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join('\n');

                //alert("Clicked Row Data:\n" + rowDetails);
            });

            $("#btnTrReset").click(function () {
                window.location.href = '/Masters/sip_master_reconciliation.aspx';
            });

            $("#btnTrExport").click(function () {
                ExportTableToExcel_1("transactionTable", "TR");
            });

            $("#btnTrExit").click(function () {
                RedirectToWelcomePage();
            });

            //#endregion ---------- SECTION 1.2: TR FIND ACTION BUTTONS ----------

            //#region ---------- SECTION 2.1: RTA DATA FIND HELPER ----------

            function highlightMatchingRTAColumns() {
                const columnMap = {
                    "TRAN_CODE": "TRAN_CODE",
                    "TR_DATE": "TRAN_DATE",
                    "INVESTOR_NAME": "INVESTOR_NAME",
                    "ADDRESS": "ADDRESS",
                    "CITY_NAME": "CITY_NAME",
                    "AMC_NAME": "AMC_NAME",
                    "SCH_NAME": "SCHEME_NAME",
                    "AMOUNT": "AMOUNT",
                    "FOLIO_NO": "FOLIO_NO",
                    "CHEQUE_NO": "CHEQUE_NO",
                    "APP_NO": "APP_NO",
                    "RM_NAME": "RM_NAME",
                    "BRANCH_NAME": "BRANCH_NAME"
                };

                // Get headers from transactionTable
                const tranHeaders = [];
                $('#transactionTable thead th').each(function () {
                    tranHeaders.push($(this).text().trim().toUpperCase());
                });

                const $selectedRow = $('#transactionTable tbody tr.row-selected');
                if ($selectedRow.length === 0) {
                    alert('No selected row found in transactionTable!');
                    return;
                }

                const selectedData = {};
                $selectedRow.find('td').each(function (index) {
                    const key = tranHeaders[index];
                    const value = $(this).text().trim().toLowerCase();
                    selectedData[key] = value;
                });

                const rtaHeaders = [];
                $('#rtaGrid thead th').each(function () {
                    rtaHeaders.push($(this).text().trim().toUpperCase());
                });

                $('#rtaGrid tbody tr').each(function () {
                    $(this).find('td').each((index, cell) => {
                        const rtaKey = rtaHeaders[index];
                        const tranKey = Object.keys(columnMap).find(k => columnMap[k] === rtaKey);

                        if (tranKey && selectedData[tranKey] !== undefined) {
                            const rtaValue = $(cell).text().trim().toLowerCase();
                            const tranValue = selectedData[tranKey];

                            if (rtaValue === tranValue) {
                                // Exact match ‚Äì Strong green
                                $(cell).css('background-color', '#28a745').css('color', '');
                            } else if (isPartialMatch(tranValue, rtaValue)) {
                                // Partial match ‚Äì Light green
                                //$(cell).css('background-color', '#a9dfbf');
                            } else {
                                // No match ‚Äì Clear background
                                $(cell).css('background-color', '').css('color', '');
                            }
                        }
                    });
                });

                function isPartialMatch(text1, text2) {
                    if (!text1 || !text2) return false;

                    const words1 = text1.split(/\s+/);
                    const words2 = text2.split(/\s+/);

                    let matchCount = 0;

                    for (const word1 of words1) {
                        if (words2.includes(word1)) {
                            matchCount++;
                        }
                    }

                    const matchRatio = matchCount / Math.max(words1.length, words2.length);
                    return matchRatio >= 0.5;
                }
            }


            function onRtaSaveRemark(trCodeValue, txtRemarkValue) {
                $.ajax({
                    url: "/masters/sip_master_reconciliation.aspx/SaveRemark",
                    method: "POST",
                    data: JSON.stringify({
                        trCode: trCodeValue,
                        txtRemark: txtRemarkValue
                    }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (res) {
                        const result = JSON.parse(res.d);
                        alert(result.success ? `‚úÖ ${result.message}` : `‚úÖ ${result.message}`);

                    },
                    error: function (xhr, status, error) {
                        alert(`‚ùå Error saving remark: ${error}`);
                    }
                });
            }

            function onConfirmSIP(trCode, remark, pmsStatus, atmStatus) {
                const trTranCodeValue = trCode;
                const masterIdValue = remark;
                const dispatchValue = pmsStatus;

                $.ajax({
                    type: "POST",
                    url: "/masters/sip_master_reconciliation.aspx/ConfirmSIP2",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify({
                        trTranCodeValue: trTranCodeValue,
                        masterIdValue: masterIdValue,
                        dispatchValue: dispatchValue
                    }),
                    success: function (res) {
                        const result = JSON.parse(res.d);
                        alert(result.success ? `‚úÖ ${result.message}` : `${result.message}`);
                    },
                    error: function (xhr) {
                        let errorMsg = "Server error occurred";
                        try {
                            const errResponse = JSON.parse(xhr.responseText);
                            if (errResponse.Message) {
                                errorMsg = errResponse.Message;
                            }
                        } catch (e) {
                            errorMsg = xhr.statusText || "Unknown error";
                        }
                        alert(`‚ùå Error: ${errorMsg}`);
                    }
                });
            }

            function onUnConfirmSIP(trCode, remark, pmsStatus, atmStatus) {
                const trTranCodeValue = trCode;
                const masterIdValue = remark;
                const dispatchValue = pmsStatus;

                $.ajax({
                    type: "POST",
                    url: "/masters/sip_master_reconciliation.aspx/UnConfirmSIP2",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify({
                        trTranCodeValue: trTranCodeValue,
                        masterIdValue: masterIdValue,
                        dispatchValue: dispatchValue
                    }),
                    success: function (res) {
                        const result = JSON.parse(res.d);
                        alert(result.success ? `‚úÖ ${result.message}` : `${result.message}`);
                    },
                    error: function (xhr) {
                        let errorMsg = "Server error occurred";
                        try {
                            const errResponse = JSON.parse(xhr.responseText);
                            if (errResponse.Message) {
                                errorMsg = errResponse.Message;
                            }
                        } catch (e) {
                            errorMsg = xhr.statusText || "Unknown error";
                        }
                        alert(`‚ùå Error: ${errorMsg}`);
                    }
                });
            }


            function onReconcileTransaction(trCode, rtaAmount, rtaCode, rtaDate, rtaFolio, dispatch, trType) {
                $.ajax({
                    type: "POST",
                    url: "/masters/sip_master_reconciliation.aspx/ReconsileSIP2", // Corrected method name
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify({
                        trTranCodeValue: trCode,
                        trTranTypeValue: trType,
                        rtaTranCodeValue: rtaCode,
                        rtaTranDateValue: rtaDate,
                        rtaFolioValue: rtaFolio,
                        rtaAmountValue: rtaAmount,
                        rtaDispatchValue: dispatch
                    }),
                    success: function (res) {
                        // No need to parse res.d - it's already parsed by dataType: "json"
                        const result = res.d;
                        alert(result.success ? `‚úÖ ${result.message}` : `‚ùå ${result.message}`);
                    },
                    error: function (xhr) {
                        alert("‚ùå Error: " + (xhr.responseJSON && xhr.responseJSON.Message || xhr.responseText));
                    }
                });
            }
            //#endregion ---------- SECTION 2.1: RTA DATA FIND HELPER  ----------

            //#region ---------- SECTION 2.2: RTA DATA FIND ACTION ----------

            $('#ddlRtaCheque').on('change', function () {
                const selectedCode = $(this).val();
                let valueToSet = '';

                switch (selectedCode) {
                    case '001':
                        valueToSet = $('#hdnTrChe').text();
                        break;
                    case '002':
                        valueToSet = $('#hdnTrFolio').text();
                        break;
                    case '003':
                        valueToSet = $('#hdnTrApp').text();
                        break;
                    case '004':
                        valueToSet = $('#hdnTrPan').text();
                        break;
                    case '005':
                        valueToSet = $('#hdnTrBroker').text();
                        break;
                    default:
                        valueToSet = '';
                }

                $('#txtRtaChequeNo').val(valueToSet);
            });


            $('#btnRtaFind').click(function () {
                const rtaDtFrom = $('#txtRtaDateFrom').val() || '';
                const rtaDtTo = $('#txtRtaDateTo').val() || '';
                const rtaRecoStatus = $('input[name="rtaRecoStatus"]:checked').val() || '';
                const rtaAmc = $('#ddlRtaAMC').val() || '';
                const rtaBranch = $('#ddlRtaBranch').val() || '';
                const rtaCheqType = $('#ddlRtaCheque').val() || '';
                const rtaCheqValue = ($('#txtRtaChequeNo').val() || '').trim();
                const rtaInvName = ($('#txtRtaInvestorName').val() || '').trim();
                const rtaAmount = ($('#txtRtaAmount').val() || '').trim();
                const rtaTranType = $('input[name="rtaTranType"]:checked').val() || '';
                const rtaFindText = ($('#txtSearching').val() || '').trim();
                const trTranType = $('input[name="tranType"]:checked').val() || '';
                const trRegistrar = $('input[name="registrar"]:checked').val() || '';

                if (!rtaDtFrom && !rtaDtTo && !rtaCheqValue) {
                    alert("‚ö†Ô∏è Please fill at least one filter to proceed RTA find.");
                    return false;
                } else {
                    //loadRTAList();

                    loadTRListX('1');
                }
            });

            $('#rtaGrid tbody').on('click', 'tr', function () {

                $('#rtaGrid tbody tr').removeClass('row-selected');
                $(this).addClass('row-selected');

                const headers = [];
                $('#rtaGrid thead th').each(function () {
                    headers.push($(this).text().trim());
                });


                let rowObj = {};
                $(this).find('td').each(function (index) {
                    const key = headers[index];
                    const value = $(this).text().trim().replace(/'/g, ''); // Remove single quotes
                    rowObj[key] = value;

                    const spanId = `rta_rowData_${key.replace(/\s+/g, '_')}`;
                    const $existing = $(`#${spanId}`);
                    if ($existing.length) {
                        $existing.text(value);
                    } else {
                        $('<span>', {
                            id: spanId,
                            class: 'hidden-row-data',
                            text: value,
                            style: 'display:none;'
                        }).appendTo('body');
                    }
                });

                const TRAN_CODE = rowObj["TRAN_CODE"];
                const TRAN_DATE = rowObj["TRAN_DATE"];
                const INVESTOR_NAME = rowObj["INVESTOR_NAME"];
                const AMOUNT = rowObj["AMOUNT"];
                const AMX_NAME = rowObj["AMC_NAME"];
                const SCHEME_NAME = rowObj["SCHEME_NAME"];
                const ADDRESS = rowObj["ADDRESS"];
                const CITY_NAME = rowObj["CITY_NAME"];
                const FOLIO_NO = rowObj["FOLIO_NO"];
                const CHEQUE_NO = rowObj["CHEQUE_NO"];
                const APP_NO = rowObj["APP_NO"];
                const RM_NAME = rowObj["RM_NAME"];
                const BRANCH_NAME = rowObj["BRANCH_NAME"];
                const BROKER_CODE = rowObj["BROKER_CODE"];
                const REG_TRAN_TYPE = rowObj["REG_TRAN_TYPE"];
                const UNIQUE_KEY = rowObj["UNQ_KEY"];

                setHiddenRtaValues(TRAN_CODE, AMOUNT, TRAN_DATE, FOLIO_NO);

                const hiddenCode = $('#hdnRtaCode').text().trim();
                const hiddenAmount = $('#hdnRtaAmount').text().trim();

                //alert(`Hidden RTA Code: ${hiddenCode}\nHidden RTA Amount: ${hiddenAmount}`);
                let rowDetails = Object.entries(rowObj)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join('\n');

                //alert("Clicked Row Data:\n" + rowDetails);
            });

            $('#btnRtaReset').click(function () {
                clearRtaFilterForm();
            });

            $("#btnRtaExport").click(function () {
                ExportTableToExcel_1("rtaGrid", "RTA");
            });

            $('#btnRtaSaveRemark').click(function () {
                const trCode = $('#hdnTrCode').text().trim();
                const txtRemark = $('#txtRtaRemarks').val().trim();
                if (!trCode || !txtRemark) {
                    alert('‚ö†Ô∏è Transaction Code and Remark are required to save the remark.');
                    return;
                }
                onRtaSaveRemark(trCode, txtRemark);
            });

            $('#btnRtaConfPMS').click(function () {
                const trCode = $('#hdnTrCode').text().trim();
                const masterId = $('#hdnMasterId').text().trim() || '';
                const dispatchValue = 'N';
                if (confirm('Confirm this transaction?')) {
                    onConfirmSIP(trCode, masterId, dispatchValue);
                }
            });

            $('#btnRtaUncomfPMS').click(function () {
                const trCode = $('#hdnTrCode').text().trim();
                const masterId = $('#hdnMasterId').text().trim() || '';
                const dispatchValue = 'N';
                if (confirm('UnConfirm this transaction?')) {
                    onUnConfirmSIP(trCode, masterId, dispatchValue);
                }
            });

            $('#btnRtaReconsile').click(function () {
                const trCode = $('#hdnTrCode').text().trim();
                const trTranType = $('input[name="tranType"]:checked').val() || '';
                const trDispatch = $('#hdnTrDispatch').text().trim();
                const rtaCode = $('#hdnRtaCode').text().trim();
                const rtaDate = $('#hdnRtaDate').text().trim();
                const rtaFolio = $('#hdnRtaFolio').text().trim();
                const rtaAmount = $('#hdnRtaAmount').text().trim();

                let alertMsg = '';
                alertMsg += `trCode       : ${trCode}\n`;
                alertMsg += `trTranType   : ${trTranType}\n`;
                alertMsg += `trDispatch   : ${trDispatch}\n`;
                alertMsg += `rtaCode      : ${rtaCode}\n`;
                alertMsg += `rtaDate      : ${rtaDate}\n`;
                alertMsg += `rtaFolio     : ${rtaFolio}\n`;
                alertMsg += `rtaAmount    : ${rtaAmount}\n`;
                alert(alertMsg);
                return;

                if (!trCode || !rtaCode || !rtaAmount) {
                    alert("All fields (Transaction TR Code, RTA Code, and RTA Amount) are required for reconciliation.");
                    return;
                } else {
                    onReconcileTransaction(
                        trCode,      // trCode
                        rtaAmount,   // rtaAmount
                        rtaCode,     // rtaCode
                        rtaDate,     // rtaDate
                        rtaFolio,    // rtaFolio
                        trDispatch,  // dispatch
                        trTranType   // trType
                    );
                }
            });


            //#endregion ---------- SECTION 2.2: RTA DATA FIND ACTION ----------

            //#region ---------- SECTION 3: RECONCILED TRAN DATA FIND HELPER & ACTION ----------
            function loadTranList(tranCode) {
                $.ajax({
                    url: "/masters/sip_master_reconciliation.aspx/GetTranList",
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify({ tranCode }),
                    success: function (res) {
                        let { data } = JSON.parse(res.d);

                        if (!data || data.length === 0) {
                            $("#tranCodeGrid tbody").html(`
        <tr><td colspan="3" class="text-center text-danger">No records found</td></tr>
    `);
                            return;
                        }

                        let rows = data.map(rta => `
                                                <tr>
                                                   <td>${rta.HO_TRAN_CODE || ''}</td>        
                                                    <td>${rta.BRANCH_NAME || ''}</td>
                                                    <td>${rta.AMOUNT || ''}</td>
                                                </tr>
                                            `).join('');

                        $("#tranCodeGrid tbody").html(rows);
                    },
                    error: function (xhr, status, error) {
                        $("#tranCodeGrid tbody").html(`
    <tr><td colspan="3" class="text-center text-danger">Error loading data</td></tr>
`);
                        alert(`‚ùå Error: ${xhr.responseText}`);
                    }
                });
            }

            $('#btnTranFind').click(function () {
                const tranValue = $('#txtTranTranCode').val().trim();
                if (!tranValue) {
                    alert('Enter Tran Code!');
                    return;
                } else {
                    loadTranList(tranValue);
                }
            })
            //#endregion ---------- SECTION 3: RECONCILED TRAN DATA FIND ----------

            //#region ---------- SECTION 4: SIP SECTION WORKING ----------

            $('#btnSipFind').on('click', function () {
                let sip_FolioNo = ($('#txtSIPFolioNo').val() || '').trim();
                let sip_Amount = ($('#txtSIPAmount').val() || '').trim();
                let sip_Pan = ($('#txtSIPPan').val() || '').trim();
                let sip_ClientCode = ($('#txtSIPClientCode').val() || '').trim();
                let sip_Date = $('#txtSIPDate').val() || '';
                if (!sip_FolioNo && !sip_Amount && !sip_Pan && !sip_ClientCode && !sip_Date) {
                    alert("‚ö†Ô∏è Please fill at least one filter to proceed SIP find.");
                    return false;
                } else {

                    loadTRListX('3');
                }
            });


            $('#btnSipReset').on('click', function () {
                resetSIPFields();
            });


            $('#sipGrid tbody').on('dblclick', 'tr', function () {


                // Highlight the selected row
                $('#sipGrid tbody tr').removeClass('row-selected');
                $(this).addClass('row-selected');

                // Collect header names
                const headers = [];
                $('#sipGrid thead th').each(function () {
                    headers.push($(this).text().trim());
                });

                // Build row object
                let rowObj = {};
                $(this).find('td').each(function (index) {
                    const key = headers[index];
                    const value = $(this).text().trim();
                    rowObj[key] = value;

                    const spanId = `rowData_${key.replace(/\s+/g, '_')}`;
                    const $existing = $(`#${spanId}`);
                    if ($existing.length) {
                        $existing.text(value);
                    } else {
                        $('<span>', {
                            id: spanId,
                            class: 'hidden-row-data',
                            text: value,
                            style: 'display:none;'
                        }).appendTo('body'); // or another container
                    }
                });

                // Extract specific SIP grid values
                const SEQ_NO = rowObj["SEQ_NO"];
                const MUT_CODE = rowObj["MUT_CODE"];
                const AMC_NAME = rowObj["AMC_NAME"];
                const SCH_CODE = rowObj["SCH_CODE"];
                const SCHEME_NAME = rowObj["SCHEME_NAME"];
                const FOLIO_NO = rowObj["FOLIO_NO"];
                const TRXN_NO = rowObj["TRXN_NO"];
                const START_DATE = rowObj["START_DATE"];
                const END_DATE = rowObj["END_DATE"];
                const SIP_REG_DATE = rowObj["SIP_REG_DATE"];
                const SIP_OPTION = rowObj["SIP_OPTION"];
                const AMOUNT_SIP = rowObj["AMOUNT_SIP"];
                const TOTAL_SIP = rowObj["TOTAL_SIP"];
                const RM_NAME = rowObj["RM_NAME"];
                const PAYROLL_ID = rowObj["PAYROLL_ID"];
                const BRANCH_CODE = rowObj["BRANCH_CODE"];
                const BRANCH_NAME = rowObj["BRANCH_NAME"];

                // Optional: show all details together
                let rowDetails = Object.entries(rowObj)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join('\n');

                // Example: Show popup of selected row
                alert("Clicked Row Data:\n" + rowDetails);
            });


            //#endregion ---------- SECTION 4: SIP SECTION WORKING ----------
        });
    </script>

    <div class="page-header">
        <h3 class="page-title">SIP Master Reconciliation 2 </h3>
    </div>

    <div class="row">
        <div class="grid-margin stretch-card draggable-container">
            <div class="card">
                <div class="card-body">

                    <%-- TR SERACH --%>
                    <div>
                        <%-- TR SEARCH INPUT --%>
                        <div>
                            <h4 class="card-title text-danger">WealthMaker Transactions</h4>
                            <div class="row g-3">
                                <%-- 1:  side col: ch, reg, zn, br, rm, amc --%>
                                <div class="col-md-4">
                                    <div class="row g-3">

                                        <!-- CHANNEL -->
                                        <div class="col-md-6">
                                            <label for="ddlChannel" class="form-label">Channel</label>
                                            <select id="ddlChannel" class="form-select">
                                            </select>
                                        </div>

                                        <!-- REGION -->
                                        <div class="col-md-6">
                                            <label for="ddlRegion" class="form-label">Region</label>
                                            <select id="ddlRegion" class="form-select">
                                            </select>
                                        </div>

                                        <!-- ZONE -->
                                        <div class="col-md-6">
                                            <label for="ddlZone" class="form-label">Zone</label>
                                            <select id="ddlZone" class="form-select">
                                            </select>
                                        </div>

                                        <!-- BRANCH -->
                                        <div class="col-md-6">
                                            <label for="ddlBranch" class="form-label">Branch</label>
                                            <select id="ddlBranch" class="form-select">
                                            </select>
                                        </div>

                                        <!-- RM -->
                                        <div class="col-md-6">
                                            <label for="ddlRM" class="form-label">RM</label>
                                            <select id="ddlRM" class="form-select">
                                            </select>
                                        </div>

                                        <!-- AMC -->
                                        <div class="col-md-6">
                                            <label for="ddlAMC" class="form-label">AMC</label>
                                            <select id="ddlAMC" class="form-select">
                                            </select>
                                        </div>

                                    </div>
                                </div>

                                <%-- 2: DTF, DTT, REGI, TRAN TYPE --%>
                                <div class="col-md-4">
                                    <div class="row g-3">
                                        <!-- DATE FROM -->
                                        <div class="col-md-6">
                                            <label for="txtDateFrom" class="form-label">Date From</label>
                                            <input type="text" id="txtDateFrom" class="form-control" placeholder="dd/mm/yyyy" maxlength="10" />
                                        </div>

                                        <!-- DATE TO -->
                                        <div class="col-md-6">
                                            <label for="txtDateTo" class="form-label">Date To</label>
                                            <input type="text" id="txtDateTo" class="form-control" placeholder="dd/mm/yyyy" maxlength="10" />
                                        </div>

                                        <!-- REGISTRAR -->
                                        <div class="col-md-12">
                                            <label class="form-label">Registrar</label>
                                            <div class="d-flex align-items-center flex-wrap gap-3 ms-4">
                                                <div class="form-check me-3">
                                                    <input class="form-check-input" id="regC" type="radio" name="registrar" value="c">
                                                    <label class="form-check-label" for="regC">C</label>
                                                </div>
                                                <div class="form-check me-3">
                                                    <input class="form-check-input" id="regK" type="radio" name="registrar" value="k">
                                                    <label class="form-check-label" for="regK">K</label>

                                                </div>
                                                <div class="form-check me-3">
                                                    <input class="form-check-input" id="regCCOB" type="radio" name="registrar" value="ccob">
                                                    <label class="form-check-label" for="regCCOB">C COB</label>

                                                </div>
                                                <div class="form-check me-3">
                                                    <input class="form-check-input" id="regKCOB" type="radio" name="registrar" value="kcob">
                                                    <label class="form-check-label" for="regKCOB">K COB</label>

                                                </div>
                                            </div>
                                        </div>

                                        <!-- TRAN TYPE -->
                                        <div class="col-md-6">
                                            <label class="form-label">Tran Type</label>
                                            <div class="d-flex align-items-start flex-wrap gap-2 ms-4">
                                                <div class="form-check me-4">
                                                    <input class="form-check-input" type="radio" name="tranType" id="tranRegular" value="REGULAR" >
                                                    <label class="form-check-label" for="tranRegular">Regular</label>
                                                </div>

                                                <div class="form-check me-4">
                                                    <input class="form-check-input" type="radio" name="tranType" id="tranSIP" value="SIP" checked>
                                                    <label class="form-check-label" for="tranSIP">SIP</label>
                                                </div>

                                            </div>
                                        </div>
                                        <%-- PMS --%>
                                        <div class="col-md-3">

                                            <div class="form-check mt-5">
                                                <input type="checkbox" id="chkPMS" class="form-check-input" />
                                                <label for="chkPMS" class="form-check-label">PMS</label>
                                            </div>
                                        </div>

                                        <%-- COB --%>
                                        <div class="col-md-3">
                                            <div class="form-check mt-5">
                                                <input type="checkbox" id="chkTrCOB" class="form-check-input" />
                                                <label for="chkTrCOB" class="form-check-label">COB</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <%-- 3: RECOSTATUS, COB, COUNT   --%>
                                <div class="col-md-2 ps-2">
                                    <div class="row g-3 ms-2">
                                        <!-- RECONCILIATION -->
                                        <div class="col-md-12">
                                            <div class="">
                                                <div class="form-check me-3">
                                                    <input class="form-check-input" type="radio" id="rdbTrReconcile" name="reco" value="Y">
                                                    <label class="form-check-label" for="rdbTrReconcile">Reconcile</label>
                                                </div>
                                                <div class="form-check me-3">
                                                    <input class="form-check-input" type="radio" id="rdbTrUnreconcile" name="reco" value="N" checked>
                                                    <label class="form-check-label" for="rdbTrUnreconcile">Unreconcile</label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- OPT 1 & OPT 2 -->
                                        <div class="col-md-12">
                                            <div class="">
                                                <div class="form-check me-3">
                                                    <input class="form-check-input" type="radio" id="rdbOp1" name="rdbOp" value="1">
                                                    <label class="form-check-label" for="rdbOp1">OP1</label>
                                                </div>
                                                <div class="form-check me-3">
                                                    <input class="form-check-input" type="radio" id="rdbOp2" name="rdbOp" value="2" checked>
                                                    <label class="form-check-label" for="rdbOp2">OP2</label>
                                                </div>
                                            </div>
                                        </div>


                                        <%-- COUNT --%>
                                        <div class="col-md-12 ms-0">
                                            <p class="text-danger fw-bold mt-2">Count: <span id="lblTrCount">0</span></p>
                                        </div>
                                    </div>
                                </div>


                                <!-- 4: AR INPUT, BTN:GO, RESET, EXPORT, EXIT-->
                                <div class="col-md-2">
                                    <!-- AR NO -->
                                    <div class="col-md-12">
                                        <label for="txtARNo" class="form-label">AR No.</label>
                                        <input type="text" id="txtARNo" class="form-control" />
                                    </div>

                                    <!-- Buttons:FIND TR, RESET -->
                                    <div class="col-md-12 mt-2">
                                        <div class="d-flex align-items-center justify-content-end flex-wrap gap-3 mt-4">
                                            <button type="button" id="btnTrFind" style="width:70px;" class="btn btn-sm btn-primary">Go</button>
                                            <button type="button" id="btnTrReset" style="width:70px;" class="btn btn-sm btn-outline-primary">Reset</button>
                                            <button type="button" id="btnTrExport" style="width:70px;" class="btn btn-sm btn-outline-primary">Export</button>
                                            <button type="button" id="btnTrExit" style="width:70px;" class="btn btn-sm btn-outline-primary">Exit</button>

                                        </div>
                                    </div>

            
                                </div>
                            </div>
                        </div>


                        <br />
                        <%-- TR SEARCHED GRID --%>
                        <div>


                          
                            <div id="transactionContainer1" class="table table-bordered table-responsive" style="max-height: 250px; overflow-y: auto;">
                                                            <table id="transactionTable" class="table table-bordered">
    <thead>
        <tr>
            <th>TRAN_CODE</th>
            <th>TR_DATE</th>
            <th>INVESTOR_NAME</th>
            <th>ADDRESS</th>
            <th>CITY_NAME</th>
            <th>AMC_NAME</th>
            <th style="width:400px;">SCH_NAME</th>
            <th>AMOUNT</th>
            <th>FOLIO_NO</th>
            <th>CHEQUE_NO</th>
            <th>APP_NO</th>
            <th>RM_NAME</th>
            <th>BRANCH_NAME</th>
            <th>SIP_AMOUNT</th>
            <th>TOTAL_SIP</th>
            <th>STATUS</th>
            <th>FLAG</th>
            <th>REMARK</th>
            
            <!-- Hidden columns -->
            <th style="display:none">SIP_TYPE</th>
            <th style="display:none">TRAN_TYPE</th>
            <th style="display:none">BANK_NAME</th>
            <th style="display:none">PANNO</th>
            <th style="display:none">CHEQUE_DATE</th>
            <th style="display:none">BROKER_ID</th>
            <th style="display:none">REGISTRAR</th>
            <th style="display:none">SOURCE_CODE</th>
            <th style="display:none">DISPATCH</th>
            <th style="display:none">COB_FLAG</th>
            <th style="display:none">CLIENT_CODE</th>
            <th style="display:none">SCH_CODE</th>
            <th style="display:none">MUT_CODE</th>
            <th style="display:none">PAYMENT_MODE</th>
            <th style="display:none">LEAD_NO</th>
            <th style="display:none">LEAD_NAME</th>
            <th style="display:none">BRANCH_CODE</th>
            <th style="display:none">BUSINESS_RMCODE</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

                            </div>

                        </div>
                    </div>

                    <br />
                    <hr />
                    <%-- RTA  SEARCH--%>
                    <div>
                        <%-- RTA SEARCH INPUT  --%>
                        <div>
                            <h4 class="card-title text-danger">RTA Transactions</h4>
                            <div class="row g-3">
                                <!-- Left Section -->
                                <div class="col-md-4">
                                    <div class="row g-3">
                                        <!-- FROM DATE -->
                                        <div class="col-md-6">
                                            <label for="txtRtaDateFrom" class="form-label">Date From <span class="text-danger">*</span></label>
                                            <input type="text" id="txtRtaDateFrom" class="form-control date-input" placeholder="dd/mm/yyyy" />
                                        </div>

                                        <!-- TO DATE -->
                                        <div class="col-md-6">
                                            <label for="txtRtaDateTo" class="form-label">Date To <span class="text-danger">*</span></label>
                                            <input type="text" id="txtRtaDateTo" class="form-control date-input" placeholder="dd/mm/yyyy" />
                                        </div>

                                        <!-- AMC -->
                                        <div class="col-md-6">
                                            <label for="ddlRtaAMC" class="form-label">AMC</label>
                                            <select id="ddlRtaAMC" class="form-select">
                                            </select>
                                        </div>

                                        <!-- BRANCH -->
                                        <div class="col-md-6">
                                            <label for="ddlRtaBranch" class="form-label">Branch</label>
                                            <select id="ddlRtaBranch" class="form-select">
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Middle Section -->
                                <div class="col-md-4">
                                    <div class="row g-3">

                                        <!-- SEARCH DROPDOWN -->
                                        <div class="col-md-6">
                                            <label for="ddlRtaCheque" class="form-label">Search</label>

                                            <span class="ctm_hidden" id="hdnTrCode"></span>
                                            <span class="ctm_hidden" id="hdnTrAmount"></span>
                                            <span class="ctm_hidden" id="hdnTrChe"></span>
                                            <span class="ctm_hidden" id="hdnTrFolio"></span>
                                            <span class="ctm_hidden" id="hdnTrApp"></span>
                                            <span class="ctm_hidden" id="hdnTrPan"></span>
                                            <span class="ctm_hidden" id="hdnTrBroker"></span>
                                            <span class="ctm_hidden" id="hdnTrDispatch"></span>
                                            <span class="ctm_hidden" id="hdnRtaCode"></span>
                                            <span class="ctm_hidden" id="hdnRtaDate"></span>
                                            <span class="ctm_hidden" id="hdnRtaFolio"></span>
                                            <span class="ctm_hidden" id="hdnRtaAmount"></span>
                                            <span class="ctm_hidden" id="hdnRtaRemark"></span>
                                            <select id="ddlRtaCheque" class="form-select" onchange="ddlChequeChanged()">
                                                <option value=""></option>
                                                <option value="001">CHEQUE_NO</option>
                                                <option value="002">FOLIO_NO</option>
                                                <option value="003">APP_NO</option>
                                                <option value="004">PANNO</option>
                                                <option value="005">BROKER_ID</option>
                                            </select>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="txtRtaChequeNo" class="form-label">&nbsp;</label>
                                            <input type="text" id="txtRtaChequeNo" class="form-control" placeholder="Input type text">
                                        </div>

                                        <!-- INVESTOR NAME -->
                                        <div class="col-md-7">
                                            <label for="txtRtaInvestorName" class="form-label">Investor Name</label>
                                            <input type="text" id="txtRtaInvestorName" class="form-control" />
                                        </div>

                                        <!-- AMOUNT -->
                                        <div class="col-md-5">
                                            <label for="txtRtaAmount" class="form-label">Amount</label>
                                            <input type="text" id="txtRtaAmount" class="form-control" />
                                        </div>

                                        <!-- ACTION BUTTONS: Rta search, reset export 
                                        <div class="d-flex align-items-center justify-content-end flex-wrap gap-3 my-3">
                                           
                                        </div>
                                            -->
                                    </div>
                                </div>

                                <!-- Right Section -->
                                <div class="col-md-4">

                                    <div class="row g-3">


                                        <!-- REMARKS -->
                                        <div class="col-md-12 mb-0">
                                            <label for="txtRtaRemarks" class="form-label">Remarks</label>
                                            <div class="input-group">
                                                <input type="text" id="txtRtaRemarks" class="form-control" />
                                                <button type="button" id="btnRtaSaveRemark" class="btn btn-outline-primary">Save</button>
                                            </div>
                                        </div>


                                        <div class="col-md-6 mt-2 mb-0">
                                            <%--<label class="form-label">Status</label>--%>
                                            <div class="d-flex align-items-center  justify-content-between flex-wrap gap-3 ms-4">

                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="rtaRecoStatus" id="rtaReconcile" value="Y">
                                                    <label class="form-check-label" for="rtaReconcile">Reconciled</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="rtaRecoStatus" id="rtaUnreconcile" value="N" checked>
                                                    <label class="form-check-label" for="rtaUnreconcile">Unreconciled</label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- TRAN TYPE -->
                                        <div class="col-md-6 mt-2 mb-0 align-items-end">
                                            <%--<label class="form-label">Tran Type</label>--%>
                                            <div class="d-flex align-items-center  justify-content-between flex-wrap gap-3 ms-4">

                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="rtaTranType" id="rtaTranTypeRegular" value="REGULAR">
                                                    <label class="form-check-label" for="rtaTranTypeRegular">Regular</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="rtaTranType" id="rtaTranTYpeSip" value="SIP" checked>
                                                    <label class="form-check-label" for="rtaTranTYpeSip">SIP</label>
                                                </div>
                                            </div>
                                        </div>


                                        <div class="col-md-12 mt-0">

                                            <!-- CONFIRMATION BUTTONS -->
                                            <div class="d-flex align-items-center justify-content-end flex-wrap gap-3">
                                                <button type="button" id="btnRtaFind" class="btn btn-sm btn-primary">Search</button>
                                                <button type="button" id="btnRtaReset" class="btn btn-sm btn-outline-primary">Reset</button>
                                                <button type="button" id="btnRtaExport" class="btn btn-sm btn-outline-primary">Export</button>
                                                <button type="button" id="btnRtaConfPMS" class="btn btn-sm btn-outline-primary" >Confirm PMS</button>
                                                <button type="button" id="btnRtaUncomfPMS" class="btn btn-sm btn-outline-primary" ">Unconfirm PMS</button>
                                                <button type="button" id="btnRtaReconsile" class="btn btn-sm btn-primary">Base SIP Reconcile</button>
                                            </div>
                                        </div>


                                    </div>

                                </div>
                            </div>
                        </div>

                        <br />
                        <%-- RTA GRID TABLE --%>
                        <div>

                            <div class="table-responsive" id="transactionContainer2" style="max-height: 250px; overflow-y: auto;">
                                <table id="rtaGrid" class="table table-bordered">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>TRAN_CODE</th>
                                            <th>TRAN_DATE</th>
                                            <th>INVESTOR_NAME</th>
                                            <th>ADDRESS</th>
                                            <th>CITY_NAME</th>
                                            <th>AMC_NAME</th>
                                            <th style="width: 400px;">SCHEME_NAME</th>
                                            <th>AMOUNT</th>
                                            <th>FOLIO_NO</th>
                                            <th>CHEQUE_NO</th>
                                            <th>APP_NO</th>
                                            <th>RM_NAME</th>
                                            <th>BRANCH_NAME</th>
                                            <th>BROKER_CODE</th>
                                            <th>REG_TRAN_TYPE</th>
                                            <th>UNQ_KEY</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>

                    <hr />
                    <br />

                    <%-- SIP SEARCH--%>
                    <div>
                        <%-- SIP SEARCH INPUT  --%>
                        <div>
                            <h4 class="card-title text-danger">SIP Transactions</h4>

                            <div class="row g-3">
                                <!-- Left Section -->
                                <div class="col-md-10">
                                    <div class="row g-3">
                                        <!-- SIP FOLIO NO -->
                                        <div class="col-md-2">
                                            <label for="txtSIPFolioNo" class="form-label">SIP Folio No</label>
                                            <input type="text" id="txtSIPFolioNo" class="form-control" placeholder="" />
                                        </div>

                                        <!-- SIP AMOUNT -->
                                        <div class="col-md-2">
                                            <label for="txtSIPAmount" class="form-label">SIP Amount</label>
                                            <input type="text" id="txtSIPAmount" class="form-control" placeholder="" />
                                        </div>

                                        <!-- SIP PAN -->
                                        <div class="col-md-2">
                                            <label for="txtSIPPan" class="form-label">SIP PAN</label>
                                            <input type="text" id="txtSIPPan" class="form-control" placeholder="" />
                                        </div>

                                        <!-- SIP CLIENT CODE -->
                                        <div class="col-md-2">
                                            <label for="txtSIPClientCode" class="form-label">SIP Client Code</label>
                                            <input type="text" id="txtSIPClientCode" class="form-control" placeholder="" />
                                        </div>
                                        <!-- SIP DATE -->
                                        <div class="col-md-2">
                                            <label for="txtSIPDate" class="form-label">SIP Date</label>
                                            <input type="text" id="txtSIPDate" class="form-control date-input" placeholder="" />
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Section -->
                                <div class="col-md-2">
                                    <div class="row g-3 mt-3">

                                        <!-- ACTION BUTTONS: SIP search, reset -->
                                        <div class="d-flex align-items-center justify-content-end flex-wrap gap-3 my-3">
                                            <button type="button" id="btnSipFind" class="btn btn-sm btn-primary">Search</button>
                                            <button type="button" id="btnSipReset" class="btn btn-sm btn-outline-primary" >Reset</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <br />
                        <%-- SIP GRID TABLE --%>
                        <div>
                            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                <table id="sipGrid" class="table table-bordered">
                                    <thead class="thead-dark">
                                        <tr>
    <th>SEQ_NO</th>
    <th>AMC_NAME</th>
    <th style="width: 400px;">SCHEME_NAME</th>
    <th>AMOUNT_SIP</th>
    <th>FOLIO_NO</th>
    <th>TRXN_NO</th>
    <th>SIP_START_DATE</th>
    <th>SIP_END_DATE</th>
    <th>SIP_REG_DATE</th>
    <th>SIP_OPTION</th>
    <th>TOTAL_SIP</th>
    <th>RM_NAME</th>
    <th>BRANCH_NAME</th>
    <th style="display:none">BRANCH_CODE</th>
    <th style="display:none">PAYROLL_ID</th>
    <th style="display:none">SCH_CODE</th>
    <th style="display:none">MUT_CODE</th>
</tr>

                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <hr />
                    <br />
                    <!-- TRAN CODE -->
                    <div>
                        <%--  TRAN SERACH INPUT --%>
                        <div>
                            <h5 class="card-title text-danger">Tran Code</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <input type="text" id="txtTranTranCode" class="form-control" placeholder="Enter Tran Code" />
                                        <button type="button" id="btnTranFind" class="btn btn-outline-primary">Find</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br />
                        <%--  TRAN SERACH TABLE --%>
                        <div>
                            <div class="table-responsive">
                                <table id="tranCodeGrid" class="table table-bordered table-striped">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>TRAN_CODE</th>
                                            <th>BRANCH_NAME</th>
                                            <th>AMOUNT</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <asp:HiddenField ID="hdnLoginId" runat="server" />
        <asp:HiddenField ID="hdnRoleId" runat="server"/>
    </div>



</asp:Content>


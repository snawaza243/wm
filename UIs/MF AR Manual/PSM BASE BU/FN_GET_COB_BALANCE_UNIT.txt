CREATE OR REPLACE FUNCTION WEALTHMAKER.FN_GET_COB_BALANCE_UNIT(PFOLIO_NO VARCHAR2,PSCH_CODE VARCHAR2) RETURN NUMBER IS
VBAL_UNIT    NUMBER(20,3);
BEGIN
    BEGIN
        SELECT SUM(CASE WHEN TRAN_TYPE IN ('PURCHASE','SWITCH IN','REINVESTMENT') THEN UNITS WHEN TRAN_TYPE IN ('REDEMPTION','SWITCH OUT') THEN -UNITS ELSE 0 END)
        BAL_UNITS INTO VBAL_UNIT FROM WEALTHMAKER.TRANSACTION_ST ST WHERE   DUP_FLAG2=0 
        AND FOLIO_NO=PFOLIO_NO AND SCH_CODE=PSCH_CODE
        GROUP BY FOLIO_NO,SCH_CODE,CLIENT_CODE HAVING SUM(CASE WHEN TRAN_TYPE IN ('PURCHASE','SWITCH IN','REINVESTMENT') THEN UNITS ELSE -UNITS END)>-1;
    EXCEPTION WHEN OTHERS THEN
        VBAL_UNIT:=0;
    END;    
    
    RETURN VBAL_UNIT;
END;
/